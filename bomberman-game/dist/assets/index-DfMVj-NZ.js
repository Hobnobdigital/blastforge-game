import{B as Y,V as D,G as R,M as S,a as Ve,D as K,S as L,b as w,T as pe,c as B,d as ue,C as oe,e as re,P as He,O as ge,A as N,f as Ae,g as le,R as ze,I as F,h as ie,i as Ze,j as ce,k as Ne,l as $e,m as Ue,n as We,o as be,p as Qe,q as Je,r as Z,s as te,t as et,L as ye,u as ve,v as se,F as tt,w as st,x as ot,y as Te,E as ke,z as Ye,H as it,J as nt,K as at,W as rt,N as lt,Q as ct,U as ut}from"./three-D5usQ-_h.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))o(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const c of a.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&o(c)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function o(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();const v=13,Q=1,je=60,ne=1/je;var P=(l=>(l[l.Floor=0]="Floor",l[l.HardBlock=1]="HardBlock",l[l.SoftBlock=2]="SoftBlock",l))(P||{}),x=(l=>(l[l.None=0]="None",l[l.Up=1]="Up",l[l.Down=2]="Down",l[l.Left=3]="Left",l[l.Right=4]="Right",l))(x||{}),z=(l=>(l.BombRange="bomb_range",l.BombCount="bomb_count",l.Speed="speed",l.FuseCharge="fuse_charge",l))(z||{}),I=(l=>(l.MENU="menu",l.PLAYING="playing",l.PAUSED="paused",l.VICTORY="victory",l.DEFEAT="defeat",l.LEVEL_TRANSITION="level_transition",l))(I||{}),C=(l=>(l.MAIN="main",l.SETTINGS="settings",l.HOW_TO_PLAY="how_to_play",l.STATS="stats",l.LEVEL_SELECT="level_select",l))(C||{}),_=(l=>(l.CLASSIC="classic",l.ICE="ice",l.VOLCANO="volcano",l.FOREST="forest",l.DESERT="desert",l.SPACE="space",l.MIAMI_BEACH="miami_beach",l))(_||{});const H=[{id:1,name:"Training Grounds",theme:"classic",description:"Learn the basics",softBlockDensity:.4,enemyCount:1},{id:2,name:"Ice Caverns",theme:"ice",description:"Slippery surfaces",softBlockDensity:.45,enemyCount:3},{id:3,name:"Volcano Core",theme:"volcano",description:"Watch your step",softBlockDensity:.5,enemyCount:4},{id:4,name:"Enchanted Forest",theme:"forest",description:"Nature's maze",softBlockDensity:.55,enemyCount:5},{id:5,name:"Desert Ruins",theme:"desert",description:"Ancient dangers",softBlockDensity:.5,enemyCount:6},{id:6,name:"Space Station",theme:"space",description:"Zero gravity chaos",softBlockDensity:.6,enemyCount:7},{id:7,name:"Miami Beach",theme:"miami_beach",description:"Sunset vibes and neon lights",softBlockDensity:.5,enemyCount:6}],Pe={musicVolume:.7,sfxVolume:1,uiVolume:.8,fullscreen:!1,showFPS:!0,vibration:!0},he={totalWins:0,totalLosses:0,totalPlayTime:0,levelsCompleted:[],bestTimes:{},bombsPlaced:0,powerUpsCollected:0,enemiesDefeated:0,gamesStarted:0};var k=(l=>(l.BASIC="basic",l.FAST="fast",l.SMART="smart",l.TANK="tank",l))(k||{});const Ee="blastforge_settings",Ie="blastforge_stats";class ht{settings;stats;constructor(){this.settings=this.loadSettings(),this.stats=this.loadStats()}loadSettings(){try{const t=localStorage.getItem(Ee);if(t){const e=JSON.parse(t);return{...Pe,...e}}}catch(t){console.warn("Failed to load settings:",t)}return{...Pe}}saveSettings(){try{localStorage.setItem(Ee,JSON.stringify(this.settings))}catch(t){console.warn("Failed to save settings:",t)}}getSettings(){return{...this.settings}}updateSettings(t){this.settings={...this.settings,...t},this.saveSettings()}setMusicVolume(t){this.settings.musicVolume=Math.max(0,Math.min(1,t)),this.saveSettings()}setSfxVolume(t){this.settings.sfxVolume=Math.max(0,Math.min(1,t)),this.saveSettings()}setUiVolume(t){this.settings.uiVolume=Math.max(0,Math.min(1,t)),this.saveSettings()}setFullscreen(t){this.settings.fullscreen=t,this.saveSettings(),t?document.documentElement.requestFullscreen?.().catch(()=>{}):document.exitFullscreen?.().catch(()=>{})}setShowFPS(t){this.settings.showFPS=t,this.saveSettings()}setVibration(t){this.settings.vibration=t,this.saveSettings()}loadStats(){try{const t=localStorage.getItem(Ie);if(t){const e=JSON.parse(t);return{...he,...e}}}catch(t){console.warn("Failed to load stats:",t)}return{...he}}saveStats(){try{localStorage.setItem(Ie,JSON.stringify(this.stats))}catch(t){console.warn("Failed to save stats:",t)}}getStats(){return{...this.stats}}recordWin(t,e){this.stats.totalWins++,this.stats.levelsCompleted.includes(t)||this.stats.levelsCompleted.push(t);const o=this.stats.bestTimes[t];(!o||e<o)&&(this.stats.bestTimes[t]=e),this.saveStats()}recordLoss(){this.stats.totalLosses++,this.saveStats()}addPlayTime(t){this.stats.totalPlayTime+=t,this.saveStats()}incrementBombsPlaced(){this.stats.bombsPlaced++,this.saveStats()}incrementPowerUpsCollected(){this.stats.powerUpsCollected++,this.saveStats()}incrementEnemiesDefeated(){this.stats.enemiesDefeated++,this.saveStats()}incrementGamesStarted(){this.stats.gamesStarted++,this.saveStats()}resetStats(){this.stats={...he},this.saveStats()}vibrate(t){this.settings.vibration&&navigator.vibrate&&navigator.vibrate(t)}}const T=new ht;function qe(){const l=dt(),t=[mt(0,{col:1,row:1})];return{tick:0,grid:l,players:t,bombs:[],explosions:[],powerUps:[]}}function dt(){const l=[];for(let e=0;e<v;e++){l[e]=[];for(let o=0;o<v;o++)e===0||e===v-1||o===0||o===v-1||e%2===0&&o%2===0?l[e][o]=P.HardBlock:l[e][o]=P.Floor}const t=new Set(["1,1","1,2","2,1",`${v-2},${v-2}`,`${v-2},${v-3}`,`${v-3},${v-2}`,`1,${v-2}`,`1,${v-3}`,`2,${v-2}`,`${v-2},1`,`${v-3},1`,`${v-2},2`]);for(let e=1;e<v-1;e++)for(let o=1;o<v-1;o++)l[e][o]===P.Floor&&!t.has(`${o},${e}`)&&Math.random()<.4&&(l[e][o]=P.SoftBlock);return l}function mt(l,t){return{id:l,gridPos:{...t},worldPos:{x:t.col,y:t.row},moveDir:x.None,speed:3.5,bombRange:2,maxBombs:1,activeBombs:0,fuseCharges:3,alive:!0}}class ft{currentLevelIndex=0;getCurrentLevel(){return H[this.currentLevelIndex]??H[0]}getAllLevels(){return[...H]}setLevel(t){this.currentLevelIndex=Math.max(0,Math.min(H.length-1,t))}canProgressToLevel(t,e){return!0}getNextLevel(){return H[this.currentLevelIndex+1]??null}progressToNext(){return this.currentLevelIndex<H.length-1?(this.currentLevelIndex++,!0):!1}createLevelState(t){const e=qe();return this.applyLevelTheme(e,t),this.spawnEnemies(e,t),e}applyLevelTheme(t,e){const o=new Set(["1,1","1,2","2,1",`${v-2},${v-2}`,`${v-2},${v-3}`,`${v-3},${v-2}`,`1,${v-2}`,`1,${v-3}`,`2,${v-2}`,`${v-2},1`,`${v-3},1`,`${v-2},2`]);for(let i=1;i<v-1;i++)for(let a=1;a<v-1;a++)t.grid[i][a]===P.SoftBlock&&(t.grid[i][a]=P.Floor),t.grid[i][a]===P.Floor&&!o.has(`${a},${i}`)&&Math.random()<e.softBlockDensity&&(t.grid[i][a]=P.SoftBlock);switch(e.theme){case _.ICE:break;case _.VOLCANO:break;case _.FOREST:break;case _.MIAMI_BEACH:break}}spawnEnemies(t,e){const o=[{col:v-2,row:v-2},{col:1,row:v-2},{col:v-2,row:1},{col:7,row:7},{col:8,row:8},{col:7,row:8}];for(let i=0;i<e.enemyCount&&i<o.length;i++){const a=o[i];t.grid[a.row][a.col]=P.Floor;const c=pt(i,a.col,a.row,this.getEnemyTypeForLevel(e.id));t.enemies=t.enemies||[],t.enemies.push(c)}}getEnemyTypeForLevel(t){return t>=5?k.SMART:t>=3?k.FAST:k.BASIC}getThemeColors(t){switch(t){case _.ICE:return{background:662058,floor:2771562,accent:8965375};case _.VOLCANO:return{background:1706506,floor:4860458,accent:16737860};case _.FOREST:return{background:662026,floor:2771498,accent:6750088};case _.DESERT:return{background:1710602,floor:6969914,accent:16764006};case _.SPACE:return{background:328976,floor:2763338,accent:11176191};case _.MIAMI_BEACH:return{background:16739229,floor:15255951,accent:4251856};case _.CLASSIC:default:return{background:657930,floor:2763306,accent:43775}}}}function pt(l,t,e,o){const i={[k.BASIC]:2,[k.FAST]:3.5,[k.SMART]:2.5,[k.TANK]:1.5};return{id:l,gridPos:{col:t,row:e},worldPos:{x:t,y:e},moveDir:x.None,speed:i[o],alive:!0,type:o,aiState:"wander"}}const q=new ft;var J=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},de={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var Ce;function gt(){return Ce||(Ce=1,(function(l){(function(){var t=function(){this.init()};t.prototype={init:function(){var s=this||e;return s._counter=1e3,s._html5AudioPool=[],s.html5PoolSize=10,s._codecs={},s._howls=[],s._muted=!1,s._volume=1,s._canPlayEvent="canplaythrough",s._navigator=typeof window<"u"&&window.navigator?window.navigator:null,s.masterGain=null,s.noAudio=!1,s.usingWebAudio=!0,s.autoSuspend=!0,s.ctx=null,s.autoUnlock=!0,s._setup(),s},volume:function(s){var n=this||e;if(s=parseFloat(s),n.ctx||y(),typeof s<"u"&&s>=0&&s<=1){if(n._volume=s,n._muted)return n;n.usingWebAudio&&n.masterGain.gain.setValueAtTime(s,e.ctx.currentTime);for(var r=0;r<n._howls.length;r++)if(!n._howls[r]._webAudio)for(var u=n._howls[r]._getSoundIds(),p=0;p<u.length;p++){var g=n._howls[r]._soundById(u[p]);g&&g._node&&(g._node.volume=g._volume*s)}return n}return n._volume},mute:function(s){var n=this||e;n.ctx||y(),n._muted=s,n.usingWebAudio&&n.masterGain.gain.setValueAtTime(s?0:n._volume,e.ctx.currentTime);for(var r=0;r<n._howls.length;r++)if(!n._howls[r]._webAudio)for(var u=n._howls[r]._getSoundIds(),p=0;p<u.length;p++){var g=n._howls[r]._soundById(u[p]);g&&g._node&&(g._node.muted=s?!0:g._muted)}return n},stop:function(){for(var s=this||e,n=0;n<s._howls.length;n++)s._howls[n].stop();return s},unload:function(){for(var s=this||e,n=s._howls.length-1;n>=0;n--)s._howls[n].unload();return s.usingWebAudio&&s.ctx&&typeof s.ctx.close<"u"&&(s.ctx.close(),s.ctx=null,y()),s},codecs:function(s){return(this||e)._codecs[s.replace(/^x-/,"")]},_setup:function(){var s=this||e;if(s.state=s.ctx&&s.ctx.state||"suspended",s._autoSuspend(),!s.usingWebAudio)if(typeof Audio<"u")try{var n=new Audio;typeof n.oncanplaythrough>"u"&&(s._canPlayEvent="canplay")}catch{s.noAudio=!0}else s.noAudio=!0;try{var n=new Audio;n.muted&&(s.noAudio=!0)}catch{}return s.noAudio||s._setupCodecs(),s},_setupCodecs:function(){var s=this||e,n=null;try{n=typeof Audio<"u"?new Audio:null}catch{return s}if(!n||typeof n.canPlayType!="function")return s;var r=n.canPlayType("audio/mpeg;").replace(/^no$/,""),u=s._navigator?s._navigator.userAgent:"",p=u.match(/OPR\/(\d+)/g),g=p&&parseInt(p[0].split("/")[1],10)<33,m=u.indexOf("Safari")!==-1&&u.indexOf("Chrome")===-1,b=u.match(/Version\/(.*?) /),M=m&&b&&parseInt(b[1],10)<15;return s._codecs={mp3:!!(!g&&(r||n.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!r,opus:!!n.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(n.canPlayType('audio/wav; codecs="1"')||n.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!n.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!n.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(n.canPlayType("audio/x-m4a;")||n.canPlayType("audio/m4a;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(n.canPlayType("audio/x-m4b;")||n.canPlayType("audio/m4b;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(n.canPlayType("audio/x-mp4;")||n.canPlayType("audio/mp4;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!M&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!M&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!n.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(n.canPlayType("audio/x-flac;")||n.canPlayType("audio/flac;")).replace(/^no$/,"")},s},_unlockAudio:function(){var s=this||e;if(!(s._audioUnlocked||!s.ctx)){s._audioUnlocked=!1,s.autoUnlock=!1,!s._mobileUnloaded&&s.ctx.sampleRate!==44100&&(s._mobileUnloaded=!0,s.unload()),s._scratchBuffer=s.ctx.createBuffer(1,1,22050);var n=function(r){for(;s._html5AudioPool.length<s.html5PoolSize;)try{var u=new Audio;u._unlocked=!0,s._releaseHtml5Audio(u)}catch{s.noAudio=!0;break}for(var p=0;p<s._howls.length;p++)if(!s._howls[p]._webAudio)for(var g=s._howls[p]._getSoundIds(),m=0;m<g.length;m++){var b=s._howls[p]._soundById(g[m]);b&&b._node&&!b._node._unlocked&&(b._node._unlocked=!0,b._node.load())}s._autoResume();var M=s.ctx.createBufferSource();M.buffer=s._scratchBuffer,M.connect(s.ctx.destination),typeof M.start>"u"?M.noteOn(0):M.start(0),typeof s.ctx.resume=="function"&&s.ctx.resume(),M.onended=function(){M.disconnect(0),s._audioUnlocked=!0,document.removeEventListener("touchstart",n,!0),document.removeEventListener("touchend",n,!0),document.removeEventListener("click",n,!0),document.removeEventListener("keydown",n,!0);for(var E=0;E<s._howls.length;E++)s._howls[E]._emit("unlock")}};return document.addEventListener("touchstart",n,!0),document.addEventListener("touchend",n,!0),document.addEventListener("click",n,!0),document.addEventListener("keydown",n,!0),s}},_obtainHtml5Audio:function(){var s=this||e;if(s._html5AudioPool.length)return s._html5AudioPool.pop();var n=new Audio().play();return n&&typeof Promise<"u"&&(n instanceof Promise||typeof n.then=="function")&&n.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(s){var n=this||e;return s._unlocked&&n._html5AudioPool.push(s),n},_autoSuspend:function(){var s=this;if(!(!s.autoSuspend||!s.ctx||typeof s.ctx.suspend>"u"||!e.usingWebAudio)){for(var n=0;n<s._howls.length;n++)if(s._howls[n]._webAudio){for(var r=0;r<s._howls[n]._sounds.length;r++)if(!s._howls[n]._sounds[r]._paused)return s}return s._suspendTimer&&clearTimeout(s._suspendTimer),s._suspendTimer=setTimeout(function(){if(s.autoSuspend){s._suspendTimer=null,s.state="suspending";var u=function(){s.state="suspended",s._resumeAfterSuspend&&(delete s._resumeAfterSuspend,s._autoResume())};s.ctx.suspend().then(u,u)}},3e4),s}},_autoResume:function(){var s=this;if(!(!s.ctx||typeof s.ctx.resume>"u"||!e.usingWebAudio))return s.state==="running"&&s.ctx.state!=="interrupted"&&s._suspendTimer?(clearTimeout(s._suspendTimer),s._suspendTimer=null):s.state==="suspended"||s.state==="running"&&s.ctx.state==="interrupted"?(s.ctx.resume().then(function(){s.state="running";for(var n=0;n<s._howls.length;n++)s._howls[n]._emit("resume")}),s._suspendTimer&&(clearTimeout(s._suspendTimer),s._suspendTimer=null)):s.state==="suspending"&&(s._resumeAfterSuspend=!0),s}};var e=new t,o=function(s){var n=this;if(!s.src||s.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}n.init(s)};o.prototype={init:function(s){var n=this;return e.ctx||y(),n._autoplay=s.autoplay||!1,n._format=typeof s.format!="string"?s.format:[s.format],n._html5=s.html5||!1,n._muted=s.mute||!1,n._loop=s.loop||!1,n._pool=s.pool||5,n._preload=typeof s.preload=="boolean"||s.preload==="metadata"?s.preload:!0,n._rate=s.rate||1,n._sprite=s.sprite||{},n._src=typeof s.src!="string"?s.src:[s.src],n._volume=s.volume!==void 0?s.volume:1,n._xhr={method:s.xhr&&s.xhr.method?s.xhr.method:"GET",headers:s.xhr&&s.xhr.headers?s.xhr.headers:null,withCredentials:s.xhr&&s.xhr.withCredentials?s.xhr.withCredentials:!1},n._duration=0,n._state="unloaded",n._sounds=[],n._endTimers={},n._queue=[],n._playLock=!1,n._onend=s.onend?[{fn:s.onend}]:[],n._onfade=s.onfade?[{fn:s.onfade}]:[],n._onload=s.onload?[{fn:s.onload}]:[],n._onloaderror=s.onloaderror?[{fn:s.onloaderror}]:[],n._onplayerror=s.onplayerror?[{fn:s.onplayerror}]:[],n._onpause=s.onpause?[{fn:s.onpause}]:[],n._onplay=s.onplay?[{fn:s.onplay}]:[],n._onstop=s.onstop?[{fn:s.onstop}]:[],n._onmute=s.onmute?[{fn:s.onmute}]:[],n._onvolume=s.onvolume?[{fn:s.onvolume}]:[],n._onrate=s.onrate?[{fn:s.onrate}]:[],n._onseek=s.onseek?[{fn:s.onseek}]:[],n._onunlock=s.onunlock?[{fn:s.onunlock}]:[],n._onresume=[],n._webAudio=e.usingWebAudio&&!n._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(n),n._autoplay&&n._queue.push({event:"play",action:function(){n.play()}}),n._preload&&n._preload!=="none"&&n.load(),n},load:function(){var s=this,n=null;if(e.noAudio){s._emit("loaderror",null,"No audio support.");return}typeof s._src=="string"&&(s._src=[s._src]);for(var r=0;r<s._src.length;r++){var u,p;if(s._format&&s._format[r])u=s._format[r];else{if(p=s._src[r],typeof p!="string"){s._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}u=/^data:audio\/([^;,]+);/i.exec(p),u||(u=/\.([^.]+)$/.exec(p.split("?",1)[0])),u&&(u=u[1].toLowerCase())}if(u||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),u&&e.codecs(u)){n=s._src[r];break}}if(!n){s._emit("loaderror",null,"No codec support for selected audio sources.");return}return s._src=n,s._state="loading",window.location.protocol==="https:"&&n.slice(0,5)==="http:"&&(s._html5=!0,s._webAudio=!1),new i(s),s._webAudio&&c(s),s},play:function(s,n){var r=this,u=null;if(typeof s=="number")u=s,s=null;else{if(typeof s=="string"&&r._state==="loaded"&&!r._sprite[s])return null;if(typeof s>"u"&&(s="__default",!r._playLock)){for(var p=0,g=0;g<r._sounds.length;g++)r._sounds[g]._paused&&!r._sounds[g]._ended&&(p++,u=r._sounds[g]._id);p===1?s=null:u=null}}var m=u?r._soundById(u):r._inactiveSound();if(!m)return null;if(u&&!s&&(s=m._sprite||"__default"),r._state!=="loaded"){m._sprite=s,m._ended=!1;var b=m._id;return r._queue.push({event:"play",action:function(){r.play(b)}}),b}if(u&&!m._paused)return n||r._loadQueue("play"),m._id;r._webAudio&&e._autoResume();var M=Math.max(0,m._seek>0?m._seek:r._sprite[s][0]/1e3),E=Math.max(0,(r._sprite[s][0]+r._sprite[s][1])/1e3-M),G=E*1e3/Math.abs(m._rate),V=r._sprite[s][0]/1e3,$=(r._sprite[s][0]+r._sprite[s][1])/1e3;m._sprite=s,m._ended=!1;var U=function(){m._paused=!1,m._seek=M,m._start=V,m._stop=$,m._loop=!!(m._loop||r._sprite[s][2])};if(M>=$){r._ended(m);return}var A=m._node;if(r._webAudio){var Me=function(){r._playLock=!1,U(),r._refreshBuffer(m);var j=m._muted||r._muted?0:m._volume;A.gain.setValueAtTime(j,e.ctx.currentTime),m._playStart=e.ctx.currentTime,typeof A.bufferSource.start>"u"?m._loop?A.bufferSource.noteGrainOn(0,M,86400):A.bufferSource.noteGrainOn(0,M,E):m._loop?A.bufferSource.start(0,M,86400):A.bufferSource.start(0,M,E),G!==1/0&&(r._endTimers[m._id]=setTimeout(r._ended.bind(r,m),G)),n||setTimeout(function(){r._emit("play",m._id),r._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?Me():(r._playLock=!0,r.once("resume",Me),r._clearTimer(m._id))}else{var Se=function(){A.currentTime=M,A.muted=m._muted||r._muted||e._muted||A.muted,A.volume=m._volume*e.volume(),A.playbackRate=m._rate;try{var j=A.play();if(j&&typeof Promise<"u"&&(j instanceof Promise||typeof j.then=="function")?(r._playLock=!0,U(),j.then(function(){r._playLock=!1,A._unlocked=!0,n?r._loadQueue():r._emit("play",m._id)}).catch(function(){r._playLock=!1,r._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),m._ended=!0,m._paused=!0})):n||(r._playLock=!1,U(),r._emit("play",m._id)),A.playbackRate=m._rate,A.paused){r._emit("playerror",m._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}s!=="__default"||m._loop?r._endTimers[m._id]=setTimeout(r._ended.bind(r,m),G):(r._endTimers[m._id]=function(){r._ended(m),A.removeEventListener("ended",r._endTimers[m._id],!1)},A.addEventListener("ended",r._endTimers[m._id],!1))}catch(Ke){r._emit("playerror",m._id,Ke)}};A.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(A.src=r._src,A.load());var Xe=window&&window.ejecta||!A.readyState&&e._navigator.isCocoonJS;if(A.readyState>=3||Xe)Se();else{r._playLock=!0,r._state="loading";var xe=function(){r._state="loaded",Se(),A.removeEventListener(e._canPlayEvent,xe,!1)};A.addEventListener(e._canPlayEvent,xe,!1),r._clearTimer(m._id)}}return m._id},pause:function(s){var n=this;if(n._state!=="loaded"||n._playLock)return n._queue.push({event:"pause",action:function(){n.pause(s)}}),n;for(var r=n._getSoundIds(s),u=0;u<r.length;u++){n._clearTimer(r[u]);var p=n._soundById(r[u]);if(p&&!p._paused&&(p._seek=n.seek(r[u]),p._rateSeek=0,p._paused=!0,n._stopFade(r[u]),p._node))if(n._webAudio){if(!p._node.bufferSource)continue;typeof p._node.bufferSource.stop>"u"?p._node.bufferSource.noteOff(0):p._node.bufferSource.stop(0),n._cleanBuffer(p._node)}else(!isNaN(p._node.duration)||p._node.duration===1/0)&&p._node.pause();arguments[1]||n._emit("pause",p?p._id:null)}return n},stop:function(s,n){var r=this;if(r._state!=="loaded"||r._playLock)return r._queue.push({event:"stop",action:function(){r.stop(s)}}),r;for(var u=r._getSoundIds(s),p=0;p<u.length;p++){r._clearTimer(u[p]);var g=r._soundById(u[p]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,r._stopFade(u[p]),g._node&&(r._webAudio?g._node.bufferSource&&(typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),r._cleanBuffer(g._node)):(!isNaN(g._node.duration)||g._node.duration===1/0)&&(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&r._clearSound(g._node))),n||r._emit("stop",g._id))}return r},mute:function(s,n){var r=this;if(r._state!=="loaded"||r._playLock)return r._queue.push({event:"mute",action:function(){r.mute(s,n)}}),r;if(typeof n>"u")if(typeof s=="boolean")r._muted=s;else return r._muted;for(var u=r._getSoundIds(n),p=0;p<u.length;p++){var g=r._soundById(u[p]);g&&(g._muted=s,g._interval&&r._stopFade(g._id),r._webAudio&&g._node?g._node.gain.setValueAtTime(s?0:g._volume,e.ctx.currentTime):g._node&&(g._node.muted=e._muted?!0:s),r._emit("mute",g._id))}return r},volume:function(){var s=this,n=arguments,r,u;if(n.length===0)return s._volume;if(n.length===1||n.length===2&&typeof n[1]>"u"){var p=s._getSoundIds(),g=p.indexOf(n[0]);g>=0?u=parseInt(n[0],10):r=parseFloat(n[0])}else n.length>=2&&(r=parseFloat(n[0]),u=parseInt(n[1],10));var m;if(typeof r<"u"&&r>=0&&r<=1){if(s._state!=="loaded"||s._playLock)return s._queue.push({event:"volume",action:function(){s.volume.apply(s,n)}}),s;typeof u>"u"&&(s._volume=r),u=s._getSoundIds(u);for(var b=0;b<u.length;b++)m=s._soundById(u[b]),m&&(m._volume=r,n[2]||s._stopFade(u[b]),s._webAudio&&m._node&&!m._muted?m._node.gain.setValueAtTime(r,e.ctx.currentTime):m._node&&!m._muted&&(m._node.volume=r*e.volume()),s._emit("volume",m._id))}else return m=u?s._soundById(u):s._sounds[0],m?m._volume:0;return s},fade:function(s,n,r,u){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"fade",action:function(){p.fade(s,n,r,u)}}),p;s=Math.min(Math.max(0,parseFloat(s)),1),n=Math.min(Math.max(0,parseFloat(n)),1),r=parseFloat(r),p.volume(s,u);for(var g=p._getSoundIds(u),m=0;m<g.length;m++){var b=p._soundById(g[m]);if(b){if(u||p._stopFade(g[m]),p._webAudio&&!b._muted){var M=e.ctx.currentTime,E=M+r/1e3;b._volume=s,b._node.gain.setValueAtTime(s,M),b._node.gain.linearRampToValueAtTime(n,E)}p._startFadeInterval(b,s,n,r,g[m],typeof u>"u")}}return p},_startFadeInterval:function(s,n,r,u,p,g){var m=this,b=n,M=r-n,E=Math.abs(M/.01),G=Math.max(4,E>0?u/E:u),V=Date.now();s._fadeTo=r,s._interval=setInterval(function(){var $=(Date.now()-V)/u;V=Date.now(),b+=M*$,b=Math.round(b*100)/100,M<0?b=Math.max(r,b):b=Math.min(r,b),m._webAudio?s._volume=b:m.volume(b,s._id,!0),g&&(m._volume=b),(r<n&&b<=r||r>n&&b>=r)&&(clearInterval(s._interval),s._interval=null,s._fadeTo=null,m.volume(r,s._id),m._emit("fade",s._id))},G)},_stopFade:function(s){var n=this,r=n._soundById(s);return r&&r._interval&&(n._webAudio&&r._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(r._interval),r._interval=null,n.volume(r._fadeTo,s),r._fadeTo=null,n._emit("fade",s)),n},loop:function(){var s=this,n=arguments,r,u,p;if(n.length===0)return s._loop;if(n.length===1)if(typeof n[0]=="boolean")r=n[0],s._loop=r;else return p=s._soundById(parseInt(n[0],10)),p?p._loop:!1;else n.length===2&&(r=n[0],u=parseInt(n[1],10));for(var g=s._getSoundIds(u),m=0;m<g.length;m++)p=s._soundById(g[m]),p&&(p._loop=r,s._webAudio&&p._node&&p._node.bufferSource&&(p._node.bufferSource.loop=r,r&&(p._node.bufferSource.loopStart=p._start||0,p._node.bufferSource.loopEnd=p._stop,s.playing(g[m])&&(s.pause(g[m],!0),s.play(g[m],!0)))));return s},rate:function(){var s=this,n=arguments,r,u;if(n.length===0)u=s._sounds[0]._id;else if(n.length===1){var p=s._getSoundIds(),g=p.indexOf(n[0]);g>=0?u=parseInt(n[0],10):r=parseFloat(n[0])}else n.length===2&&(r=parseFloat(n[0]),u=parseInt(n[1],10));var m;if(typeof r=="number"){if(s._state!=="loaded"||s._playLock)return s._queue.push({event:"rate",action:function(){s.rate.apply(s,n)}}),s;typeof u>"u"&&(s._rate=r),u=s._getSoundIds(u);for(var b=0;b<u.length;b++)if(m=s._soundById(u[b]),m){s.playing(u[b])&&(m._rateSeek=s.seek(u[b]),m._playStart=s._webAudio?e.ctx.currentTime:m._playStart),m._rate=r,s._webAudio&&m._node&&m._node.bufferSource?m._node.bufferSource.playbackRate.setValueAtTime(r,e.ctx.currentTime):m._node&&(m._node.playbackRate=r);var M=s.seek(u[b]),E=(s._sprite[m._sprite][0]+s._sprite[m._sprite][1])/1e3-M,G=E*1e3/Math.abs(m._rate);(s._endTimers[u[b]]||!m._paused)&&(s._clearTimer(u[b]),s._endTimers[u[b]]=setTimeout(s._ended.bind(s,m),G)),s._emit("rate",m._id)}}else return m=s._soundById(u),m?m._rate:s._rate;return s},seek:function(){var s=this,n=arguments,r,u;if(n.length===0)s._sounds.length&&(u=s._sounds[0]._id);else if(n.length===1){var p=s._getSoundIds(),g=p.indexOf(n[0]);g>=0?u=parseInt(n[0],10):s._sounds.length&&(u=s._sounds[0]._id,r=parseFloat(n[0]))}else n.length===2&&(r=parseFloat(n[0]),u=parseInt(n[1],10));if(typeof u>"u")return 0;if(typeof r=="number"&&(s._state!=="loaded"||s._playLock))return s._queue.push({event:"seek",action:function(){s.seek.apply(s,n)}}),s;var m=s._soundById(u);if(m)if(typeof r=="number"&&r>=0){var b=s.playing(u);b&&s.pause(u,!0),m._seek=r,m._ended=!1,s._clearTimer(u),!s._webAudio&&m._node&&!isNaN(m._node.duration)&&(m._node.currentTime=r);var M=function(){b&&s.play(u,!0),s._emit("seek",u)};if(b&&!s._webAudio){var E=function(){s._playLock?setTimeout(E,0):M()};setTimeout(E,0)}else M()}else if(s._webAudio){var G=s.playing(u)?e.ctx.currentTime-m._playStart:0,V=m._rateSeek?m._rateSeek-m._seek:0;return m._seek+(V+G*Math.abs(m._rate))}else return m._node.currentTime;return s},playing:function(s){var n=this;if(typeof s=="number"){var r=n._soundById(s);return r?!r._paused:!1}for(var u=0;u<n._sounds.length;u++)if(!n._sounds[u]._paused)return!0;return!1},duration:function(s){var n=this,r=n._duration,u=n._soundById(s);return u&&(r=n._sprite[u._sprite][1]/1e3),r},state:function(){return this._state},unload:function(){for(var s=this,n=s._sounds,r=0;r<n.length;r++)n[r]._paused||s.stop(n[r]._id),s._webAudio||(s._clearSound(n[r]._node),n[r]._node.removeEventListener("error",n[r]._errorFn,!1),n[r]._node.removeEventListener(e._canPlayEvent,n[r]._loadFn,!1),n[r]._node.removeEventListener("ended",n[r]._endFn,!1),e._releaseHtml5Audio(n[r]._node)),delete n[r]._node,s._clearTimer(n[r]._id);var u=e._howls.indexOf(s);u>=0&&e._howls.splice(u,1);var p=!0;for(r=0;r<e._howls.length;r++)if(e._howls[r]._src===s._src||s._src.indexOf(e._howls[r]._src)>=0){p=!1;break}return a&&p&&delete a[s._src],e.noAudio=!1,s._state="unloaded",s._sounds=[],s=null,null},on:function(s,n,r,u){var p=this,g=p["_on"+s];return typeof n=="function"&&g.push(u?{id:r,fn:n,once:u}:{id:r,fn:n}),p},off:function(s,n,r){var u=this,p=u["_on"+s],g=0;if(typeof n=="number"&&(r=n,n=null),n||r)for(g=0;g<p.length;g++){var m=r===p[g].id;if(n===p[g].fn&&m||!n&&m){p.splice(g,1);break}}else if(s)u["_on"+s]=[];else{var b=Object.keys(u);for(g=0;g<b.length;g++)b[g].indexOf("_on")===0&&Array.isArray(u[b[g]])&&(u[b[g]]=[])}return u},once:function(s,n,r){var u=this;return u.on(s,n,r,1),u},_emit:function(s,n,r){for(var u=this,p=u["_on"+s],g=p.length-1;g>=0;g--)(!p[g].id||p[g].id===n||s==="load")&&(setTimeout(function(m){m.call(this,n,r)}.bind(u,p[g].fn),0),p[g].once&&u.off(s,p[g].fn,p[g].id));return u._loadQueue(s),u},_loadQueue:function(s){var n=this;if(n._queue.length>0){var r=n._queue[0];r.event===s&&(n._queue.shift(),n._loadQueue()),s||r.action()}return n},_ended:function(s){var n=this,r=s._sprite;if(!n._webAudio&&s._node&&!s._node.paused&&!s._node.ended&&s._node.currentTime<s._stop)return setTimeout(n._ended.bind(n,s),100),n;var u=!!(s._loop||n._sprite[r][2]);if(n._emit("end",s._id),!n._webAudio&&u&&n.stop(s._id,!0).play(s._id),n._webAudio&&u){n._emit("play",s._id),s._seek=s._start||0,s._rateSeek=0,s._playStart=e.ctx.currentTime;var p=(s._stop-s._start)*1e3/Math.abs(s._rate);n._endTimers[s._id]=setTimeout(n._ended.bind(n,s),p)}return n._webAudio&&!u&&(s._paused=!0,s._ended=!0,s._seek=s._start||0,s._rateSeek=0,n._clearTimer(s._id),n._cleanBuffer(s._node),e._autoSuspend()),!n._webAudio&&!u&&n.stop(s._id,!0),n},_clearTimer:function(s){var n=this;if(n._endTimers[s]){if(typeof n._endTimers[s]!="function")clearTimeout(n._endTimers[s]);else{var r=n._soundById(s);r&&r._node&&r._node.removeEventListener("ended",n._endTimers[s],!1)}delete n._endTimers[s]}return n},_soundById:function(s){for(var n=this,r=0;r<n._sounds.length;r++)if(s===n._sounds[r]._id)return n._sounds[r];return null},_inactiveSound:function(){var s=this;s._drain();for(var n=0;n<s._sounds.length;n++)if(s._sounds[n]._ended)return s._sounds[n].reset();return new i(s)},_drain:function(){var s=this,n=s._pool,r=0,u=0;if(!(s._sounds.length<n)){for(u=0;u<s._sounds.length;u++)s._sounds[u]._ended&&r++;for(u=s._sounds.length-1;u>=0;u--){if(r<=n)return;s._sounds[u]._ended&&(s._webAudio&&s._sounds[u]._node&&s._sounds[u]._node.disconnect(0),s._sounds.splice(u,1),r--)}}},_getSoundIds:function(s){var n=this;if(typeof s>"u"){for(var r=[],u=0;u<n._sounds.length;u++)r.push(n._sounds[u]._id);return r}else return[s]},_refreshBuffer:function(s){var n=this;return s._node.bufferSource=e.ctx.createBufferSource(),s._node.bufferSource.buffer=a[n._src],s._panner?s._node.bufferSource.connect(s._panner):s._node.bufferSource.connect(s._node),s._node.bufferSource.loop=s._loop,s._loop&&(s._node.bufferSource.loopStart=s._start||0,s._node.bufferSource.loopEnd=s._stop||0),s._node.bufferSource.playbackRate.setValueAtTime(s._rate,e.ctx.currentTime),n},_cleanBuffer:function(s){var n=this,r=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!s.bufferSource)return n;if(e._scratchBuffer&&s.bufferSource&&(s.bufferSource.onended=null,s.bufferSource.disconnect(0),r))try{s.bufferSource.buffer=e._scratchBuffer}catch{}return s.bufferSource=null,n},_clearSound:function(s){var n=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);n||(s.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var i=function(s){this._parent=s,this.init()};i.prototype={init:function(){var s=this,n=s._parent;return s._muted=n._muted,s._loop=n._loop,s._volume=n._volume,s._rate=n._rate,s._seek=0,s._paused=!0,s._ended=!0,s._sprite="__default",s._id=++e._counter,n._sounds.push(s),s.create(),s},create:function(){var s=this,n=s._parent,r=e._muted||s._muted||s._parent._muted?0:s._volume;return n._webAudio?(s._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),s._node.gain.setValueAtTime(r,e.ctx.currentTime),s._node.paused=!0,s._node.connect(e.masterGain)):e.noAudio||(s._node=e._obtainHtml5Audio(),s._errorFn=s._errorListener.bind(s),s._node.addEventListener("error",s._errorFn,!1),s._loadFn=s._loadListener.bind(s),s._node.addEventListener(e._canPlayEvent,s._loadFn,!1),s._endFn=s._endListener.bind(s),s._node.addEventListener("ended",s._endFn,!1),s._node.src=n._src,s._node.preload=n._preload===!0?"auto":n._preload,s._node.volume=r*e.volume(),s._node.load()),s},reset:function(){var s=this,n=s._parent;return s._muted=n._muted,s._loop=n._loop,s._volume=n._volume,s._rate=n._rate,s._seek=0,s._rateSeek=0,s._paused=!0,s._ended=!0,s._sprite="__default",s._id=++e._counter,s},_errorListener:function(){var s=this;s._parent._emit("loaderror",s._id,s._node.error?s._node.error.code:0),s._node.removeEventListener("error",s._errorFn,!1)},_loadListener:function(){var s=this,n=s._parent;n._duration=Math.ceil(s._node.duration*10)/10,Object.keys(n._sprite).length===0&&(n._sprite={__default:[0,n._duration*1e3]}),n._state!=="loaded"&&(n._state="loaded",n._emit("load"),n._loadQueue()),s._node.removeEventListener(e._canPlayEvent,s._loadFn,!1)},_endListener:function(){var s=this,n=s._parent;n._duration===1/0&&(n._duration=Math.ceil(s._node.duration*10)/10,n._sprite.__default[1]===1/0&&(n._sprite.__default[1]=n._duration*1e3),n._ended(s)),s._node.removeEventListener("ended",s._endFn,!1)}};var a={},c=function(s){var n=s._src;if(a[n]){s._duration=a[n].duration,f(s);return}if(/^data:[^;]+;base64,/.test(n)){for(var r=atob(n.split(",")[1]),u=new Uint8Array(r.length),p=0;p<r.length;++p)u[p]=r.charCodeAt(p);h(u.buffer,s)}else{var g=new XMLHttpRequest;g.open(s._xhr.method,n,!0),g.withCredentials=s._xhr.withCredentials,g.responseType="arraybuffer",s._xhr.headers&&Object.keys(s._xhr.headers).forEach(function(m){g.setRequestHeader(m,s._xhr.headers[m])}),g.onload=function(){var m=(g.status+"")[0];if(m!=="0"&&m!=="2"&&m!=="3"){s._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");return}h(g.response,s)},g.onerror=function(){s._webAudio&&(s._html5=!0,s._webAudio=!1,s._sounds=[],delete a[n],s.load())},d(g)}},d=function(s){try{s.send()}catch{s.onerror()}},h=function(s,n){var r=function(){n._emit("loaderror",null,"Decoding audio data failed.")},u=function(p){p&&n._sounds.length>0?(a[n._src]=p,f(n,p)):r()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(s).then(u).catch(r):e.ctx.decodeAudioData(s,u,r)},f=function(s,n){n&&!s._duration&&(s._duration=n.duration),Object.keys(s._sprite).length===0&&(s._sprite={__default:[0,s._duration*1e3]}),s._state!=="loaded"&&(s._state="loaded",s._emit("load"),s._loadQueue())},y=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var s=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),n=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),r=n?parseInt(n[1],10):null;if(s&&r&&r<9){var u=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!u&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};l.Howler=e,l.Howl=o,typeof J<"u"?(J.HowlerGlobal=t,J.Howler=e,J.Howl=o,J.Sound=i):typeof window<"u"&&(window.HowlerGlobal=t,window.Howler=e,window.Howl=o,window.Sound=i)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var o=this;if(!o.ctx||!o.ctx.listener)return o;for(var i=o._howls.length-1;i>=0;i--)o._howls[i].stereo(e);return o},HowlerGlobal.prototype.pos=function(e,o,i){var a=this;if(!a.ctx||!a.ctx.listener)return a;if(o=typeof o!="number"?a._pos[1]:o,i=typeof i!="number"?a._pos[2]:i,typeof e=="number")a._pos=[e,o,i],typeof a.ctx.listener.positionX<"u"?(a.ctx.listener.positionX.setTargetAtTime(a._pos[0],Howler.ctx.currentTime,.1),a.ctx.listener.positionY.setTargetAtTime(a._pos[1],Howler.ctx.currentTime,.1),a.ctx.listener.positionZ.setTargetAtTime(a._pos[2],Howler.ctx.currentTime,.1)):a.ctx.listener.setPosition(a._pos[0],a._pos[1],a._pos[2]);else return a._pos;return a},HowlerGlobal.prototype.orientation=function(e,o,i,a,c,d){var h=this;if(!h.ctx||!h.ctx.listener)return h;var f=h._orientation;if(o=typeof o!="number"?f[1]:o,i=typeof i!="number"?f[2]:i,a=typeof a!="number"?f[3]:a,c=typeof c!="number"?f[4]:c,d=typeof d!="number"?f[5]:d,typeof e=="number")h._orientation=[e,o,i,a,c,d],typeof h.ctx.listener.forwardX<"u"?(h.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),h.ctx.listener.forwardY.setTargetAtTime(o,Howler.ctx.currentTime,.1),h.ctx.listener.forwardZ.setTargetAtTime(i,Howler.ctx.currentTime,.1),h.ctx.listener.upX.setTargetAtTime(a,Howler.ctx.currentTime,.1),h.ctx.listener.upY.setTargetAtTime(c,Howler.ctx.currentTime,.1),h.ctx.listener.upZ.setTargetAtTime(d,Howler.ctx.currentTime,.1)):h.ctx.listener.setOrientation(e,o,i,a,c,d);else return f;return h},Howl.prototype.init=(function(e){return function(o){var i=this;return i._orientation=o.orientation||[1,0,0],i._stereo=o.stereo||null,i._pos=o.pos||null,i._pannerAttr={coneInnerAngle:typeof o.coneInnerAngle<"u"?o.coneInnerAngle:360,coneOuterAngle:typeof o.coneOuterAngle<"u"?o.coneOuterAngle:360,coneOuterGain:typeof o.coneOuterGain<"u"?o.coneOuterGain:0,distanceModel:typeof o.distanceModel<"u"?o.distanceModel:"inverse",maxDistance:typeof o.maxDistance<"u"?o.maxDistance:1e4,panningModel:typeof o.panningModel<"u"?o.panningModel:"HRTF",refDistance:typeof o.refDistance<"u"?o.refDistance:1,rolloffFactor:typeof o.rolloffFactor<"u"?o.rolloffFactor:1},i._onstereo=o.onstereo?[{fn:o.onstereo}]:[],i._onpos=o.onpos?[{fn:o.onpos}]:[],i._onorientation=o.onorientation?[{fn:o.onorientation}]:[],e.call(this,o)}})(Howl.prototype.init),Howl.prototype.stereo=function(e,o){var i=this;if(!i._webAudio)return i;if(i._state!=="loaded")return i._queue.push({event:"stereo",action:function(){i.stereo(e,o)}}),i;var a=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof o>"u")if(typeof e=="number")i._stereo=e,i._pos=[e,0,0];else return i._stereo;for(var c=i._getSoundIds(o),d=0;d<c.length;d++){var h=i._soundById(c[d]);if(h)if(typeof e=="number")h._stereo=e,h._pos=[e,0,0],h._node&&(h._pannerAttr.panningModel="equalpower",(!h._panner||!h._panner.pan)&&t(h,a),a==="spatial"?typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):h._panner.setPosition(e,0,0):h._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),i._emit("stereo",h._id);else return h._stereo}return i},Howl.prototype.pos=function(e,o,i,a){var c=this;if(!c._webAudio)return c;if(c._state!=="loaded")return c._queue.push({event:"pos",action:function(){c.pos(e,o,i,a)}}),c;if(o=typeof o!="number"?0:o,i=typeof i!="number"?-.5:i,typeof a>"u")if(typeof e=="number")c._pos=[e,o,i];else return c._pos;for(var d=c._getSoundIds(a),h=0;h<d.length;h++){var f=c._soundById(d[h]);if(f)if(typeof e=="number")f._pos=[e,o,i],f._node&&((!f._panner||f._panner.pan)&&t(f,"spatial"),typeof f._panner.positionX<"u"?(f._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),f._panner.positionY.setValueAtTime(o,Howler.ctx.currentTime),f._panner.positionZ.setValueAtTime(i,Howler.ctx.currentTime)):f._panner.setPosition(e,o,i)),c._emit("pos",f._id);else return f._pos}return c},Howl.prototype.orientation=function(e,o,i,a){var c=this;if(!c._webAudio)return c;if(c._state!=="loaded")return c._queue.push({event:"orientation",action:function(){c.orientation(e,o,i,a)}}),c;if(o=typeof o!="number"?c._orientation[1]:o,i=typeof i!="number"?c._orientation[2]:i,typeof a>"u")if(typeof e=="number")c._orientation=[e,o,i];else return c._orientation;for(var d=c._getSoundIds(a),h=0;h<d.length;h++){var f=c._soundById(d[h]);if(f)if(typeof e=="number")f._orientation=[e,o,i],f._node&&(f._panner||(f._pos||(f._pos=c._pos||[0,0,-.5]),t(f,"spatial")),typeof f._panner.orientationX<"u"?(f._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),f._panner.orientationY.setValueAtTime(o,Howler.ctx.currentTime),f._panner.orientationZ.setValueAtTime(i,Howler.ctx.currentTime)):f._panner.setOrientation(e,o,i)),c._emit("orientation",f._id);else return f._orientation}return c},Howl.prototype.pannerAttr=function(){var e=this,o=arguments,i,a,c;if(!e._webAudio)return e;if(o.length===0)return e._pannerAttr;if(o.length===1)if(typeof o[0]=="object")i=o[0],typeof a>"u"&&(i.pannerAttr||(i.pannerAttr={coneInnerAngle:i.coneInnerAngle,coneOuterAngle:i.coneOuterAngle,coneOuterGain:i.coneOuterGain,distanceModel:i.distanceModel,maxDistance:i.maxDistance,refDistance:i.refDistance,rolloffFactor:i.rolloffFactor,panningModel:i.panningModel}),e._pannerAttr={coneInnerAngle:typeof i.pannerAttr.coneInnerAngle<"u"?i.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof i.pannerAttr.coneOuterAngle<"u"?i.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof i.pannerAttr.coneOuterGain<"u"?i.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof i.pannerAttr.distanceModel<"u"?i.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof i.pannerAttr.maxDistance<"u"?i.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof i.pannerAttr.refDistance<"u"?i.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof i.pannerAttr.rolloffFactor<"u"?i.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof i.pannerAttr.panningModel<"u"?i.pannerAttr.panningModel:e._panningModel});else return c=e._soundById(parseInt(o[0],10)),c?c._pannerAttr:e._pannerAttr;else o.length===2&&(i=o[0],a=parseInt(o[1],10));for(var d=e._getSoundIds(a),h=0;h<d.length;h++)if(c=e._soundById(d[h]),c){var f=c._pannerAttr;f={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:f.coneInnerAngle,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:f.coneOuterAngle,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:f.coneOuterGain,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:f.distanceModel,maxDistance:typeof i.maxDistance<"u"?i.maxDistance:f.maxDistance,refDistance:typeof i.refDistance<"u"?i.refDistance:f.refDistance,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:f.rolloffFactor,panningModel:typeof i.panningModel<"u"?i.panningModel:f.panningModel};var y=c._panner;y||(c._pos||(c._pos=e._pos||[0,0,-.5]),t(c,"spatial"),y=c._panner),y.coneInnerAngle=f.coneInnerAngle,y.coneOuterAngle=f.coneOuterAngle,y.coneOuterGain=f.coneOuterGain,y.distanceModel=f.distanceModel,y.maxDistance=f.maxDistance,y.refDistance=f.refDistance,y.rolloffFactor=f.rolloffFactor,y.panningModel=f.panningModel}return e},Sound.prototype.init=(function(e){return function(){var o=this,i=o._parent;o._orientation=i._orientation,o._stereo=i._stereo,o._pos=i._pos,o._pannerAttr=i._pannerAttr,e.call(this),o._stereo?i.stereo(o._stereo):o._pos&&i.pos(o._pos[0],o._pos[1],o._pos[2],o._id)}})(Sound.prototype.init),Sound.prototype.reset=(function(e){return function(){var o=this,i=o._parent;return o._orientation=i._orientation,o._stereo=i._stereo,o._pos=i._pos,o._pannerAttr=i._pannerAttr,o._stereo?i.stereo(o._stereo):o._pos?i.pos(o._pos[0],o._pos[1],o._pos[2],o._id):o._panner&&(o._panner.disconnect(0),o._panner=void 0,i._refreshBuffer(o)),e.call(this)}})(Sound.prototype.reset);var t=function(e,o){o=o||"spatial",o==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(de)),de}var X=gt();class yt{sounds={};music=null;currentMusicTrack=null;masterVolume=1;musicVolume=.5;sfxVolume=.7;uiVolume=.8;isInitialized=!1;muted=!1;soundPaths={"music-menu":"/audio/music-menu.mp3","music-gameplay":"/audio/music-gameplay.mp3","music-level-1":"/audio/music-level-1.mp3","music-level-2":"/audio/music-level-2.mp3","music-level-3":"/audio/music-level-3.mp3","music-level-4":"/audio/music-level-4.mp3","sfx-bomb-place":"/audio/sfx-bomb-place.mp3","sfx-explosion":"/audio/sfx-explosion.mp3","sfx-fuse":"/audio/sfx-bomb-place.mp3","sfx-powerup":"/audio/sfx-powerup.mp3","sfx-enemy-death":"/audio/sfx-enemy-death.mp3","sfx-player-damage":"/audio/sfx-player-damage.mp3","sfx-victory":"/audio/sfx-victory.mp3","sfx-defeat":"/audio/sfx-defeat.mp3","voice-im-the-man":"/audio/voice-im-the-man.mp3","voice-get-outta-here":"/audio/voice-get-outta-here.mp3","voice-boom":"/audio/voice-boom.mp3","voice-no-mercy":"/audio/voice-no-mercy.mp3","sfx-level-complete":"/audio/sfx-victory.mp3","sfx-level-start":"/audio/sfx-powerup.mp3"};constructor(){}initialize(){this.isInitialized||(this.loadAllSounds(),this.isInitialized=!0,console.log("[AudioEngine] Initialized"))}loadAllSounds(){Object.entries(this.soundPaths).forEach(([t,e])=>{t.startsWith("music-")||(this.sounds[t]=new X.Howl({src:[e],volume:this.sfxVolume*this.masterVolume,preload:!0,html5:!1,onloaderror:(o,i)=>{console.warn(`[AudioEngine] Failed to load sound: ${t}`,i)}}))})}playSound(t){if(this.isInitialized||this.initialize(),this.muted)return;const e=this.sounds[t];e?(e.volume(this.sfxVolume*this.masterVolume),e.play()):console.warn(`[AudioEngine] Sound not found: ${t}`)}playMenuMusic(){this.playMusicTrack("music-menu")}playGameplayMusic(){this.playMusicTrack("music-gameplay")}playLevelMusic(t){const o=`music-level-${(t-1)%4+1}`;this.playMusicTrack(o)}playMusicTrack(t){if(this.isInitialized||this.initialize(),this.currentMusicTrack===t&&this.music?.playing())return;this.stopMusic();const e=this.soundPaths[t];if(!e){console.warn(`[AudioEngine] Music track not found: ${t}`);return}this.music=new X.Howl({src:[e],volume:this.musicVolume*this.masterVolume,loop:!0,html5:!0,onloaderror:(o,i)=>{console.warn(`[AudioEngine] Failed to load music: ${t}`,i)}}),this.muted||this.music.play(),this.currentMusicTrack=t}stopMusic(){this.music&&(this.music.stop(),this.music.unload(),this.music=null),this.currentMusicTrack=null}pauseMusic(){this.music&&this.music.pause()}resumeMusic(){this.music&&!this.muted&&this.music.play()}playBombPlace(){this.playSound("sfx-bomb-place")}playExplosion(){if(this.isInitialized||this.initialize(),this.muted)return;const t=this.sounds["sfx-explosion"];t&&(t.volume(Math.min(1,this.sfxVolume*this.masterVolume*1.5)),t.play())}playFuseTick(){if(this.isInitialized||this.initialize(),this.muted)return;const t=this.sounds["sfx-bomb-place"];t&&(t.volume(Math.min(1,this.sfxVolume*this.masterVolume*1.3)),t.play())}playPowerUp(){this.playSound("sfx-powerup")}playEnemyDeath(){this.playSound("sfx-enemy-death")}playPlayerDamage(){this.playSound("sfx-player-damage")}playVictory(){this.playSound("sfx-victory")}playDefeat(){this.playSound("sfx-defeat")}playLevelComplete(){if(this.isInitialized||this.initialize(),this.muted)return;const t=this.sounds["sfx-level-complete"];t&&(t.volume(Math.min(1,this.sfxVolume*this.masterVolume*1.8)),t.play())}playLevelStart(){if(this.isInitialized||this.initialize(),this.muted)return;const t=this.sounds["sfx-level-start"];t&&(t.volume(Math.min(1,this.sfxVolume*this.masterVolume*1.3)),t.play())}playSoundEffect(t){t==="ui-select"?this.playSound("sfx-bomb-place"):this.playSound(t)}voiceAffirmations=["voice-im-the-man","voice-get-outta-here","voice-boom","voice-no-mercy"];playRandomAffirmation(){if(this.isInitialized||this.initialize(),this.muted||Math.random()>.3)return;const t=Math.floor(Math.random()*this.voiceAffirmations.length),e=this.voiceAffirmations[t],o=this.sounds[e];o&&(o.volume(Math.min(1,this.sfxVolume*this.masterVolume*1.2)),o.play())}setMasterVolume(t){this.masterVolume=Math.max(0,Math.min(1,t)),X.Howler.volume(this.masterVolume),this.updateAllVolumes()}setMusicVolume(t){this.musicVolume=Math.max(0,Math.min(1,t)),this.music&&this.music.volume(this.musicVolume*this.masterVolume)}setSfxVolume(t){this.sfxVolume=Math.max(0,Math.min(1,t)),Object.values(this.sounds).forEach(e=>{e.volume(this.sfxVolume*this.masterVolume)})}setUiVolume(t){this.uiVolume=Math.max(0,Math.min(1,t))}updateAllVolumes(){this.setMusicVolume(this.musicVolume),this.setSfxVolume(this.sfxVolume)}getVolumes(){return{master:this.masterVolume,music:this.musicVolume,sfx:this.sfxVolume,ui:this.uiVolume}}mute(){this.muted=!0,X.Howler.mute(!0)}unmute(){this.muted=!1,X.Howler.mute(!1)}toggleMute(){return this.muted?this.unmute():this.mute(),this.muted}isMuted(){return this.muted}playSfx(t=440,e=.1){this.isInitialized||this.playTone(t,e)}playTone(t,e){try{const o=new(window.AudioContext||window.webkitAudioContext),i=o.createOscillator(),a=o.createGain();i.frequency.value=t,i.type="square",a.gain.setValueAtTime(.1*this.sfxVolume*this.masterVolume,o.currentTime),a.gain.exponentialRampToValueAtTime(.01,o.currentTime+e),i.connect(a),a.connect(o.destination),i.start(),i.stop(o.currentTime+e)}catch{console.warn("[AudioEngine] Web Audio API not available")}}isSupported(){return X.Howler.codecs("mp3")}preload(){this.isInitialized||this.initialize()}}const W=new yt;class _t{container;_currentScreen=C.MAIN;onStartGame;onResumeGame;onQuitGame;selectedLevel=1;constructor(t,e,o){this.onStartGame=t,this.onResumeGame=e,this.onQuitGame=o,this.container=document.createElement("div"),this.container.id="game-menus",this.container.className="game-menus",document.body.appendChild(this.container),this.injectStyles(),this.showScreen(C.MAIN)}injectStyles(){if(document.getElementById("game-menu-styles"))return;const t=document.createElement("style");t.id="game-menu-styles",t.textContent=`
      .game-menus {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        pointer-events: none;
      }
      
      .game-menus.active {
        pointer-events: auto;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }
      
      .menu-panel {
        background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid #0f3460;
        border-radius: 16px;
        padding: 40px;
        min-width: 320px;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: menuSlideIn 0.3s ease-out;
      }
      
      @keyframes menuSlideIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .menu-title {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 8px;
        background: linear-gradient(90deg, #e94560, #ff6b6b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 10px rgba(233, 69, 96, 0.3);
      }
      
      .menu-subtitle {
        text-align: center;
        color: #8892b0;
        margin-bottom: 30px;
        font-size: 0.9rem;
      }
      
      .menu-button {
        display: block;
        width: 100%;
        padding: 16px 24px;
        margin: 12px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #fff;
        background: linear-gradient(145deg, #0f3460 0%, #16213e 100%);
        border: 2px solid #1a4a7a;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
      }
      
      .menu-button:hover {
        background: linear-gradient(145deg, #1a4a7a 0%, #0f3460 100%);
        border-color: #e94560;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(233, 69, 96, 0.3);
      }
      
      .menu-button:active {
        transform: translateY(0);
      }
      
      .menu-button.primary {
        background: linear-gradient(145deg, #e94560 0%, #c73e54 100%);
        border-color: #ff6b6b;
      }
      
      .menu-button.primary:hover {
        background: linear-gradient(145deg, #ff6b6b 0%, #e94560 100%);
        box-shadow: 0 8px 20px rgba(233, 69, 96, 0.5);
      }
      
      .menu-button.secondary {
        background: transparent;
        border-color: #4a5568;
      }
      
      .menu-button.secondary:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: #8892b0;
      }
      
      .menu-section {
        margin-bottom: 24px;
      }
      
      .menu-section-title {
        font-size: 1rem;
        color: #e94560;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .setting-label {
        color: #ccd6f6;
        font-size: 0.95rem;
      }
      
      .setting-control {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .slider {
        width: 120px;
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background: #1a4a7a;
        border-radius: 3px;
        outline: none;
      }
      
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #e94560;
        border-radius: 50%;
        cursor: pointer;
      }
      
      .toggle {
        width: 50px;
        height: 26px;
        background: #1a4a7a;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }
      
      .toggle.active {
        background: #e94560;
      }
      
      .toggle::after {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        background: #fff;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }
      
      .toggle.active::after {
        transform: translateX(24px);
      }
      
      .back-button {
        margin-top: 20px;
        padding: 12px 24px;
        background: transparent;
        border: 2px solid #4a5568;
        color: #8892b0;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.2s;
      }
      
      .back-button:hover {
        border-color: #e94560;
        color: #e94560;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin: 20px 0;
      }
      
      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }
      
      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #e94560;
      }
      
      .stat-label {
        font-size: 0.85rem;
        color: #8892b0;
        margin-top: 4px;
      }
      
      .level-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin: 20px 0;
      }
      
      .level-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }
      
      .level-card:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #0f3460;
      }
      
      .level-card.selected {
        border-color: #e94560;
        background: rgba(233, 69, 96, 0.1);
      }
      
      .level-card.locked {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .level-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ccd6f6;
      }
      
      .level-name {
        font-size: 0.85rem;
        color: #8892b0;
        margin-top: 4px;
      }
      
      .instructions-list {
        list-style: none;
        padding: 0;
        margin: 20px 0;
      }
      
      .instructions-list li {
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #ccd6f6;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .key {
        background: #0f3460;
        padding: 4px 10px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.85rem;
        color: #e94560;
        min-width: 60px;
        text-align: center;
      }
      
      .game-over-title {
        font-size: 3rem;
        text-align: center;
        margin-bottom: 20px;
      }
      
      .game-over-title.victory {
        color: #4ade80;
        text-shadow: 0 2px 20px rgba(74, 222, 128, 0.5);
      }
      
      .game-over-title.defeat {
        color: #ef4444;
        text-shadow: 0 2px 20px rgba(239, 68, 68, 0.5);
      }
      
      .pause-overlay {
        text-align: center;
      }
      
      .pause-title {
        font-size: 3rem;
        color: #fff;
        margin-bottom: 30px;
        text-shadow: 0 2px 20px rgba(255, 255, 255, 0.3);
      }
      
      @media (max-width: 600px) {
        .menu-panel {
          padding: 24px;
          min-width: 280px;
        }
        
        .menu-title {
          font-size: 2rem;
        }
        
        .menu-button {
          padding: 14px 20px;
          font-size: 1rem;
        }
        
        .stats-grid, .level-grid {
          grid-template-columns: 1fr;
        }
      }
    `,document.head.appendChild(t)}showScreen(t){switch(this._currentScreen=t,this.container.innerHTML="",this.container.className="game-menus active",t){case C.MAIN:this.renderMainMenu();break;case C.SETTINGS:this.renderSettings();break;case C.HOW_TO_PLAY:this.renderHowToPlay();break;case C.STATS:this.renderStats();break;case C.LEVEL_SELECT:this.renderLevelSelect();break}}renderMainMenu(){const t=document.createElement("div");t.className="menu-panel",t.innerHTML=`
      <h1 class="menu-title">BLASTFORGE</h1>
      <p class="menu-subtitle">Master the Fuse. Control the Chaos.</p>
      <button class="menu-button primary" data-action="play"> Play</button>
      <button class="menu-button" data-action="levels"> Select Level</button>
      <button class="menu-button" data-action="stats"> Statistics</button>
      <button class="menu-button" data-action="settings"> Settings</button>
      <button class="menu-button" data-action="help"> How to Play</button>
    `,this.bindButton(t,'[data-action="play"]',()=>this.onStartGame(this.selectedLevel)),this.bindButton(t,'[data-action="levels"]',()=>this.showScreen(C.LEVEL_SELECT)),this.bindButton(t,'[data-action="stats"]',()=>this.showScreen(C.STATS)),this.bindButton(t,'[data-action="settings"]',()=>this.showScreen(C.SETTINGS)),this.bindButton(t,'[data-action="help"]',()=>this.showScreen(C.HOW_TO_PLAY)),this.container.appendChild(t)}renderSettings(){const t=T.getSettings(),e=document.createElement("div");e.className="menu-panel",e.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">Settings</h2>
      
      <div class="menu-section">
        <div class="menu-section-title">Audio</div>
        <div class="setting-row">
          <span class="setting-label"> Mute All</span>
          <div class="setting-control">
            <div class="toggle ${W.isMuted()?"active":""}" id="mute-toggle"></div>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label"> Music Volume</span>
          <div class="setting-control">
            <input type="range" class="slider" id="music-volume" min="0" max="100" value="${Math.round(t.musicVolume*100)}">
            <span id="music-value">${Math.round(t.musicVolume*100)}%</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label"> SFX Volume</span>
          <div class="setting-control">
            <input type="range" class="slider" id="sfx-volume" min="0" max="100" value="${Math.round(t.sfxVolume*100)}">
            <span id="sfx-value">${Math.round(t.sfxVolume*100)}%</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label"> UI Volume</span>
          <div class="setting-control">
            <input type="range" class="slider" id="ui-volume" min="0" max="100" value="${Math.round(t.uiVolume*100)}">
            <span id="ui-value">${Math.round(t.uiVolume*100)}%</span>
          </div>
        </div>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Display</div>
        <div class="setting-row">
          <span class="setting-label">Fullscreen</span>
          <div class="setting-control">
            <div class="toggle ${t.fullscreen?"active":""}" id="fullscreen-toggle"></div>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Show FPS</span>
          <div class="setting-control">
            <div class="toggle ${t.showFPS?"active":""}" id="fps-toggle"></div>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Vibration</span>
          <div class="setting-control">
            <div class="toggle ${t.vibration?"active":""}" id="vibration-toggle"></div>
          </div>
        </div>
      </div>
      
      <button class="back-button" data-action="back"> Back</button>
    `;const o=e.querySelector("#music-volume"),i=e.querySelector("#music-value");o?.addEventListener("input",()=>{const f=parseInt(o.value)/100;i.textContent=`${o.value}%`,T.setMusicVolume(f),W.setMusicVolume(f)});const a=e.querySelector("#sfx-volume"),c=e.querySelector("#sfx-value");a?.addEventListener("input",()=>{const f=parseInt(a.value)/100;c.textContent=`${a.value}%`,T.setSfxVolume(f),W.setSfxVolume(f)});const d=e.querySelector("#ui-volume"),h=e.querySelector("#ui-value");d?.addEventListener("input",()=>{const f=parseInt(d.value)/100;h.textContent=`${d.value}%`,T.setUiVolume(f),W.setUiVolume(f)}),this.bindToggle(e,"#mute-toggle",()=>{const f=W.toggleMute(),y=e.querySelector("#mute-toggle");y&&y.classList.toggle("active",f)}),this.bindToggle(e,"#fullscreen-toggle",()=>{const f=T.getSettings();T.setFullscreen(!f.fullscreen)}),this.bindToggle(e,"#fps-toggle",()=>{const f=T.getSettings();T.setShowFPS(!f.showFPS)}),this.bindToggle(e,"#vibration-toggle",()=>{const f=T.getSettings();T.setVibration(!f.vibration)}),this.bindButton(e,'[data-action="back"]',()=>this.showScreen(C.MAIN)),this.container.appendChild(e)}renderHowToPlay(){const t=document.createElement("div");t.className="menu-panel",t.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">How to Play</h2>
      
      <div class="menu-section">
        <div class="menu-section-title">Movement</div>
        <ul class="instructions-list">
          <li><span class="key">WASD</span> Move your character</li>
          <li><span class="key">Arrows</span> Alternative movement</li>
        </ul>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Actions</div>
        <ul class="instructions-list">
          <li><span class="key">SPACE</span> Place bomb</li>
          <li><span class="key">Q</span> Prime bomb (fuse)</li>
          <li><span class="key">E</span> Rush bomb (fast fuse)</li>
          <li><span class="key">R</span> Detonate (remote)</li>
          <li><span class="key">P</span> Pause game</li>
        </ul>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Objective</div>
        <p style="color: #ccd6f6; line-height: 1.6;">
          Destroy soft blocks to clear paths and find power-ups. 
          Eliminate all enemies or be the last one standing to win!
          Watch out for your own bombs - the explosion hurts you too.
        </p>
      </div>
      
      <button class="back-button" data-action="back"> Back</button>
    `,this.bindButton(t,'[data-action="back"]',()=>this.showScreen(C.MAIN)),this.container.appendChild(t)}renderStats(){const t=T.getStats(),e=document.createElement("div");e.className="menu-panel",e.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">Statistics</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${t.totalWins}</div>
          <div class="stat-label">Wins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${t.totalLosses}</div>
          <div class="stat-label">Losses</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${this.formatTime(t.totalPlayTime)}</div>
          <div class="stat-label">Play Time</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${t.bombsPlaced}</div>
          <div class="stat-label">Bombs Placed</div>
        </div>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Level Progress</div>
        <p style="color: #ccd6f6;">
          Levels Completed: ${t.levelsCompleted.length} / ${H.length}
        </p>
      </div>
      
      <button class="menu-button secondary" data-action="reset" style="margin-top: 10px;">
        Reset All Stats
      </button>
      <button class="back-button" data-action="back"> Back</button>
    `,this.bindButton(e,'[data-action="reset"]',()=>{confirm("Are you sure you want to reset all statistics?")&&(T.resetStats(),this.renderStats())}),this.bindButton(e,'[data-action="back"]',()=>this.showScreen(C.MAIN)),this.container.appendChild(e)}renderLevelSelect(){const t=T.getStats(),e=document.createElement("div");e.className="menu-panel";let o='<div class="level-grid">';H.forEach((i,a)=>{const c=t.levelsCompleted.includes(i.id),d=i.id===this.selectedLevel;o+=`
        <div class="level-card ${d?"selected":""} " 
             data-level="${i.id}">
          <div class="level-number">Level ${i.id}</div>
          <div class="level-name">${i.name}</div>
          ${c?" Completed":""}
          
        </div>
      `}),o+="</div>",e.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">Select Level</h2>
      <p class="menu-subtitle">Complete levels to unlock more</p>
      ${o}
      <button class="menu-button primary" data-action="start">Start Level</button>
      <button class="back-button" data-action="back"> Back</button>
    `,e.querySelectorAll(".level-card").forEach(i=>{i.addEventListener("click",()=>{const a=parseInt(i.getAttribute("data-level")||"1");this.selectedLevel=a,console.log(`[MenuManager] Selected level: ${this.selectedLevel}`),e.querySelectorAll(".level-card").forEach(c=>c.classList.remove("selected")),i.classList.add("selected"),W.playSoundEffect("ui-select")})}),this.bindButton(e,'[data-action="start"]',()=>this.onStartGame(this.selectedLevel)),this.bindButton(e,'[data-action="back"]',()=>this.showScreen(C.MAIN)),this.container.appendChild(e)}showPauseMenu(){this.container.innerHTML="",this.container.className="game-menus active";const t=document.createElement("div");t.className="menu-panel pause-overlay",t.innerHTML=`
      <h2 class="pause-title">PAUSED</h2>
      <button class="menu-button primary" data-action="resume"> Resume</button>
      <button class="menu-button" data-action="restart"> Restart Level</button>
      <button class="menu-button" data-action="quit"> Quit to Menu</button>
    `,this.bindButton(t,'[data-action="resume"]',()=>this.onResumeGame()),this.bindButton(t,'[data-action="restart"]',()=>this.onStartGame(this.selectedLevel)),this.bindButton(t,'[data-action="quit"]',()=>this.onQuitGame()),this.container.appendChild(t)}showGameOver(t,e){this.container.innerHTML="",this.container.className="game-menus active";const o=document.createElement("div");o.className="menu-panel";const i=t?"VICTORY!":"GAME OVER",a=t?"victory":"defeat";let c="";e&&(c=`
        <div class="stats-grid" style="margin: 20px 0;">
          <div class="stat-card">
            <div class="stat-value">${this.formatTime(e.time)}</div>
            <div class="stat-label">Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${e.bombs}</div>
            <div class="stat-label">Bombs</div>
          </div>
        </div>
      `),o.innerHTML=`
      <h2 class="game-over-title ${a}">${i}</h2>
      ${c}
      <button class="menu-button primary" data-action="next">
        ${t?"Next Level ":"Try Again "}
      </button>
      <button class="menu-button" data-action="menu">Main Menu</button>
    `,this.bindButton(o,'[data-action="next"]',()=>{if(t){const d=this.selectedLevel+1;d<=H.length&&(this.selectedLevel=d)}this.onStartGame(this.selectedLevel)}),this.bindButton(o,'[data-action="menu"]',()=>this.showScreen(C.MAIN)),this.container.appendChild(o)}hide(){this.container.innerHTML="",this.container.className="game-menus"}bindButton(t,e,o){const i=t.querySelector(e);i&&i.addEventListener("click",o)}bindToggle(t,e,o){const i=t.querySelector(e);i&&i.addEventListener("click",()=>{i.classList.toggle("active"),o()})}formatTime(t){const e=Math.floor(t/3600),o=Math.floor(t%3600/60);return e>0?`${e}h ${o}m`:`${o}m`}}class bt{keys=new Set;bombPressed=!1;pausePressed=!1;anyKeyPressed=!1;pauseCallback=null;constructor(){window.addEventListener("keydown",t=>{this.keys.add(t.code),t.code==="Space"&&(this.bombPressed=!0),(t.code==="Escape"||t.code==="KeyP")&&(this.pausePressed=!0,this.pauseCallback?.()),this.anyKeyPressed=!0,t.preventDefault()}),window.addEventListener("keyup",t=>{this.keys.delete(t.code)})}setPauseCallback(t){this.pauseCallback=t}poll(){const t=this.getDirection();let e=x.None;return t.x<0?e=x.Left:t.x>0?e=x.Right:t.y<0?e=x.Up:t.y>0&&(e=x.Down),{moveDir:e,placeBomb:this.consumeBomb(),fuseAction:null,pause:this.consumePause(),menuBack:this.keys.has("Escape"),menuSelect:this.keys.has("Enter")||this.keys.has("Space"),menuUp:this.keys.has("ArrowUp")||this.keys.has("KeyW"),menuDown:this.keys.has("ArrowDown")||this.keys.has("KeyS"),menuLeft:this.keys.has("ArrowLeft")||this.keys.has("KeyA"),menuRight:this.keys.has("ArrowRight")||this.keys.has("KeyD")}}getDirection(){let t=0,e=0;return(this.keys.has("ArrowLeft")||this.keys.has("KeyA"))&&(t-=1),(this.keys.has("ArrowRight")||this.keys.has("KeyD"))&&(t+=1),(this.keys.has("ArrowUp")||this.keys.has("KeyW"))&&(e-=1),(this.keys.has("ArrowDown")||this.keys.has("KeyS"))&&(e+=1),{x:t,y:e}}consumeBomb(){return this.bombPressed?(this.bombPressed=!1,!0):!1}consumePause(){return this.pausePressed?(this.pausePressed=!1,!0):!1}consumeAnyKey(){return this.anyKeyPressed?(this.anyKeyPressed=!1,!0):!1}}const ee=new D;function O(l,t,e,o,i,a){const c=2*Math.PI*i/4,d=Math.max(a-2*i,0),h=Math.PI/4;ee.copy(t),ee[o]=0,ee.normalize();const f=.5*c/(c+d),y=1-ee.angleTo(l)/h;return Math.sign(ee[e])===1?y*f:d/(c+d)+f+f*(1-y)}class vt extends Y{constructor(t=1,e=1,o=1,i=2,a=.1){if(i=i*2+1,a=Math.min(t/2,e/2,o/2,a),super(1,1,1,i,i,i),i===1)return;const c=this.toNonIndexed();this.index=null,this.attributes.position=c.attributes.position,this.attributes.normal=c.attributes.normal,this.attributes.uv=c.attributes.uv;const d=new D,h=new D,f=new D(t,e,o).divideScalar(2).subScalar(a),y=this.attributes.position.array,s=this.attributes.normal.array,n=this.attributes.uv.array,r=y.length/6,u=new D,p=.5/i;for(let g=0,m=0;g<y.length;g+=3,m+=2)switch(d.fromArray(y,g),h.copy(d),h.x-=Math.sign(h.x)*p,h.y-=Math.sign(h.y)*p,h.z-=Math.sign(h.z)*p,h.normalize(),y[g+0]=f.x*Math.sign(d.x)+h.x*a,y[g+1]=f.y*Math.sign(d.y)+h.y*a,y[g+2]=f.z*Math.sign(d.z)+h.z*a,s[g+0]=h.x,s[g+1]=h.y,s[g+2]=h.z,Math.floor(g/r)){case 0:u.set(1,0,0),n[m+0]=O(u,h,"z","y",a,o),n[m+1]=1-O(u,h,"y","z",a,e);break;case 1:u.set(-1,0,0),n[m+0]=1-O(u,h,"z","y",a,o),n[m+1]=1-O(u,h,"y","z",a,e);break;case 2:u.set(0,1,0),n[m+0]=1-O(u,h,"x","z",a,t),n[m+1]=O(u,h,"z","x",a,o);break;case 3:u.set(0,-1,0),n[m+0]=1-O(u,h,"x","z",a,t),n[m+1]=1-O(u,h,"z","x",a,o);break;case 4:u.set(0,0,1),n[m+0]=1-O(u,h,"x","y",a,t),n[m+1]=1-O(u,h,"y","x",a,e);break;case 5:u.set(0,0,-1),n[m+0]=O(u,h,"x","y",a,t),n[m+1]=1-O(u,h,"y","x",a,e);break}}}var ae=(l=>(l.IDLE="idle",l.WALK="walk",l.DEATH="death",l.PLACE_BOMB="place_bomb",l.VICTORY="victory",l))(ae||{});const Be=[{suit:16119285,accent:16739125,glass:16766720},{suit:15263976,accent:54527,glass:8900331},{suit:16777215,accent:16724838,glass:16738740},{suit:15790320,accent:65416,glass:10025880},{suit:14737632,accent:11167487,glass:14524637},{suit:16777215,accent:16755200,glass:16766720},{suit:16119285,accent:16729156,glass:16739179},{suit:15263976,accent:4491519,glass:8900346}];class wt{root;helmet;helmetRim;body;backpack;leftArm;rightArm;leftLeg;rightLeg;jetpackFlame;jetpackParticles;suitMaterial;accentMaterial;glassMaterial;backpackMaterial;animationState="idle";animationTime=0;deathProgress=0;isDead=!1;config;baseScale=1;HELMET_RADIUS=.45;BODY_RADIUS=.22;BODY_HEIGHT=.35;LIMB_RADIUS=.08;LIMB_LENGTH=.28;constructor(t={}){const e=Be[t.playerId??0%Be.length];this.config={suitColor:t.suitColor??e.suit,accentColor:t.accentColor??e.accent,glassTint:t.glassTint??e.glass,scale:t.scale??1,playerId:t.playerId??0},this.root=new R,this.root.scale.setScalar(this.config.scale*this.baseScale),this.createMaterials(),this.createGeometry(),this.setupShadows()}createMaterials(){this.suitMaterial=new S({color:this.config.suitColor,roughness:.6,metalness:.1,bumpScale:.02}),this.accentMaterial=new S({color:this.config.accentColor,roughness:.3,metalness:.4,emissive:this.config.accentColor,emissiveIntensity:.1}),this.glassMaterial=new Ve({color:this.config.glassTint,metalness:.1,roughness:.05,transmission:.95,thickness:.5,ior:1.5,clearcoat:1,clearcoatRoughness:.05,envMapIntensity:1.5,transparent:!0,opacity:.3,side:K}),this.backpackMaterial=new S({color:3355443,roughness:.5,metalness:.6})}createGeometry(){this.createHelmet(),this.createBody(),this.createArms(),this.createLegs(),this.createBackpack()}createHelmet(){const t=new R;t.position.y=this.BODY_HEIGHT*.5+this.HELMET_RADIUS*.6;const e=new L(this.HELMET_RADIUS,32,32);this.helmet=new w(e,this.glassMaterial),this.helmet.castShadow=!0,this.helmet.receiveShadow=!0,t.add(this.helmet);const o=new pe(this.HELMET_RADIUS*.85,.04,8,32);this.helmetRim=new w(o,this.accentMaterial),this.helmetRim.rotation.x=Math.PI/2,this.helmetRim.position.y=-this.HELMET_RADIUS*.5,t.add(this.helmetRim);const i=new L(this.HELMET_RADIUS*.7,16,16),a=new B({color:16777215,transparent:!0,opacity:.1,side:ue}),c=new w(i,a);t.add(c),this.root.add(t)}createBody(){const t=new oe(this.BODY_RADIUS,this.BODY_HEIGHT,4,16);this.body=new w(t,this.suitMaterial),this.body.position.y=this.BODY_HEIGHT*.4,this.body.castShadow=!0,this.body.receiveShadow=!0;const e=new oe(this.BODY_RADIUS*.6,this.BODY_HEIGHT*.4,4,12),o=new w(e,this.accentMaterial);o.position.set(0,this.BODY_HEIGHT*.1,this.BODY_RADIUS*.5),o.scale.z=.3,this.body.add(o);const i=new pe(this.BODY_RADIUS*.9,.03,8,24),a=new w(i,this.accentMaterial);a.rotation.x=Math.PI/2,a.position.y=this.BODY_HEIGHT*.45,this.body.add(a),this.root.add(this.body)}createArms(){this.leftArm=this.createLimb(!0),this.leftArm.position.set(this.BODY_RADIUS+this.LIMB_RADIUS,this.BODY_HEIGHT*.6,0),this.root.add(this.leftArm),this.rightArm=this.createLimb(!1),this.rightArm.position.set(-(this.BODY_RADIUS+this.LIMB_RADIUS),this.BODY_HEIGHT*.6,0),this.root.add(this.rightArm)}createLegs(){this.leftLeg=this.createLimb(!0,!0),this.leftLeg.position.set(this.BODY_RADIUS*.4,.05,0),this.root.add(this.leftLeg),this.rightLeg=this.createLimb(!1,!0),this.rightLeg.position.set(-this.BODY_RADIUS*.4,.05,0),this.root.add(this.rightLeg)}createLimb(t,e=!1){const o=new R,i=e?this.LIMB_LENGTH*.9:this.LIMB_LENGTH,a=new oe(this.LIMB_RADIUS,i,4,12),c=new w(a,this.suitMaterial);c.position.y=-i*.5,c.castShadow=!0,c.receiveShadow=!0;const d=new oe(this.LIMB_RADIUS*1.05,i*.3,4,8),h=new w(d,this.accentMaterial);h.position.y=-i*.3,h.scale.set(1,1,.5),c.add(h);const f=new L(this.LIMB_RADIUS*1.3,12,12),y=new w(f,e?this.accentMaterial:this.suitMaterial);return y.position.y=-i*.5,e&&(y.scale.y=.6,y.position.y-=.05),c.add(y),o.add(c),o}createBackpack(){this.backpack=new R,this.backpack.position.set(0,this.BODY_HEIGHT*.5,-this.BODY_RADIUS*.8);const t=new vt(.35,.4,.2,4,.05),e=new w(t,this.backpackMaterial);e.castShadow=!0,this.backpack.add(e);const o=new re(.05,.04,.15,8),i=new w(o,this.accentMaterial);i.position.set(-.1,-.25,-.05),this.backpack.add(i);const a=new w(o,this.accentMaterial);a.position.set(.1,-.25,-.05),this.backpack.add(a),this.jetpackFlame=new He(this.config.accentColor,.5,2),this.jetpackFlame.position.set(0,-.35,-.1),this.backpack.add(this.jetpackFlame),this.jetpackParticles=[];for(let c=0;c<6;c++){const d=new L(.02+Math.random()*.02,6,6),h=new B({color:this.config.accentColor,transparent:!0,opacity:.8}),f=new w(d,h);f.userData={offset:Math.random()*Math.PI*2,speed:.5+Math.random()*.5},this.jetpackParticles.push(f),this.backpack.add(f)}this.root.add(this.backpack)}setupShadows(){this.root.traverse(t=>{t instanceof w&&(t.castShadow=!0,t.receiveShadow=!0)})}update(t){if(!this.isDead){switch(this.animationTime+=t,this.animationState){case"idle":this.animateIdle();break;case"walk":this.animateWalk();break;case"death":this.animateDeath(t);break;case"place_bomb":this.animatePlaceBomb();break;case"victory":this.animateVictory();break}this.animateJetpackParticles(t)}}setAnimationState(t){this.animationState!==t&&(this.animationState=t,this.animationTime=0,t!=="death"&&this.resetPose())}resetPose(){this.root.rotation.set(0,0,0),this.root.position.y=0,this.root.scale.setScalar(this.config.scale*this.baseScale),this.leftArm.rotation.set(0,0,0),this.rightArm.rotation.set(0,0,0),this.leftLeg.rotation.set(0,0,0),this.rightLeg.rotation.set(0,0,0),this.body.rotation.set(0,0,0)}animateIdle(){const t=this.animationTime,e=.03,o=2;this.root.position.y=Math.sin(t*o)*e;const i=1+Math.sin(t*1.5)*.02;this.body.scale.set(i,i,i);const a=Math.sin(t*1.5)*.05;this.leftArm.rotation.z=a+.1,this.rightArm.rotation.z=-a-.1,this.helmet.rotation.x=Math.sin(t*.7)*.02,this.helmet.rotation.y=Math.sin(t*.5)*.03}animateWalk(){const t=this.animationTime,e=8,o=.5,i=.08;this.root.position.y=Math.abs(Math.sin(t*e))*i,this.leftArm.rotation.x=Math.sin(t*e)*o,this.rightArm.rotation.x=Math.sin(t*e+Math.PI)*o,this.leftLeg.rotation.x=Math.sin(t*e+Math.PI)*o,this.rightLeg.rotation.x=Math.sin(t*e)*o,this.body.rotation.z=Math.sin(t*e)*.05,this.helmet.rotation.x=Math.sin(t*e*2)*.03}animateDeath(t){this.deathProgress+=t;const o=Math.min(this.deathProgress/1.5,1),i=5+o*10;this.root.rotation.y+=i*t,this.root.rotation.z=Math.sin(this.deathProgress*3)*.3;const a=(1-o)*this.config.scale*this.baseScale;this.root.scale.setScalar(Math.max(a,.01));const c=1.5;if(o<.3){const d=o/.3;this.root.position.y=d*c}else{const d=(o-.3)/.7;this.root.position.y=c*(1-d)}this.leftArm.rotation.z=Math.sin(this.deathProgress*15)*.8,this.rightArm.rotation.z=Math.cos(this.deathProgress*15)*.8,this.glassMaterial.opacity=.3*(1-o),this.jetpackFlame.intensity=.5+o*2,o>=1&&(this.isDead=!0,this.root.visible=!1)}animatePlaceBomb(){const t=this.animationTime,e=.4;if(t>e){this.setAnimationState("idle");return}const o=t/e,i=Math.sin(o*Math.PI);this.root.position.y=-i*.15,this.leftArm.rotation.x=i*.8,this.rightArm.rotation.x=i*.8,this.leftArm.rotation.z=-i*.3,this.rightArm.rotation.z=i*.3,this.leftLeg.rotation.x=-i*.3,this.rightLeg.rotation.x=-i*.3}animateVictory(){const t=this.animationTime,e=4,o=.3;this.root.position.y=Math.abs(Math.sin(t*e))*o;const i=.5+Math.sin(t*e)*.2;this.leftArm.rotation.z=i,this.rightArm.rotation.z=-i,this.root.rotation.y+=2*.016,this.helmet.rotation.x=Math.sin(t*e*2)*.1}animateJetpackParticles(t){const e=this.animationTime;this.jetpackParticles.forEach((o,i)=>{const a=o.userData,c=(e*a.speed+a.offset)%(Math.PI*2),d=-Math.abs(Math.sin(c))*.3,h=Math.cos(c*2)*.05*(i%2===0?1:-1);o.position.set((i<3?-.1:.1)+h,-.3+d,-.1);const f=1-Math.abs(Math.sin(c));o.material.opacity=f*.8;const y=.5+f*.5;o.scale.setScalar(y)}),this.jetpackFlame.intensity=.5+Math.sin(e*3)*.2}getPosition(){return this.root.position.clone()}setPosition(t,e,o){this.root.position.set(t,e,o)}setRotationY(t){this.root.rotation.y=t}getRotationY(){return this.root.rotation.y}die(){this.isDead||this.setAnimationState("death")}isDeathComplete(){return this.isDead}reset(){this.isDead=!1,this.deathProgress=0,this.animationTime=0,this.root.visible=!0,this.glassMaterial.opacity=.3,this.setAnimationState("idle")}getAnimationState(){return this.animationState}dispose(){this.root.traverse(t=>{t instanceof w&&t.geometry.dispose()}),this.suitMaterial.dispose(),this.accentMaterial.dispose(),this.glassMaterial.dispose(),this.backpackMaterial.dispose()}getBoundingRadius(){return this.HELMET_RADIUS*this.config.scale*this.baseScale}setVisible(t){this.root.visible=t}setEmissiveIntensity(t){this.accentMaterial.emissiveIntensity=.1+t,this.jetpackFlame.intensity=.5+t}flash(t=.2){const e=this.suitMaterial.emissive.clone();this.suitMaterial.emissive.setHex(16777215),this.suitMaterial.emissiveIntensity=.5,setTimeout(()=>{this.suitMaterial.emissive.copy(e),this.suitMaterial.emissiveIntensity=0},t*1e3)}}var _e=(l=>(l.NONE="none",l.RAIN="rain",l.SNOW="snow",l.ASH="ash",l.POLLEN="pollen",l.NEON="neon",l))(_e||{});class Le{scene;currentWeather="none";intensity=.5;enabled=!0;particleCount=2e3;particles=[];splashes=[];particleMesh;splashMesh;dummy=new ge;rainMaterial;snowMaterial;ashMaterial;pollenMaterial;neonMaterial;rainGeo;snowGeo;ashGeo;pollenGeo;neonGeo;splashGeo;snowAccumulation=new Map;accumulationMesh;accumulationDummy=new ge;bounds={minX:-2,maxX:18,minZ:-2,maxZ:18,height:20};fireLight;fireGlowMesh;constructor(t){this.scene=t,this.initializeMaterials(),this.initializeGeometries(),this.initializeParticleMesh(),this.initializeSplashes(),this.initializeAccumulation(),this.initializeFireGlow(),this.initializeParticles()}initializeMaterials(){this.rainMaterial=new B({color:4500223,transparent:!0,opacity:.6,blending:N,depthWrite:!1}),this.snowMaterial=new B({color:16777215,transparent:!0,opacity:.8,blending:N,depthWrite:!1}),this.ashMaterial=new B({color:16729122,transparent:!0,opacity:.9,blending:N,depthWrite:!1}),this.pollenMaterial=new B({color:16777130,transparent:!0,opacity:.7,blending:N,depthWrite:!1}),this.neonMaterial=new B({color:65535,transparent:!0,opacity:.9,blending:N,depthWrite:!1})}initializeGeometries(){this.rainGeo=new re(.01,.01,.8,4),this.rainGeo.translate(0,.4,0),this.snowGeo=new Ae(.08,0),this.ashGeo=new le(.08,.08),this.pollenGeo=new L(.06,6,6),this.neonGeo=new Ae(.05,0),this.splashGeo=new ze(.05,.15,8),this.splashGeo.rotateX(-Math.PI/2)}initializeParticleMesh(){this.particleMesh=new F(this.rainGeo,this.rainMaterial,this.particleCount),this.particleMesh.instanceMatrix.setUsage(ie),this.particleMesh.count=0,this.scene.add(this.particleMesh)}initializeSplashes(){this.splashMesh=new F(this.splashGeo,new B({color:4500223,transparent:!0,opacity:.5,blending:N,depthWrite:!1,side:K}),100),this.splashMesh.instanceMatrix.setUsage(ie),this.splashMesh.count=0,this.scene.add(this.splashMesh)}initializeAccumulation(){this.accumulationMesh=new F(new re(.4,.5,.1,6),new S({color:16777215,transparent:!0,opacity:.6,roughness:.8}),256),this.accumulationMesh.instanceMatrix.setUsage(ie),this.accumulationMesh.count=0,this.accumulationMesh.visible=!1,this.scene.add(this.accumulationMesh)}initializeFireGlow(){this.fireLight=new He(16729122,0,30),this.fireLight.position.set(8,5,8),this.scene.add(this.fireLight);const t=new L(8,32,32);this.fireGlowMesh=new w(t,new B({color:16720384,transparent:!0,opacity:0,blending:N,depthWrite:!1,side:ue})),this.fireGlowMesh.position.set(8,4,8),this.scene.add(this.fireGlowMesh)}initializeParticles(){for(let t=0;t<this.particleCount;t++)this.particles.push({position:new D,velocity:new D,life:0,maxLife:1,size:1,rotation:0,rotationSpeed:0});for(let t=0;t<100;t++)this.splashes.push({position:new D,scale:0,life:0,maxLife:.3})}setWeather(t,e=.5){this.currentWeather===t&&this.intensity===e||(this.currentWeather=t,this.intensity=Math.max(0,Math.min(1,e)),console.log(` WeatherSystem.setWeather: ${t}, intensity: ${this.intensity}`),this.updateWeatherGeometry(),this.resetParticles(),this.updateFireGlow(),this.accumulationMesh.visible=t==="snow",console.log(` Particle mesh count: ${this.particleMesh.count}, enabled: ${this.enabled}`))}setEnabled(t){if(this.enabled=t,!t){this.particleMesh.count=0,this.splashMesh.count=0,this.accumulationMesh.visible=!1,this.fireLight.intensity=0;const e=this.fireGlowMesh.material;e.opacity=0}}setIntensity(t){this.intensity=Math.max(0,Math.min(1,t))}updateWeatherGeometry(){switch(this.scene.remove(this.particleMesh),this.currentWeather){case"rain":this.particleMesh=new F(this.rainGeo,this.rainMaterial,this.particleCount);break;case"snow":this.particleMesh=new F(this.snowGeo,this.snowMaterial,this.particleCount);break;case"ash":this.particleMesh=new F(this.ashGeo,this.ashMaterial,this.particleCount);break;case"pollen":this.particleMesh=new F(this.pollenGeo,this.pollenMaterial,this.particleCount);break;case"neon":this.particleMesh=new F(this.neonGeo,this.neonMaterial,this.particleCount);break;default:this.particleMesh=new F(this.rainGeo,this.rainMaterial,this.particleCount)}this.particleMesh.instanceMatrix.setUsage(ie),this.particleMesh.count=this.enabled&&this.currentWeather!=="none"?Math.floor(this.particleCount*this.intensity):0,this.scene.add(this.particleMesh)}updateFireGlow(){if(this.currentWeather==="ash"){this.fireLight.intensity=2*this.intensity;const t=this.fireGlowMesh.material;t.opacity=.15*this.intensity}else{this.fireLight.intensity=0;const t=this.fireGlowMesh.material;t.opacity=0}}resetParticles(){for(const t of this.particles)this.spawnParticle(t)}spawnParticle(t){const e=this.bounds.minX+Math.random()*(this.bounds.maxX-this.bounds.minX),o=this.bounds.minZ+Math.random()*(this.bounds.maxZ-this.bounds.minZ);let i;switch(this.currentWeather){case"rain":case"snow":case"pollen":i=this.bounds.height;break;case"ash":case"neon":i=Math.random()*5;break;default:i=Math.random()*this.bounds.height}switch(t.position.set(e,i,o),t.life=Math.random(),t.maxLife=1,t.size=.5+Math.random()*.5,t.rotation=Math.random()*Math.PI*2,t.rotationSpeed=(Math.random()-.5)*2,this.currentWeather){case"rain":t.velocity.set((Math.random()-.5)*2,-15-Math.random()*5,(Math.random()-.5)*2);break;case"snow":t.velocity.set((Math.random()-.5)*1,-2-Math.random()*2,(Math.random()-.5)*1);break;case"ash":t.velocity.set((Math.random()-.5)*3,2+Math.random()*3,(Math.random()-.5)*3);break;case"pollen":t.velocity.set((Math.random()-.5)*.5,-.5-Math.random()*.5,(Math.random()-.5)*.5);break;case"neon":t.velocity.set((Math.random()-.5)*1,3+Math.random()*4,(Math.random()-.5)*1);break}}spawnSplash(t,e){for(const o of this.splashes)if(o.life<=0){o.position.set(t,.05,e),o.scale=.1,o.life=o.maxLife;return}}update(t){if(!this.enabled||this.currentWeather==="none")return;const e=Math.min(t,.05),o=Math.floor(this.particleCount*this.intensity);Math.random()<.01&&console.log(` Weather update: ${this.currentWeather}, active particles: ${o}, dt: ${t.toFixed(4)}`);for(let i=0;i<o;i++){const a=this.particles[i];a.position.x+=a.velocity.x*e,a.position.y+=a.velocity.y*e,a.position.z+=a.velocity.z*e,this.currentWeather==="snow"?(a.position.x+=Math.sin(Date.now()*.001+i)*.01,a.position.z+=Math.cos(Date.now()*.0013+i)*.01):this.currentWeather==="pollen"?(a.position.x+=Math.sin(Date.now()*.002+i*.1)*.02,a.position.z+=Math.cos(Date.now()*.0017+i*.1)*.02):this.currentWeather==="ash"&&(a.position.x+=Math.sin(Date.now()*.003+i*.05)*.03,a.position.z+=Math.cos(Date.now()*.0025+i*.05)*.03),a.rotation+=a.rotationSpeed*e,a.life-=e*.5;const c=a.position.x<this.bounds.minX||a.position.x>this.bounds.maxX||a.position.z<this.bounds.minZ||a.position.z>this.bounds.maxZ,d=a.position.y<=0,h=a.position.y>=this.bounds.height;(a.life<=0||c||d||h)&&(this.currentWeather==="rain"&&d&&a.life>0&&this.spawnSplash(a.position.x,a.position.z),this.currentWeather==="snow"&&d&&this.addSnowAccumulation(a.position.x,a.position.z),this.spawnParticle(a)),this.dummy.position.copy(a.position),this.dummy.scale.setScalar(a.size),this.currentWeather==="rain"?this.dummy.lookAt(a.position.x+a.velocity.x,a.position.y+a.velocity.y,a.position.z+a.velocity.z):this.currentWeather==="ash"?this.dummy.rotation.set(0,a.rotation,0):this.dummy.rotation.set(a.rotation,a.rotation*.7,0),this.dummy.updateMatrix(),this.particleMesh.setMatrixAt(i,this.dummy.matrix)}if(this.particleMesh.count=o,this.particleMesh.instanceMatrix.needsUpdate=!0,this.updateSplashes(e),this.currentWeather==="snow"&&this.updateAccumulation(),this.currentWeather==="ash"){const i=.9+Math.random()*.2;this.fireLight.intensity=2*this.intensity*i;const a=this.fireGlowMesh.material;a.opacity=.15*this.intensity*i}}updateSplashes(t){let e=0;for(let o=0;o<this.splashes.length;o++){const i=this.splashes[o];if(i.life>0){i.life-=t;const a=1-i.life/i.maxLife;i.scale=.1+a*.5,this.dummy.position.copy(i.position),this.dummy.scale.set(i.scale,i.scale,i.scale),this.dummy.rotation.x=-Math.PI/2,this.dummy.updateMatrix(),this.splashMesh.setMatrixAt(e++,this.dummy.matrix)}}this.splashMesh.count=e,this.splashMesh.instanceMatrix.needsUpdate=!0}addSnowAccumulation(t,e){const o=`${Math.floor(t)},${Math.floor(e)}`,i=this.snowAccumulation.get(o)||0;this.snowAccumulation.set(o,Math.min(i+.01,.3))}updateAccumulation(){let t=0;for(const[e,o]of this.snowAccumulation)if(o>.01&&t<256){const[i,a]=e.split(",").map(Number);this.accumulationDummy.position.set(i+.5,o/2,a+.5),this.accumulationDummy.scale.set(1,o*3,1),this.accumulationDummy.updateMatrix(),this.accumulationMesh.setMatrixAt(t++,this.accumulationDummy.matrix)}this.accumulationMesh.count=t,this.accumulationMesh.instanceMatrix.needsUpdate=!0}static getWeatherForTheme(t){switch(t){case _.ICE:return"snow";case _.VOLCANO:return"ash";case _.FOREST:return"pollen";case _.SPACE:return"neon";case _.MIAMI_BEACH:return"none";case _.CLASSIC:case _.DESERT:default:return"none"}}dispose(){this.scene.remove(this.particleMesh),this.scene.remove(this.splashMesh),this.scene.remove(this.accumulationMesh),this.scene.remove(this.fireLight),this.scene.remove(this.fireGlowMesh),this.particleMesh.geometry.dispose(),this.splashMesh.geometry.dispose(),this.accumulationMesh.geometry.dispose(),this.fireGlowMesh.geometry.dispose(),this.rainMaterial.dispose(),this.snowMaterial.dispose(),this.ashMaterial.dispose(),this.pollenMaterial.dispose(),this.neonMaterial.dispose(),this.splashMesh.material.dispose(),this.accumulationMesh.material.dispose(),this.fireGlowMesh.material.dispose()}}class Mt{scene;flyingObjects=[];skyMesh=null;cloudMeshes=[];starField=null;currentTheme=_.CLASSIC;spawnTimer=0;spawnInterval=1.5;MAX_OBJECTS=25;SPAWN_DISTANCE=50;DESPAWN_DISTANCE=-50;constructor(t){this.scene=t,this.createSkyDome()}createSkyDome(){const t=new L(100,32,32),e=new Ze({uniforms:{topColor:{value:new ce(30719)},bottomColor:{value:new ce(16777215)},offset:{value:33},exponent:{value:.6}},vertexShader:`
        varying vec3 vWorldPosition;
        void main() {
          vec4 worldPosition = modelMatrix * vec4(position, 1.0);
          vWorldPosition = worldPosition.xyz;
          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
        }
      `,fragmentShader:`
        uniform vec3 topColor;
        uniform vec3 bottomColor;
        uniform float offset;
        uniform float exponent;
        varying vec3 vWorldPosition;
        void main() {
          float h = normalize(vWorldPosition + offset).y;
          gl_FragColor = vec4(mix(bottomColor, topColor, max(pow(max(h, 0.0), exponent), 0.0)), 1.0);
        }
      `,side:ue,depthWrite:!1});this.skyMesh=new w(t,e),this.skyMesh.position.set(v/2,0,v/2),this.skyMesh.renderOrder=-100,this.scene.add(this.skyMesh)}setTheme(t){this.currentTheme=t,this.clearObjects(),this.updateSky(t),this.createClouds(t),this.createStarField(t),this.spawnInterval=this.getSpawnIntervalForTheme(t)}getSpawnIntervalForTheme(t){switch(t){case _.VOLCANO:return .8;case _.SPACE:return .5;case _.DESERT:return 2;default:return 1.2}}updateSky(t){if(!this.skyMesh)return;const e=this.getSkyConfigForTheme(t),o=this.skyMesh.material;o.uniforms.topColor.value.setHex(e.topColor),o.uniforms.bottomColor.value.setHex(e.bottomColor)}getSkyConfigForTheme(t){switch(t){case _.CLASSIC:return{topColor:1710638,bottomColor:1450302,timeOfDay:"night",cloudDensity:.3,starDensity:.8};case _.ICE:return{topColor:8900331,bottomColor:14743551,timeOfDay:"day",cloudDensity:.7,starDensity:0};case _.VOLCANO:return{topColor:1706496,bottomColor:4856320,timeOfDay:"dusk",cloudDensity:.9,starDensity:0};case _.FOREST:return{topColor:2263842,bottomColor:9498256,timeOfDay:"day",cloudDensity:.5,starDensity:0};case _.DESERT:return{topColor:16747520,bottomColor:16766720,timeOfDay:"dusk",cloudDensity:.2,starDensity:0};case _.SPACE:return{topColor:17,bottomColor:34,timeOfDay:"night",cloudDensity:0,starDensity:1};case _.MIAMI_BEACH:return{topColor:16739229,bottomColor:16752762,timeOfDay:"dusk",cloudDensity:.4,starDensity:0};default:return{topColor:30719,bottomColor:11197951,timeOfDay:"day",cloudDensity:.5,starDensity:0}}}createClouds(t){this.cloudMeshes.forEach(d=>this.scene.remove(d)),this.cloudMeshes=[];const e=this.getSkyConfigForTheme(t);if(e.cloudDensity===0)return;const o=Math.floor(15*e.cloudDensity),i=new L(3,8,8);let a=16777215;if(t===_.VOLCANO&&(a=3355443),t===_.SPACE)return;const c=new B({color:a,transparent:!0,opacity:.6});for(let d=0;d<o;d++){const h=new R;for(let f=0;f<5;f++){const y=new w(i,c);y.position.set((Math.random()-.5)*4,(Math.random()-.5)*1.5,(Math.random()-.5)*2),y.scale.setScalar(.5+Math.random()*.5),h.add(y)}h.position.set(Math.random()*80-40,15+Math.random()*20,-20-Math.random()*30),this.scene.add(h),this.cloudMeshes.push(h)}}createStarField(t){this.starField&&(this.scene.remove(this.starField),this.starField=null);const e=this.getSkyConfigForTheme(t);if(e.starDensity===0)return;const o=Math.floor(500*e.starDensity),i=new Float32Array(o*3);for(let d=0;d<o;d++){const h=Math.random()*Math.PI*2,f=Math.random()*Math.PI*.5,y=80;i[d*3]=y*Math.sin(f)*Math.cos(h)+v/2,i[d*3+1]=y*Math.cos(f),i[d*3+2]=y*Math.sin(f)*Math.sin(h)+v/2}const a=new Ne;a.setAttribute("position",new $e(i,3));const c=new Ue({color:16777215,size:.3,transparent:!0,opacity:.8});this.starField=new We(a,c),this.scene.add(this.starField)}update(t){this.spawnTimer+=t,this.spawnTimer>=this.spawnInterval&&this.flyingObjects.length<this.MAX_OBJECTS&&(this.spawnTimer=0,this.spawnObject());for(let e=this.flyingObjects.length-1;e>=0;e--){const o=this.flyingObjects[e];o.mesh.position.add(o.velocity.clone().multiplyScalar(t)),o.mesh.rotation.x+=o.rotationSpeed.x*t,o.mesh.rotation.y+=o.rotationSpeed.y*t,o.mesh.rotation.z+=o.rotationSpeed.z*t,(o.mesh.position.z>v+30||o.mesh.position.z<-50)&&(this.scene.remove(o.mesh),this.flyingObjects.splice(e,1))}if(this.cloudMeshes.forEach((e,o)=>{e.position.x+=t*2*(.5+o%3*.3),e.position.x>60&&(e.position.x=-60)}),this.starField){const e=this.starField.material;e.opacity=.6+Math.sin(Date.now()*.003)*.2}}spawnObject(){const t=this.getRandomObjectForTheme(this.currentTheme);if(!t)return;const e=this.createObjectMesh(t),o=v/2+(Math.random()-.5)*40,i=5+Math.random()*15,a=-this.SPAWN_DISTANCE;e.position.set(o,i,a);const c=15+Math.random()*25,d=new D((Math.random()-.5)*5,(Math.random()-.5)*2,c),h=new D((Math.random()-.5)*3,(Math.random()-.5)*3,(Math.random()-.5)*3);this.flyingObjects.push({mesh:e,velocity:d,rotationSpeed:h,type:t.type}),this.scene.add(e)}getRandomObjectForTheme(t){const e=[];switch(t){case _.CLASSIC:e.push({type:"crate",color:9127187,geometry:"box"},{type:"barrel",color:4473924,geometry:"sphere"},{type:"debris",color:6710886,geometry:"box"});break;case _.ICE:e.push({type:"snowball",color:16777215,geometry:"sphere"},{type:"iceberg",color:8965375,geometry:"box"},{type:"penguin",color:1118481,geometry:"sphere"},{type:"icicle",color:11197951,geometry:"cone"});break;case _.VOLCANO:e.push({type:"lavaRock",color:16729088,geometry:"sphere"},{type:"ash",color:3355443,geometry:"sphere"},{type:"ember",color:16737792,geometry:"sphere"},{type:"boulder",color:4861984,geometry:"box"});break;case _.FOREST:e.push({type:"leaf",color:2263842,geometry:"sphere"},{type:"bird",color:16737792,geometry:"cone"},{type:"acorn",color:9127187,geometry:"sphere"},{type:"butterfly",color:16738740,geometry:"box"});break;case _.DESERT:e.push({type:"tumbleweed",color:12886874,geometry:"sphere"},{type:"sand",color:16766720,geometry:"sphere"},{type:"cactus",color:2263842,geometry:"cone"},{type:"vulture",color:3355443,geometry:"cone"});break;case _.SPACE:e.push({type:"asteroid",color:6710886,geometry:"sphere"},{type:"satellite",color:13421772,geometry:"box"},{type:"meteor",color:16729088,geometry:"sphere"},{type:"alien",color:65280,geometry:"sphere"},{type:"spacejunk",color:8947848,geometry:"torus"});break;case _.MIAMI_BEACH:e.push({type:"beachball",color:16739229,geometry:"sphere"},{type:"seagull",color:16777215,geometry:"cone"},{type:"coconut",color:9127187,geometry:"sphere"},{type:"surfboard",color:49151,geometry:"box"},{type:"flamingo",color:16738740,geometry:"cone"});break;default:e.push({type:"cow",color:16777215,geometry:"box"},{type:"car",color:16711680,geometry:"box"},{type:"house",color:8930338,geometry:"box"},{type:"tree",color:2263842,geometry:"cone"})}return e.length===0?null:e[Math.floor(Math.random()*e.length)]}createObjectMesh(t){const e=new R;let o;const i=.5+Math.random()*1.5;switch(t.geometry){case"sphere":o=new L(i,12,12);break;case"cone":o=new be(i*.6,i*1.5,8);break;case"torus":o=new pe(i,i*.3,8,16);break;case"box":default:o=new Y(i,i,i)}const a=new S({color:t.color,emissive:t.color,emissiveIntensity:.1,roughness:.7}),c=new w(o,a);if(c.castShadow=!0,e.add(c),t.type==="meteor"||t.type==="ember"||t.type==="lavaRock"){const d=new B({color:t.color,transparent:!0,opacity:.4}),h=new w(o.clone(),d);h.scale.setScalar(1.3),e.add(h)}return e}clearObjects(){this.flyingObjects.forEach(t=>this.scene.remove(t.mesh)),this.flyingObjects=[]}dispose(){this.clearObjects(),this.cloudMeshes.forEach(t=>this.scene.remove(t)),this.cloudMeshes=[],this.skyMesh&&(this.scene.remove(this.skyMesh),this.skyMesh=null),this.starField&&(this.scene.remove(this.starField),this.starField=null)}}class St{scene;enemyMeshes=new Map;enemyColors={[k.BASIC]:16729156,[k.FAST]:16746496,[k.SMART]:8930559,[k.TANK]:4473924};constructor(t){this.scene=t}syncEnemies(t,e){const o=new Set(t.map(i=>i.id));for(const[i,a]of this.enemyMeshes)o.has(i)||(this.scene.remove(a),this.enemyMeshes.delete(i));for(const i of t){let a=this.enemyMeshes.get(i.id);if(a||(a=this.createEnemyMesh(i.type),this.scene.add(a),this.enemyMeshes.set(i.id,a)),a.position.x=i.worldPos.x,a.position.z=i.worldPos.y,a.position.y=.4+Math.sin(Date.now()*.005+i.id)*.1,i.moveDir!==0){let d=0;switch(i.moveDir){case 1:d=0;break;case 2:d=Math.PI;break;case 3:d=-Math.PI/2;break;case 4:d=Math.PI/2;break}a.rotation.y=Qe.lerp(a.rotation.y,d,.1)}const c=1+Math.sin(Date.now()*.008+i.id*.5)*.05;a.scale.setScalar(c)}}createEnemyMesh(t){const e=new R,o=this.enemyColors[t]||16729156,i=new L(.35,16,16),a=new S({color:o,emissive:o,emissiveIntensity:.3,roughness:.3,metalness:.5}),c=new w(i,a);c.castShadow=!0,e.add(c);const d=new L(.08,8,8),h=new B({color:16777215}),f=new L(.04,8,8),y=new B({color:0}),s=new w(d,h);s.position.set(-.12,.1,.28);const n=new w(f,y);n.position.set(0,0,.05),s.add(n),e.add(s);const r=new w(d,h);r.position.set(.12,.1,.28);const u=new w(f,y);u.position.set(0,0,.05),r.add(u),e.add(r);const p=new Y(.15,.03,.03),g=new B({color:0}),m=new w(p,g);m.position.set(-.12,.2,.3),m.rotation.z=-.3,e.add(m);const b=new w(p,g);switch(b.position.set(.12,.2,.3),b.rotation.z=.3,e.add(b),t){case k.FAST:for(let U=0;U<3;U++){const A=new w(new be(.05,.2,4),new S({color:16776960,emissive:16776960,emissiveIntensity:.5}));A.position.set(-.3-U*.1,0,0),A.rotation.z=Math.PI/2,e.add(A)}break;case k.SMART:const V=new w(new L(.15,8,8),new S({color:16746751,emissive:16746751,emissiveIntensity:.3}));V.position.y=.35,e.add(V);break;case k.TANK:const $=new w(new Y(.6,.4,.6),new S({color:6710886,roughness:.2,metalness:.8}));$.position.y=0,e.add($);break}const M=new Je(.4,16),E=new B({color:o,transparent:!0,opacity:.3,side:K}),G=new w(M,E);return G.rotation.x=-Math.PI/2,G.position.y=-.35,e.add(G),e}removeEnemy(t){const e=this.enemyMeshes.get(t);e&&(this.scene.remove(e),this.enemyMeshes.delete(t))}dispose(){for(const t of this.enemyMeshes.values())this.scene.remove(t);this.enemyMeshes.clear()}}class xt{scene;assets;animationMixers=[];waterMesh;palmTrees=[];breezeParticles;time=0;textureCache=new Map;constructor(t){console.log("[MiamiBeachTheme]  Constructor called"),this.scene=t,this.assets=this.createAssets(),console.log("[MiamiBeachTheme]  Assets created:",Object.keys(this.assets)),this.setupEnvironment(),this.createDecorations(),console.log("[MiamiBeachTheme]  Theme setup complete. Scene children count:",this.scene.children.length)}createSandTexture(){const t=document.createElement("canvas");t.width=1024,t.height=1024;const e=t.getContext("2d"),o=e.createLinearGradient(0,0,1024,1024);o.addColorStop(0,"#e8c98f"),o.addColorStop(.3,"#f5deb3"),o.addColorStop(.5,"#e8c98f"),o.addColorStop(.7,"#deb887"),o.addColorStop(1,"#e8c98f"),e.fillStyle=o,e.fillRect(0,0,1024,1024),e.strokeStyle="#d4a574",e.lineWidth=2;for(let d=0;d<40;d++){e.beginPath();const h=Math.random()*1024;e.moveTo(0,h);for(let f=0;f<=1024;f+=50)e.lineTo(f,h+Math.sin(f*.02)*20+Math.random()*10);e.stroke()}const i=e.getImageData(0,0,1024,1024),a=i.data;for(let d=0;d<a.length;d+=4){const h=(Math.random()-.5)*15;a[d]+=h,a[d+1]+=h,a[d+2]+=h}e.putImageData(i,0,0),e.fillStyle="#fff8dc";for(let d=0;d<200;d++){const h=Math.random()*1024,f=Math.random()*1024,y=Math.random()*2;e.beginPath(),e.arc(h,f,y,0,Math.PI*2),e.fill()}const c=new Z(t);return c.wrapS=te,c.wrapT=te,c.repeat.set(4,4),c.anisotropy=16,c}createWaterNormalMap(){const t=document.createElement("canvas");t.width=512,t.height=512;const e=t.getContext("2d"),o=e.createImageData(512,512),i=o.data;for(let c=0;c<512;c++)for(let d=0;d<512;d++){const h=(c*512+d)*4,f=Math.sin(d*.05+c*.03)*127+128,y=Math.sin(d*.08-c*.05)*64;i[h]=f+y,i[h+1]=200,i[h+2]=255,i[h+3]=255}e.putImageData(o,0,0);const a=new Z(t);return a.wrapS=te,a.wrapT=te,a}createSkyGradient(){const t=document.createElement("canvas");t.width=1,t.height=1024;const e=t.getContext("2d"),o=e.createLinearGradient(0,0,0,1024);return o.addColorStop(0,"#ff6b9d"),o.addColorStop(.2,"#ff8c69"),o.addColorStop(.4,"#ffa500"),o.addColorStop(.6,"#ff7f50"),o.addColorStop(.8,"#9370db"),o.addColorStop(1,"#4b0082"),e.fillStyle=o,e.fillRect(0,0,1,1024),new Z(t)}createWoodTexture(){const t=document.createElement("canvas");t.width=512,t.height=512;const e=t.getContext("2d");e.fillStyle="#8b7355",e.fillRect(0,0,512,512),e.strokeStyle="#6b5344",e.lineWidth=3;for(let i=0;i<50;i++){e.beginPath();const a=Math.random()*512;e.moveTo(a,0),e.lineTo(a+(Math.random()-.5)*50,512),e.stroke()}e.fillStyle="rgba(100, 90, 80, 0.3)";for(let i=0;i<100;i++)e.beginPath(),e.arc(Math.random()*512,Math.random()*512,Math.random()*20,0,Math.PI*2),e.fill();return new Z(t)}createCoralTexture(){const t=document.createElement("canvas");t.width=512,t.height=512;const e=t.getContext("2d"),o=e.createRadialGradient(256,256,0,256,256,300);o.addColorStop(0,"#ff7f7f"),o.addColorStop(.5,"#ff6b6b"),o.addColorStop(1,"#cd5c5c"),e.fillStyle=o,e.fillRect(0,0,512,512),e.fillStyle="rgba(255, 200, 200, 0.4)";for(let a=0;a<200;a++){const c=Math.random()*512,d=Math.random()*512,h=Math.random()*8+2;e.beginPath(),e.arc(c,d,h,0,Math.PI*2),e.fill()}e.strokeStyle="rgba(80, 40, 40, 0.6)",e.lineWidth=2;for(let a=0;a<15;a++){e.beginPath();let c=Math.random()*512,d=Math.random()*512;e.moveTo(c,d);for(let h=0;h<5;h++)c+=(Math.random()-.5)*50,d+=(Math.random()-.5)*50,e.lineTo(c,d);e.stroke()}return new Z(t)}createAssets(){const t=this.createSandTexture(),e=new S({map:t,roughness:.9,metalness:0,bumpMap:t,bumpScale:.02}),o=this.createCoralTexture(),i=new S({map:o,roughness:.8,metalness:.1,bumpMap:o,bumpScale:.05}),a=this.createWoodTexture(),c=new S({map:a,roughness:.7,metalness:0,bumpMap:a,bumpScale:.03}),d=this.createWaterNormalMap(),h=new Ve({color:4251856,transparent:!0,opacity:.8,roughness:.05,metalness:.1,transmission:.3,thickness:1,normalMap:d,normalScale:new et(.5,.5),envMapIntensity:1,clearcoat:1,clearcoatRoughness:.1}),f=new S({color:9127187,roughness:.9,metalness:0}),y=new S({color:2263842,roughness:.6,metalness:0,side:K}),s=new S({color:16716947,emissive:16711782,emissiveIntensity:.2,roughness:.4,metalness:.3}),n=new S({color:65535,emissive:34986,emissiveIntensity:.1,roughness:.2,metalness:.4});return{floorMaterial:e,hardBlockMaterial:i,softBlockMaterial:c,waterMaterial:h,palmTrunkMaterial:f,palmLeafMaterial:y,umbrellaMaterial:s,surfboardMaterial:n,skyGradient:this.createSkyGradient()}}setupEnvironment(){console.log("[MiamiBeachTheme]  Setting up environment...");const t=this.scene.children.filter(y=>y instanceof ye).length;this.scene.children.filter(y=>y instanceof ye).forEach(y=>this.scene.remove(y)),console.log(`[MiamiBeachTheme]  Removed ${t} existing lights`);const e=new ve(16755319,.4);this.scene.add(e);const o=new se(16746564,1.2);o.position.set(20,15,-20),o.castShadow=!0,o.shadow.mapSize.set(2048,2048),o.shadow.camera.near=.5,o.shadow.camera.far=100,o.shadow.camera.left=-30,o.shadow.camera.right=30,o.shadow.camera.top=30,o.shadow.camera.bottom=-30,o.shadow.bias=-.001,this.scene.add(o);const i=new se(16716947,.6);i.position.set(-20,10,20),this.scene.add(i);const a=new se(9662683,.3);a.position.set(0,5,20),this.scene.add(a),this.scene.fog=new tt(16755336,.015),console.log("[MiamiBeachTheme]  Fog added");const c=new L(80,32,32),d=new B({map:this.assets.skyGradient,side:ue}),h=new w(c,d);h.name="miami_sky",h.userData.isThemeDecoration=!0,this.scene.add(h),console.log("[MiamiBeachTheme]  Sky sphere added");const f=new le(120,120,64,64);this.waterMesh=new w(f,this.assets.waterMaterial),this.waterMesh.rotation.x=-Math.PI/2,this.waterMesh.position.y=-.5,this.waterMesh.name="miami_water",this.waterMesh.userData.isThemeDecoration=!0,this.scene.add(this.waterMesh),console.log("[MiamiBeachTheme]  Water plane added at y=-0.5")}createDecorations(){console.log("[MiamiBeachTheme]  Creating decorations..."),this.createPalmTrees(),this.createBreezeParticles(),console.log(`[MiamiBeachTheme]  Decorations complete. Palm trees: ${this.palmTrees.length}`)}createPalmTrees(){[{x:-5,z:-5,scale:1.2,rotation:.3},{x:20,z:-3,scale:1,rotation:-.2},{x:-3,z:18,scale:1.1,rotation:.1},{x:19,z:19,scale:.9,rotation:-.3},{x:8,z:-6,scale:1.3,rotation:0},{x:-6,z:8,scale:1,rotation:.4}].forEach((e,o)=>{const i=new R;i.position.set(e.x,0,e.z),i.rotation.y=e.rotation,i.scale.setScalar(e.scale),i.userData.isThemeDecoration=!0;const a=new st([new D(0,0,0),new D(.2,1.5,0),new D(.5,3,.1),new D(.8,4,.2)]),c=new ot(a,8,.15,8,!1),d=new w(c,this.assets.palmTrunkMaterial);d.castShadow=!0,i.add(d);const h=new R;h.position.set(.8,4,.2);const f=7;for(let y=0;y<f;y++){const s=this.createPalmFrond(y/f*Math.PI*2);s.rotation.y=y/f*Math.PI*2,h.add(s)}i.add(h),this.palmTrees.push(h),this.scene.add(i)})}createPalmFrond(t){const e=new Te;e.moveTo(0,0),e.quadraticCurveTo(.3,1,0,2),e.quadraticCurveTo(-.3,1,0,0);const o={depth:.02,bevelEnabled:!1},i=new ke(e,o),a=new w(i,this.assets.palmLeafMaterial);return a.position.set(0,0,0),a.rotation.x=Math.PI/4,a.scale.set(.8,.8,.8),a.castShadow=!0,a}createBreezeParticles(){const e=new Ne,o=new Float32Array(300),i=[];for(let c=0;c<100;c++)o[c*3]=(Math.random()-.5)*30,o[c*3+1]=Math.random()*10,o[c*3+2]=(Math.random()-.5)*30,i.push((Math.random()-.5)*.02,(Math.random()-.5)*.01,(Math.random()-.5)*.02);e.setAttribute("position",new $e(o,3));const a=new Ue({color:16777198,size:.05,transparent:!0,opacity:.4,blending:N});this.breezeParticles=new We(e,a),this.breezeParticles.userData={velocities:i,isThemeDecoration:!0},this.scene.add(this.breezeParticles)}addBeachDecorations(){this.addBeachUmbrellas(),this.addSurfboards()}addBeachUmbrellas(){[{x:-3,z:8},{x:20,z:10},{x:10,z:-4}].forEach(e=>{const o=new R;o.position.set(e.x,0,e.z),o.userData.isThemeDecoration=!0;const i=new re(.03,.03,2.5,8),a=new S({color:16777215}),c=new w(i,a);c.position.y=1.25,c.castShadow=!0,o.add(c);const d=new be(1.5,.8,8),h=new w(d,this.assets.umbrellaMaterial);h.position.y=2.3,h.castShadow=!0,o.add(h);const f=new ze(1.4,1.5,8),y=new B({color:16716947,transparent:!0,opacity:.3,side:K}),s=new w(f,y);s.rotation.x=-Math.PI/2,s.position.y=2.3,o.add(s),this.scene.add(o)})}addSurfboards(){[{x:-4,z:5,rot:.5,color:65535},{x:21,z:15,rot:-.3,color:16711935}].forEach(e=>{const o=new R;o.position.set(e.x,.4,e.z),o.rotation.y=e.rot,o.userData.isThemeDecoration=!0;const i=new Te;i.moveTo(0,-1.2),i.bezierCurveTo(.3,-1.2,.35,0,.35,.8),i.bezierCurveTo(.35,1.2,0,1.5,0,1.5),i.bezierCurveTo(0,1.5,-.35,1.2,-.35,.8),i.bezierCurveTo(-.35,0,-.3,-1.2,0,-1.2);const a={depth:.08,bevelEnabled:!0,bevelThickness:.02,bevelSize:.02,bevelSegments:2},c=new ke(i,a),d=new w(c,this.assets.surfboardMaterial);d.rotation.x=Math.PI/2,d.position.y=0,d.castShadow=!0,o.add(d),this.scene.add(o)})}update(t){if(this.time+=t,this.waterMesh){const e=this.waterMesh.geometry.attributes.position.array;for(let o=0;o<e.length;o+=3){const i=e[o],a=e[o+1];e[o+2]=Math.sin(i*.3+this.time)*.1+Math.cos(a*.2+this.time*.8)*.1}this.waterMesh.geometry.attributes.position.needsUpdate=!0,this.waterMesh.geometry.computeVertexNormals()}if(this.palmTrees.forEach((e,o)=>{const i=Math.sin(this.time*.5+o)*.05;e.rotation.z=i,e.rotation.x=Math.cos(this.time*.3+o)*.03}),this.breezeParticles){const e=this.breezeParticles.geometry.attributes.position.array,o=this.breezeParticles.userData.velocities;for(let i=0;i<e.length/3;i++)e[i*3]+=o[i*3]+Math.sin(this.time+i)*.001,e[i*3+1]+=o[i*3+1],e[i*3+2]+=o[i*3+2]+Math.cos(this.time+i)*.001,e[i*3+1]>10&&(e[i*3+1]=0),e[i*3]>15&&(e[i*3]=-15),e[i*3]<-15&&(e[i*3]=15),e[i*3+2]>15&&(e[i*3+2]=-15),e[i*3+2]<-15&&(e[i*3+2]=15);this.breezeParticles.geometry.attributes.position.needsUpdate=!0}}getMaterials(){return console.log("[MiamiBeachTheme]  getMaterials() called"),{floor:this.assets.floorMaterial,hardBlock:this.assets.hardBlockMaterial,softBlock:this.assets.softBlockMaterial}}dispose(){this.textureCache.forEach(t=>t.dispose()),Object.values(this.assets).forEach(t=>{(t instanceof Ye||t instanceof it)&&t.dispose()})}}class At{scene;currentTheme=null;defaultMaterials;constructor(t){this.scene=t,this.defaultMaterials=this.createDefaultMaterials()}createDefaultMaterials(){return{floor:new S({color:2763306,roughness:.8}),hardBlock:new S({color:5592405,roughness:.7}),softBlock:new S({color:9136404,roughness:.6})}}loadTheme(t){switch(console.log(`[ThemeManager]  loadTheme() called with theme: ${t}`),this.cleanup(),t){case _.MIAMI_BEACH:console.log("[ThemeManager]  Creating Miami Beach theme..."),this.currentTheme=this.createMiamiBeachTheme();break;case _.CLASSIC:case _.ICE:case _.VOLCANO:case _.FOREST:case _.DESERT:case _.SPACE:default:this.currentTheme=this.createDefaultTheme(t);break}}createMiamiBeachTheme(){console.log("[ThemeManager]  createMiamiBeachTheme() called");const t=new xt(this.scene);t.addBeachDecorations();const e=t.getMaterials();return console.log("[ThemeManager]  Miami Beach theme created. Materials:",Object.keys(e)),{name:_.MIAMI_BEACH,instance:t,materials:e}}createDefaultTheme(t){const e=this.getThemeColors(t);this.scene.background=new ce(e.background),this.scene.fog=null;const o={floor:new S({color:e.floor,roughness:.8}),hardBlock:new S({color:6710886,roughness:.7}),softBlock:new S({color:e.accent,roughness:.6})};return this.setupBasicLighting(e),{name:t,instance:null,materials:o}}setupBasicLighting(t){this.scene.children.filter(i=>i instanceof ye).forEach(i=>this.scene.remove(i));const e=new ve(16777215,.4);this.scene.add(e);const o=new se(t.accent,.8);o.position.set(10,15,10),o.castShadow=!0,o.shadow.mapSize.set(1024,1024),this.scene.add(o)}getThemeColors(t){switch(t){case _.ICE:return{background:662058,floor:2771562,accent:8965375};case _.VOLCANO:return{background:1706506,floor:4860458,accent:16737860};case _.FOREST:return{background:662026,floor:2771498,accent:6750088};case _.DESERT:return{background:1710602,floor:6969914,accent:16764006};case _.SPACE:return{background:328976,floor:2763338,accent:11176191};case _.CLASSIC:default:return{background:657930,floor:2763306,accent:43775}}}update(t){this.currentTheme?.instance&&this.currentTheme.instance.update(t)}getMaterials(){const t=this.currentTheme?.materials??this.defaultMaterials;return console.log(`[ThemeManager]  getMaterials() returning materials for theme: ${this.currentTheme?.name??"default"}`),t}getCurrentTheme(){return this.currentTheme?.name??null}hasActiveEffects(){return this.currentTheme?.instance!==null}cleanup(){this.currentTheme?.instance&&this.currentTheme.instance.dispose();const t=[];this.scene.traverse(e=>{e.userData.isThemeDecoration&&t.push(e)}),t.forEach(e=>{e.parent&&e.parent.remove(e)}),this.currentTheme=null}dispose(){this.cleanup(),Object.values(this.defaultMaterials).forEach(t=>t.dispose())}}class we{scene;camera;renderer;floorMesh;hardBlockPool;softBlockPool;astronautCharacters=[];bombMeshes=new Map;explosionMeshes=[];powerUpMeshes=[];matFloor;matHard;matSoft;matBomb=new S({color:1118481});matBombPrimed=new S({color:3359999,emissive:1122986});matBombRushed=new S({color:16720418,emissive:11145489});matExplosion=new S({color:16737792,emissive:16729088,transparent:!0,opacity:.85});matPowerUp=new S({color:4521796,emissive:2271778});themeManager;scrollingBackgrounds=[];backgroundSpeed=.02;backgroundOffset=0;geoBlock=new Y(Q*.95,Q*.95,Q*.95);geoBomb=new L(.7,16,16);geoExplosion=new Y(Q*.9,.3,Q*.9);geoPowerUp=new Y(.4,.4,.4);dummy=new ge;weatherSystem;currentTheme=_.CLASSIC;flyingObjectsSystem;enemyRenderer;lastFrameTime=0;frameDeltaTime=.016;constructor(){this.scene=new nt,this.scene.background=new ce(657930),this.themeManager=new At(this.scene),this.matFloor=new S({color:2763306}),this.matHard=new S({color:5592405}),this.matSoft=new S({color:9136404});const t=(v-1)/2;this.camera=new at(60,window.innerWidth/window.innerHeight,.1,200),this.camera.position.set(t,22,t+16),this.camera.lookAt(t,0,t);try{this.renderer=new rt({antialias:!0})}catch(d){throw we.showWebGLError(),new Error("WebGL initialization failed: "+(d instanceof Error?d.message:String(d)))}this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=lt,document.body.appendChild(this.renderer.domElement);const e=new ve(16777215,.4);this.scene.add(e);const o=new se(16777215,.8);o.position.set(t+5,15,t-5),o.castShadow=!0,o.shadow.mapSize.set(1024,1024),o.shadow.camera.near=1,o.shadow.camera.far=40;const i=v;o.shadow.camera.left=-i,o.shadow.camera.right=i,o.shadow.camera.top=i,o.shadow.camera.bottom=-i,this.scene.add(o);const a=new le(v,v);this.floorMesh=new w(a,this.matFloor),this.floorMesh.rotation.x=-Math.PI/2,this.floorMesh.position.set(t,-.01,t),this.floorMesh.receiveShadow=!0,this.scene.add(this.floorMesh);const c=v*v;this.hardBlockPool=new F(this.geoBlock,this.matHard,c),this.hardBlockPool.castShadow=!0,this.hardBlockPool.receiveShadow=!0,this.scene.add(this.hardBlockPool),this.softBlockPool=new F(this.geoBlock,this.matSoft,c),this.softBlockPool.castShadow=!0,this.softBlockPool.receiveShadow=!0,this.scene.add(this.softBlockPool),window.addEventListener("resize",()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}),this.weatherSystem=new Le(this.scene),this.flyingObjectsSystem=new Mt(this.scene),this.enemyRenderer=new St(this.scene)}syncState(t,e,o=.016){let i=0,a=0;for(let c=0;c<v;c++)for(let d=0;d<v;d++){const h=t.grid[c][d];h===P.HardBlock?(this.dummy.position.set(d,.475,c),this.dummy.updateMatrix(),this.hardBlockPool.setMatrixAt(i++,this.dummy.matrix)):h===P.SoftBlock&&(this.dummy.position.set(d,.475,c),this.dummy.updateMatrix(),this.softBlockPool.setMatrixAt(a++,this.dummy.matrix))}this.hardBlockPool.count=i,this.hardBlockPool.instanceMatrix.needsUpdate=!0,this.softBlockPool.count=a,this.softBlockPool.instanceMatrix.needsUpdate=!0,this.syncPlayers(t,o),this.syncBombs(t),this.syncExplosions(t),this.syncPowerUps(t),this.animateBackground(o)}animateBackground(t){this.scrollingBackgrounds.length>=2&&(this.backgroundOffset+=this.backgroundSpeed*t*60,this.scrollingBackgrounds.forEach((e,o)=>{const i=(this.backgroundOffset+o*45)%90-22.5;e.position.x=(v-1)/2+i;const a=Date.now()*.001;e.position.y=8+Math.sin(a+o)*.2,e.rotation.z=Math.sin(a*.5+o)*.02}))}syncPlayers(t,e){for(;this.astronautCharacters.length<t.players.length;){const o=this.astronautCharacters.length,i=new wt({playerId:o,scale:1.3});this.scene.add(i.root),this.astronautCharacters.push(i)}for(let o=0;o<this.astronautCharacters.length;o++){const i=this.astronautCharacters[o];if(o<t.players.length){const a=t.players[o];if(a.alive){if(i.setVisible(!0),i.setPosition(a.worldPos.x,0,a.worldPos.y),a.moveDir!==0){i.setAnimationState(ae.WALK);let c=0;switch(a.moveDir){case 1:c=0;break;case 2:c=Math.PI;break;case 3:c=-Math.PI/2;break;case 4:c=Math.PI/2;break}i.setRotationY(c)}else i.setAnimationState(ae.IDLE);i.update(e)}else i.getAnimationState()!==ae.DEATH&&!i.isDeathComplete()&&i.die(),i.update(e),i.isDeathComplete()&&i.setVisible(!1)}else i.setVisible(!1)}}syncBombs(t){const e=new Set(t.bombs.map(o=>o.id));for(const[o,i]of this.bombMeshes)e.has(o)||(this.scene.remove(i),this.bombMeshes.delete(o));for(const o of t.bombs){let i=this.bombMeshes.get(o.id);if(!i){const c=o.primed?this.matBombPrimed:o.rushed?this.matBombRushed:this.matBomb;i=new w(this.geoBomb,c),i.castShadow=!0,this.scene.add(i),this.bombMeshes.set(o.id,i)}i.position.set(o.gridPos.col,.5,o.gridPos.row);const a=1+.15*Math.sin(Date.now()*.01*(o.rushed?4:o.primed?1:2));i.scale.setScalar(a)}}syncExplosions(t){for(;this.explosionMeshes.length>t.explosions.length;){const e=this.explosionMeshes.pop();this.scene.remove(e)}for(let e=0;e<t.explosions.length;e++){let o=this.explosionMeshes[e];o||(o=new w(this.geoExplosion,this.matExplosion.clone()),o.castShadow=!1,this.scene.add(o),this.explosionMeshes.push(o));const i=t.explosions[e];o.position.set(i.gridPos.col,.15,i.gridPos.row),o.material.opacity=Math.min(1,i.remaining*2)}}syncPowerUps(t){for(;this.powerUpMeshes.length>t.powerUps.length;){const e=this.powerUpMeshes.pop();this.scene.remove(e)}for(let e=0;e<t.powerUps.length;e++){let o=this.powerUpMeshes[e];o||(o=new w(this.geoPowerUp,this.matPowerUp),this.scene.add(o),this.powerUpMeshes.push(o));const i=t.powerUps[e];o.position.set(i.gridPos.col,.3+.1*Math.sin(Date.now()*.003),i.gridPos.row),o.rotation.y+=.02}}frameCount=0;render(t){const e=performance.now();this.lastFrameTime>0&&(this.frameDeltaTime=Math.min((e-this.lastFrameTime)/1e3,.05)),this.lastFrameTime=e,this.weatherSystem.update(this.frameDeltaTime),this.themeManager.update(this.frameDeltaTime),this.flyingObjectsSystem.update(this.frameDeltaTime),this.frameCount++,this.frameCount%60===0&&console.log(`[SceneManager]  Frame ${this.frameCount}, Scene children: ${this.scene.children.length}, Current theme: ${this.currentTheme}`),this.renderer.render(this.scene,this.camera)}syncEnemies(t,e){this.enemyRenderer.syncEnemies(t,e)}setWeather(t,e=.5){this.weatherSystem.setWeather(t,e)}setWeatherEnabled(t){this.weatherSystem.setEnabled(t)}setWeatherIntensity(t){this.weatherSystem.setIntensity(t)}setTheme(t){console.log(`[SceneManager]  setTheme() called: ${t}`),this.currentTheme=t,this.themeManager.loadTheme(t),this.flyingObjectsSystem.setTheme(t);const e=this.themeManager.getMaterials();console.log("[SceneManager]  Got theme materials:",e),console.log("[SceneManager]  Updating floor material..."),this.updateFloorMaterial(e.floor),console.log("[SceneManager]  Updating block materials..."),this.updateBlockMaterials(e.hardBlock,e.softBlock);const o=Le.getWeatherForTheme(t);console.log(` Theme: ${t}  Weather: ${o}`),o!==_e.NONE?(this.weatherSystem.setWeather(o,.6),console.log(` Weather activated: ${o}`)):(this.weatherSystem.setWeather(_e.NONE),console.log(" No weather (sunny/clear)")),this.createScrollingBackground(t)}createScrollingBackground(t){this.scrollingBackgrounds.forEach(a=>this.scene.remove(a)),this.scrollingBackgrounds=[];const o={[_.CLASSIC]:"/images/backgrounds/bg-classic.png",[_.ICE]:"/images/backgrounds/bg-ice.png",[_.VOLCANO]:"/images/backgrounds/bg-volcano.png",[_.FOREST]:"/images/backgrounds/bg-forest.png",[_.DESERT]:"/images/backgrounds/bg-desert.png",[_.SPACE]:"/images/backgrounds/bg-space.png",[_.MIAMI_BEACH]:"/images/backgrounds/bg-miami.png"}[t];if(!o)return;new ct().load(o,a=>{a.wrapS=te,a.wrapT=ut,a.repeat.set(3,1);const c=new le(45,20),d=new B({map:a,transparent:!0,opacity:.6,side:K}),h=(v-1)/2;for(let f=0;f<2;f++){const y=new w(c,d);y.position.set(h+f*45-22.5,8,h-12),y.rotation.x=-.1,y.renderOrder=-10,this.scene.add(y),this.scrollingBackgrounds.push(y)}console.log(`[SceneManager]  Scrolling background created: ${o}`)},void 0,a=>{console.warn(`[SceneManager] Failed to load background: ${o}`,a)})}updateFloorMaterial(t){console.log(`[SceneManager]  updateFloorMaterial() called. Current: ${this.matFloor.uuid}, New: ${t.uuid}`),this.matFloor!==t?(this.matFloor.dispose(),this.matFloor=t,this.floorMesh.material=this.matFloor,console.log("[SceneManager]  Floor material updated")):console.log("[SceneManager]  Floor material is the same reference, skipping update")}updateBlockMaterials(t,e){console.log("[SceneManager]  updateBlockMaterials() called"),this.matHard.dispose(),this.matSoft.dispose(),this.matHard=t,this.matSoft=e,this.hardBlockPool.material=this.matHard,this.softBlockPool.material=this.matSoft,console.log("[SceneManager]  Block materials updated on instanced meshes")}getCurrentTheme(){return this.currentTheme}dispose(){this.weatherSystem.dispose(),this.themeManager.dispose(),this.flyingObjectsSystem.dispose(),this.enemyRenderer.dispose();for(const t of this.astronautCharacters)t.dispose(),this.scene.remove(t.root);this.astronautCharacters=[],this.scrollingBackgrounds.forEach(t=>{this.scene.remove(t),t.geometry.dispose(),t.material instanceof Ye&&t.material.dispose()}),this.scrollingBackgrounds=[],this.renderer.dispose(),this.matFloor.dispose(),this.matHard.dispose(),this.matSoft.dispose(),this.matBomb.dispose(),this.matBombPrimed.dispose(),this.matBombRushed.dispose(),this.matExplosion.dispose(),this.matPowerUp.dispose(),this.geoBlock.dispose(),this.geoBomb.dispose(),this.geoExplosion.dispose(),this.geoPowerUp.dispose(),this.renderer.domElement.remove()}static showWebGLError(){const t=document.createElement("div");t.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 20, 20, 0.95);
      color: #ff4444;
      padding: 30px;
      border-radius: 12px;
      font-family: Arial, sans-serif;
      max-width: 500px;
      text-align: center;
      z-index: 10000;
      border: 2px solid #ff4444;
    `,t.innerHTML=`
      <h2 style="margin: 0 0 15px 0; color: #ff6666;">WebGL Not Supported</h2>
      <p style="margin: 0 0 15px 0; line-height: 1.6;">
        This game requires WebGL to run, but your browser or device doesn't support it.
      </p>
      <p style="margin: 0; font-size: 14px; color: #aaa;">
        Try updating your browser or enabling hardware acceleration in settings.
      </p>
    `,document.body.appendChild(t)}}class Tt{container;gameInfo;levelInfo=null;timerInfo=null;constructor(t="hud"){this.container=document.getElementById(t),this.gameInfo=document.getElementById("game-info"),this.createHUDElements()}createHUDElements(){this.levelInfo=document.createElement("div"),this.levelInfo.id="level-info",this.levelInfo.style.cssText=`
      position: absolute;
      top: 8px;
      left: 12px;
      font-size: 14px;
      opacity: 0.8;
      color: #e94560;
      font-weight: 600;
    `,this.container.appendChild(this.levelInfo),this.timerInfo=document.createElement("div"),this.timerInfo.id="timer-info",this.timerInfo.style.cssText=`
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      font-weight: bold;
      opacity: 0.9;
      color: #fff;
      font-variant-numeric: tabular-nums;
    `,this.container.appendChild(this.timerInfo)}update(t,e){const o=t.players[0];if(o){if(this.gameInfo&&(o.alive?this.gameInfo.innerHTML=`
          <span style="color: #e94560;">BOMBS:</span> ${o.maxBombs-o.activeBombs}/${o.maxBombs} &nbsp;
          <span style="color: #e94560;">RANGE:</span> ${o.bombRange} &nbsp;
          <span style="color: #e94560;">FUSE:</span> ${o.fuseCharges} &nbsp;
          <span style="color: #e94560;">SPD:</span> ${o.speed.toFixed(1)}
        `:this.gameInfo.innerHTML='<span style="color: #ef4444; font-weight: bold;"> ELIMINATED</span>'),this.levelInfo&&e){const i=this.getLevelName(e.currentLevel);this.levelInfo.textContent=`LEVEL ${e.currentLevel}: ${i}`}if(this.timerInfo&&e){const i=this.getElapsedTime(e);this.timerInfo.textContent=this.formatTime(i),e.phase===I.PAUSED?this.timerInfo.style.color="#fbbf24":this.timerInfo.style.color="#fff"}if(e){const i=e.phase===I.PLAYING||e.phase===I.PAUSED;this.levelInfo.style.display=i?"block":"none",this.timerInfo.style.display=i?"block":"none",this.gameInfo.style.display=i?"block":"none"}}}getLevelName(t){return{1:"Training Grounds",2:"Ice Caverns",3:"Volcano Core",4:"Enchanted Forest",5:"Desert Ruins",6:"Space Station"}[t]||"Unknown"}getElapsedTime(t){return t.phase===I.PAUSED&&t.pausedAt?Math.floor((t.pausedAt-t.levelStartTime-t.totalPauseTime)/1e3):Math.floor((Date.now()-t.levelStartTime-t.totalPauseTime)/1e3)}formatTime(t){const e=Math.floor(t/60),o=t%60;return`${e.toString().padStart(2,"0")}:${o.toString().padStart(2,"0")}`}showMessage(t,e=3e3){const o=document.createElement("div");o.textContent=t,o.style.cssText=`
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(233, 69, 96, 0.9);
      color: white;
      padding: 16px 32px;
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: bold;
      z-index: 100;
      animation: fadeInOut ${e}ms ease-in-out;
    `,this.container.appendChild(o),setTimeout(()=>o.remove(),e)}}class kt{constructor(t,e){this.onUpdate=t,this.onRender=e}accumulator=0;tick=0;lastTime=0;rafId=0;running=!1;frameCount=0;fpsAccum=0;fps=0;start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.rafId=requestAnimationFrame(t=>this.loop(t)))}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}loop(t){if(!this.running)return;const e=Math.min((t-this.lastTime)/1e3,.25);for(this.lastTime=t,this.accumulator+=e,this.fpsAccum+=e,this.frameCount++,this.fpsAccum>=1&&(this.fps=this.frameCount,this.frameCount=0,this.fpsAccum-=1);this.accumulator>=ne;)this.onUpdate(ne,this.tick),this.tick++,this.accumulator-=ne;const o=this.accumulator/ne;this.onRender(o),this.rafId=requestAnimationFrame(i=>this.loop(i))}getTick(){return this.tick}getSimRate(){return je}}function Pt(l,t){return t.col<0||t.col>=v||t.row<0||t.row>=v?!1:l[t.row][t.col]===P.Floor}function De(l){return{col:Math.round(l.x),row:Math.round(l.y)}}function Et(l){switch(l){case x.Up:return{x:0,y:-1};case x.Down:return{x:0,y:1};case x.Left:return{x:-1,y:0};case x.Right:return{x:1,y:0};default:return{x:0,y:0}}}function It(l,t,e){const o=l.players[t];if(!o||!o.alive||o.moveDir===x.None)return;const i=Et(o.moveDir),a=o.worldPos.x+i.x*o.speed*e,c=o.worldPos.y+i.y*o.speed*e,d=De({x:a,y:c}),h=o.gridPos;d.col!==h.col||(d.row,h.row),Pt(l.grid,d)&&(Ct(l,d,t)||(o.worldPos.x=a,o.worldPos.y=c,o.gridPos=De(o.worldPos)))}function Ct(l,t,e){return l.bombs.some(o=>o.gridPos.col===t.col&&o.gridPos.row===t.row&&o.ownerId!==e)}let Bt=1;const Lt=3,Dt=5,Gt=1.5;function Ot(l,t){const e=l.players[t];if(!e||!e.alive||e.activeBombs>=e.maxBombs||l.bombs.some(i=>i.gridPos.col===e.gridPos.col&&i.gridPos.row===e.gridPos.row))return!1;const o={id:Bt++,gridPos:{...e.gridPos},ownerId:t,fuseRemaining:Lt,range:e.bombRange,primed:!1,rushed:!1};return l.bombs.push(o),e.activeBombs++,!0}function Ft(l,t){const e=[];for(let o=l.bombs.length-1;o>=0;o--)if(l.bombs[o].fuseRemaining-=t,l.bombs[o].fuseRemaining<=0){e.push({...l.bombs[o].gridPos});const i=l.players[l.bombs[o].ownerId];i&&i.activeBombs--,l.bombs.splice(o,1)}return e}function Rt(l,t){const e=l.players[t];if(!e||e.fuseCharges<=0)return!1;const o=l.bombs.find(i=>i.ownerId===t&&!i.primed);return o?(o.fuseRemaining=Dt,o.primed=!0,e.fuseCharges--,!0):!1}function Vt(l,t){const e=l.players[t];if(!e||e.fuseCharges<=0)return!1;const o=l.bombs.find(i=>i.ownerId===t&&!i.rushed);return o?(o.fuseRemaining=Math.min(o.fuseRemaining,Gt),o.rushed=!0,e.fuseCharges--,!0):!1}function Ht(l,t){const e=l.players[t];if(!e||e.fuseCharges<=0)return null;const o=l.bombs.findIndex(c=>c.ownerId===t);if(o===-1)return null;const a={...l.bombs[o].gridPos};return l.bombs.splice(o,1),e.activeBombs--,e.fuseCharges--,a}const zt=.5;function Ge(l,t,e){const o=[{pos:t,range:e}];for(;o.length>0;){const i=o.shift(),a=Nt(l,i.pos,i.range);for(const c of a){l.grid[c.row][c.col]===P.SoftBlock&&(l.grid[c.row][c.col]=P.Floor,Ut(l,c)),l.explosions.push({gridPos:c,remaining:zt});for(const d of l.players)d.alive&&d.gridPos.col===c.col&&d.gridPos.row===c.row&&(d.alive=!1);for(let d=l.bombs.length-1;d>=0;d--){const h=l.bombs[d];if(h.gridPos.col===c.col&&h.gridPos.row===c.row){l.bombs.splice(d,1);const f=l.players[h.ownerId];f&&f.activeBombs>0&&f.activeBombs--,o.push({pos:h.gridPos,range:h.range})}}}}}function Nt(l,t,e){const o=[{...t}],i=[{dc:0,dr:-1},{dc:0,dr:1},{dc:-1,dr:0},{dc:1,dr:0}];for(const{dc:a,dr:c}of i)for(let d=1;d<=e;d++){const h=t.col+a*d,f=t.row+c*d;if(h<0||h>=v||f<0||f>=v||l.grid[f][h]===P.HardBlock||(o.push({col:h,row:f}),l.grid[f][h]===P.SoftBlock))break}return o}function $t(l,t){for(let e=l.explosions.length-1;e>=0;e--)l.explosions[e].remaining-=t,l.explosions[e].remaining<=0&&l.explosions.splice(e,1)}function Ut(l,t){if(Math.random()>.3)return;const e=[z.BombRange,z.BombCount,z.Speed,z.FuseCharge],o=e[Math.floor(Math.random()*e.length)];l.powerUps.push({gridPos:{...t},type:o})}function Wt(l){let t=!1;for(const e of l.players)if(e.alive)for(let o=l.powerUps.length-1;o>=0;o--){const i=l.powerUps[o];i.gridPos.col===e.gridPos.col&&i.gridPos.row===e.gridPos.row&&(Yt(l,e.id,i.type),l.powerUps.splice(o,1),t=!0)}return t}function Yt(l,t,e){const o=l.players[t];if(o)switch(e){case z.BombRange:o.bombRange=Math.min(o.bombRange+1,8);break;case z.BombCount:o.maxBombs=Math.min(o.maxBombs+1,8);break;case z.Speed:o.speed=Math.min(o.speed+.5,6);break;case z.FuseCharge:o.fuseCharges=Math.min(o.fuseCharges+1,5);break}}const jt={[k.BASIC]:1,[k.FAST]:2.5,[k.SMART]:1.5,[k.TANK]:.7},Oe=1.5;function qt(l,t,e){const o=l.enemies;if(o)for(const i of o){if(!i.alive)continue;i.dirChangeTimer=(i.dirChangeTimer||0)+e;const a=jt[i.type]||1;if(i.dirChangeTimer>=Oe||i.moveDir===x.None)switch(i.dirChangeTimer=0,i.type){case k.SMART:i.moveDir=me(i.gridPos,t);break;case k.BASIC:case k.FAST:default:Math.random()<.3?i.moveDir=me(i.gridPos,t):i.moveDir=fe();break;case k.TANK:Math.random()<.5?i.moveDir=me(i.gridPos,t):i.moveDir=fe();break}if(i.moveDir!==x.None){const c=a*e,{dx:d,dy:h}=Kt(i.moveDir),f=i.worldPos.x+d*c,y=i.worldPos.y+h*c,s=Math.round(f),n=Math.round(y);Zt(l,s,n)?(i.worldPos.x=f,i.worldPos.y=y,i.gridPos.col=Math.round(i.worldPos.x),i.gridPos.row=Math.round(i.worldPos.y)):(i.moveDir=fe(),i.dirChangeTimer=Oe)}}}function Xt(l,t){const e=l.enemies;if(!e)return!1;const o=.6;for(const i of e){if(!i.alive)continue;const a=i.worldPos.x-t.x,c=i.worldPos.y-t.y;if(Math.sqrt(a*a+c*c)<o)return!0}return!1}function Fe(l,t){const e=l.enemies;if(!e)return!1;for(const o of e)if(o.alive&&o.gridPos.col===t.col&&o.gridPos.row===t.row)return o.alive=!1,!0;return!1}function me(l,t){const e=t.col-l.col,o=t.row-l.row;return Math.abs(e)>Math.abs(o)?e>0?x.Right:x.Left:o!==0?o>0?x.Down:x.Up:x.None}function fe(){const l=[x.Up,x.Down,x.Left,x.Right];return l[Math.floor(Math.random()*l.length)]}function Kt(l){switch(l){case x.Up:return{dx:0,dy:-1};case x.Down:return{dx:0,dy:1};case x.Left:return{dx:-1,dy:0};case x.Right:return{dx:1,dy:0};default:return{dx:0,dy:0}}}function Zt(l,t,e){if(t<0||t>=v||e<0||e>=v)return!1;const o=l.grid[e]?.[t];if(o===P.HardBlock||o===P.SoftBlock)return!1;for(const i of l.bombs)if(i.gridPos.col===t&&i.gridPos.row===e)return!1;return!0}class Qt{state;input;scene;audio;menuManager;hud;gameLoop;sessionBombsPlaced=0;sessionPowerUpsCollected=0;_sessionEnemiesDefeated=0;fpsEl;previousEnemyCount=0;playerWasAlive=!0;previousSoftBlockCount=0;audioInitialized=!1;constructor(){this.input=new bt,this.scene=new we,this.audio=W,this.hud=new Tt;const t=T.getSettings();this.audio.setMusicVolume(t.musicVolume),this.audio.setSfxVolume(t.sfxVolume),this.audio.setUiVolume(t.uiVolume),this.state=this.createInitialExtendedState(),this.menuManager=new _t(e=>this.startGame(e),()=>this.resumeGame(),()=>this.quitToMenu()),this.fpsEl=document.getElementById("fps-counter"),this.fpsEl.style.display=t.showFPS?"block":"none",this.input.setPauseCallback(()=>this.togglePause()),this.gameLoop=new kt((e,o)=>this.update(e,o),e=>this.render(e)),this.setupAudioInitialization(),this.menuManager.showScreen(C.MAIN)}setupAudioInitialization(){const t=()=>{this.audioInitialized||(this.audio.initialize(),this.audioInitialized=!0,this.audio.playMenuMusic(),console.log("[GameController] Audio initialized"))};["click","touchstart","keydown"].forEach(o=>{document.addEventListener(o,t,{once:!0})})}createInitialExtendedState(){return{base:qe(),phase:I.MENU,currentLevel:1,levelStartTime:0,totalPauseTime:0,pausedAt:null,session:{bombsPlaced:0,powerUpsCollected:0,enemiesDefeated:0,startTime:Date.now()},settings:T.getSettings(),stats:T.getStats()}}start(){this.gameLoop.start()}startGame(t){console.log(`[GameController] Starting game with levelId: ${t}`),T.incrementGamesStarted(),this.audioInitialized||(this.audio.initialize(),this.audioInitialized=!0,console.log("[GameController] Audio initialized")),q.setLevel(t-1),this.state.currentLevel=t,console.log(`[GameController] Current level set to: ${this.state.currentLevel}`);const e=q.getCurrentLevel();this.state.base=q.createLevelState(e);const o=this.state.base.enemies||[];this.previousEnemyCount=o.filter(i=>i.alive).length,this.previousSoftBlockCount=0;for(let i=0;i<this.state.base.grid.length;i++)for(let a=0;a<this.state.base.grid[i].length;a++)this.state.base.grid[i][a]===P.SoftBlock&&this.previousSoftBlockCount++;q.getThemeColors(e.theme),this.scene.setTheme(e.theme),this.scene.setWeatherEnabled(!0),this.sessionBombsPlaced=0,this.sessionPowerUpsCollected=0,this._sessionEnemiesDefeated=0,this.previousEnemyCount=0,this.playerWasAlive=!0,this.state.levelStartTime=Date.now(),this.state.totalPauseTime=0,this.state.pausedAt=null,this.applySettings(),this.audio.playLevelMusic(t),this.state.phase=I.PLAYING,this.menuManager.hide(),console.log(`Starting Level ${t}: ${e.name}`)}resumeGame(){this.state.phase===I.PAUSED&&(this.state.pausedAt&&(this.state.totalPauseTime+=Date.now()-this.state.pausedAt),this.state.pausedAt=null,this.state.phase=I.PLAYING,this.menuManager.hide())}quitToMenu(){const t=Math.floor((Date.now()-this.state.session.startTime)/1e3);T.addPlayTime(t),this.audio.stopMusic(),this.audio.playMenuMusic(),this.state.phase=I.MENU,this.menuManager.showScreen(C.MAIN)}togglePause(){this.state.phase===I.PLAYING?(this.state.phase=I.PAUSED,this.state.pausedAt=Date.now(),this.menuManager.showPauseMenu()):this.state.phase===I.PAUSED&&this.resumeGame()}update(t,e){this.state.base.tick=e;const o=this.input.poll();switch(this.state.phase){case I.PLAYING:this.updatePlaying(t,o);break;case I.PAUSED:break;case I.VICTORY:case I.DEFEAT:break;case I.MENU:break}this.hud.update(this.state.base,this.state)}updatePlaying(t,e){const o=this.state.base.players[0];if(this.playerWasAlive&&o&&!o.alive&&this.audio.playPlayerDamage(),this.playerWasAlive=o?.alive??!1,o?.alive){if(e.moveDir!==x.None&&(o.moveDir=e.moveDir,It(this.state.base,0,t)),e.placeBomb&&Ot(this.state.base,0)&&(this.audio.playBombPlace(),this.audio.playFuseTick(),this.sessionBombsPlaced++,T.incrementBombsPlaced()),e.fuseAction==="prime")Rt(this.state.base,0);else if(e.fuseAction==="rush")Vt(this.state.base,0);else if(e.fuseAction==="detonate"){const d=Ht(this.state.base,0);d&&(Ge(this.state.base,d,o.bombRange),this.audio.playExplosion())}}const i=Ft(this.state.base,t);for(const d of i){Ge(this.state.base,d,this.state.base.players[0]?.bombRange??2),console.log("[GameController] Bomb exploded, playing sound"),this.audio.playExplosion();const h=this.state.base.enemies||[];for(const f of h)f.alive&&f.gridPos.col===d.col&&f.gridPos.row===d.row&&Fe(this.state.base,d)}for(const d of this.state.base.explosions)Fe(this.state.base,d.gridPos);$t(this.state.base,t),Wt(this.state.base)&&(this.audio.playPowerUp(),this.sessionPowerUpsCollected++,T.incrementPowerUpsCollected(),T.vibrate(50)),o?.alive&&(qt(this.state.base,o.gridPos,t),Xt(this.state.base,o.worldPos)&&(o.alive=!1,console.log("[GameController] Player hit by enemy!")));const c=this.state.base.enemies||[];this.scene.syncEnemies(c,t),this.trackEnemyDeaths(),this.trackBricksDestroyed(),this.checkGameEndConditions()}trackEnemyDeaths(){const e=(this.state.base.enemies||[]).filter(o=>o.alive);if(e.length<this.previousEnemyCount){const o=this.previousEnemyCount-e.length;for(let i=0;i<o;i++)this.audio.playEnemyDeath(),this._sessionEnemiesDefeated++,T.incrementEnemiesDefeated()}this.previousEnemyCount=e.length}trackBricksDestroyed(){let t=0;for(let e=0;e<this.state.base.grid.length;e++)for(let o=0;o<this.state.base.grid[e].length;o++)this.state.base.grid[e][o]===P.SoftBlock&&t++;t<this.previousSoftBlockCount&&this.previousSoftBlockCount-t>0&&this.audio.playRandomAffirmation(),this.previousSoftBlockCount=t}checkGameEndConditions(){if(!this.state.base.players[0]?.alive){this.handleDefeat();return}let e=0;for(let o=0;o<this.state.base.grid.length;o++)for(let i=0;i<this.state.base.grid[o].length;i++)this.state.base.grid[o][i]===P.SoftBlock&&e++;if(e===0){this.handleVictory();return}}handleVictory(){this.state.phase=I.VICTORY;const t=Math.floor((Date.now()-this.state.levelStartTime-this.state.totalPauseTime)/1e3);T.recordWin(this.state.currentLevel,t),T.vibrate([100,50,100,50,200]),this.audio.stopMusic(),this.audio.playLevelComplete(),this.audio.playVictory();const e=q.getNextLevel();e?(console.log(` LEVEL ${this.state.currentLevel} COMPLETE! Advancing to Level ${e.id}...`),this.menuManager.showGameOver(!0,{time:t,bombs:this.sessionBombsPlaced,powerUps:this.sessionPowerUpsCollected}),setTimeout(()=>{this.state.phase===I.VICTORY&&(q.progressToNext(),this.startGame(e.id))},3e3)):(console.log(` GAME COMPLETE! All levels finished in ${t}s total`),this.menuManager.showGameOver(!0,{time:t,bombs:this.sessionBombsPlaced,powerUps:this.sessionPowerUpsCollected}))}handleDefeat(){this.state.phase=I.DEFEAT,T.recordLoss(),T.vibrate([200,100,200]),this.audio.stopMusic(),this.audio.playDefeat();const t=Math.floor((Date.now()-this.state.levelStartTime-this.state.totalPauseTime)/1e3);this.menuManager.showGameOver(!1,{time:t,bombs:this.sessionBombsPlaced,powerUps:this.sessionPowerUpsCollected}),console.log(`Defeat! Level ${this.state.currentLevel} failed after ${t}s`)}render(t){this.scene.syncState(this.state.base,t),this.scene.render(),this.state.settings.showFPS&&(this.fpsEl.textContent=`${this.gameLoop.fps} FPS`)}applySettings(){const t=T.getSettings();this.audio.setMusicVolume(t.musicVolume),this.audio.setSfxVolume(t.sfxVolume),this.audio.setUiVolume(t.uiVolume),this.fpsEl.style.display=t.showFPS?"block":"none",t.fullscreen&&!document.fullscreenElement?document.documentElement.requestFullscreen?.().catch(()=>{}):!t.fullscreen&&document.fullscreenElement&&document.exitFullscreen?.().catch(()=>{})}getState(){return this.state}getPhase(){return this.state.phase}}console.log(" BLASTFORGE Initializing...");console.log(" GameController with menus, themes, audio");console.log(" Miami Beach & Ice World themes");console.log(" Weather system (rain, snow, ash)");console.log(" ElevenLabs audio integration ready");console.log(" Touch controls for mobile");function Re(){console.log(" init() called");try{const l=new Qt;console.log(" Game initialized successfully!"),l.start(),console.log(" Game loop started!"),window.game=l,window.audio=l.audio,setTimeout(()=>{const t=document.getElementById("game-menus");console.log("Menu element:",t),t&&(console.log("Menu children:",t.childNodes.length),console.log("Menu classes:",t.className))},1e3)}catch(l){console.error(" Failed to initialize game:",l),document.body.innerHTML=`
      <div style="color: white; padding: 20px; font-family: sans-serif; background: #0a0a1a; min-height: 100vh;">
        <h1>Error Loading Game</h1>
        <p>${l instanceof Error?l.message:"Unknown error"}</p>
        <pre style="background: #1a1a2e; padding: 10px; overflow: auto;">${l instanceof Error?l.stack:""}</pre>
      </div>
    `}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Re):Re();
