import{B as ie,V as B,G as V,M as S,a as Ce,D as ne,S as R,b as M,T as ye,c as D,d as me,C as Q,e as oe,P as De,O as ue,A as O,f as we,g as fe,R as Ge,I as C,h as J,i as Y,j as ee,k as ze,L as de,l as pe,m as Z,F as $e,n as Ue,o as Ne,p as Me,E as xe,q as We,r as Ye,s as qe,t as Xe,u as je,v as Ze,w as Ke,x as Fe,y as Qe,z as Je,W as et,H as tt}from"./three-6GlJhNvy.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const a of document.querySelectorAll('link[rel="modulepreload"]'))i(a);new MutationObserver(a=>{for(const r of a)if(r.type==="childList")for(const u of r.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function e(a){const r={};return a.integrity&&(r.integrity=a.integrity),a.referrerPolicy&&(r.referrerPolicy=a.referrerPolicy),a.crossOrigin==="use-credentials"?r.credentials="include":a.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function i(a){if(a.ep)return;a.ep=!0;const r=e(a);fetch(a.href,r)}})();const b=13,q=1,He=60,te=1/He;var I=(c=>(c[c.Floor=0]="Floor",c[c.HardBlock=1]="HardBlock",c[c.SoftBlock=2]="SoftBlock",c))(I||{}),E=(c=>(c[c.None=0]="None",c[c.Up=1]="Up",c[c.Down=2]="Down",c[c.Left=3]="Left",c[c.Right=4]="Right",c))(E||{}),H=(c=>(c.BombRange="bomb_range",c.BombCount="bomb_count",c.Speed="speed",c.FuseCharge="fuse_charge",c))(H||{}),T=(c=>(c.MENU="menu",c.PLAYING="playing",c.PAUSED="paused",c.VICTORY="victory",c.DEFEAT="defeat",c.LEVEL_TRANSITION="level_transition",c))(T||{}),P=(c=>(c.MAIN="main",c.SETTINGS="settings",c.HOW_TO_PLAY="how_to_play",c.STATS="stats",c.LEVEL_SELECT="level_select",c))(P||{}),y=(c=>(c.CLASSIC="classic",c.ICE="ice",c.VOLCANO="volcano",c.FOREST="forest",c.DESERT="desert",c.SPACE="space",c.MIAMI_BEACH="miami_beach",c))(y||{});const F=[{id:1,name:"Training Grounds",theme:"classic",description:"Learn the basics",softBlockDensity:.4,enemyCount:1},{id:2,name:"Ice Caverns",theme:"ice",description:"Slippery surfaces",softBlockDensity:.45,enemyCount:3},{id:3,name:"Volcano Core",theme:"volcano",description:"Watch your step",softBlockDensity:.5,enemyCount:4},{id:4,name:"Enchanted Forest",theme:"forest",description:"Nature's maze",softBlockDensity:.55,enemyCount:5},{id:5,name:"Desert Ruins",theme:"desert",description:"Ancient dangers",softBlockDensity:.5,enemyCount:6},{id:6,name:"Space Station",theme:"space",description:"Zero gravity chaos",softBlockDensity:.6,enemyCount:7},{id:7,name:"Miami Beach",theme:"miami_beach",description:"Sunset vibes and neon lights",softBlockDensity:.5,enemyCount:6}],Se={musicVolume:.7,sfxVolume:1,uiVolume:.8,fullscreen:!1,showFPS:!0,vibration:!0},le={totalWins:0,totalLosses:0,totalPlayTime:0,levelsCompleted:[],bestTimes:{},bombsPlaced:0,powerUpsCollected:0,enemiesDefeated:0,gamesStarted:0};var z=(c=>(c.BASIC="basic",c.FAST="fast",c.SMART="smart",c.TANK="tank",c))(z||{});const Ae="blastforge_settings",Te="blastforge_stats";class st{settings;stats;constructor(){this.settings=this.loadSettings(),this.stats=this.loadStats()}loadSettings(){try{const s=localStorage.getItem(Ae);if(s){const e=JSON.parse(s);return{...Se,...e}}}catch(s){console.warn("Failed to load settings:",s)}return{...Se}}saveSettings(){try{localStorage.setItem(Ae,JSON.stringify(this.settings))}catch(s){console.warn("Failed to save settings:",s)}}getSettings(){return{...this.settings}}updateSettings(s){this.settings={...this.settings,...s},this.saveSettings()}setMusicVolume(s){this.settings.musicVolume=Math.max(0,Math.min(1,s)),this.saveSettings()}setSfxVolume(s){this.settings.sfxVolume=Math.max(0,Math.min(1,s)),this.saveSettings()}setUiVolume(s){this.settings.uiVolume=Math.max(0,Math.min(1,s)),this.saveSettings()}setFullscreen(s){this.settings.fullscreen=s,this.saveSettings(),s?document.documentElement.requestFullscreen?.().catch(()=>{}):document.exitFullscreen?.().catch(()=>{})}setShowFPS(s){this.settings.showFPS=s,this.saveSettings()}setVibration(s){this.settings.vibration=s,this.saveSettings()}loadStats(){try{const s=localStorage.getItem(Te);if(s){const e=JSON.parse(s);return{...le,...e}}}catch(s){console.warn("Failed to load stats:",s)}return{...le}}saveStats(){try{localStorage.setItem(Te,JSON.stringify(this.stats))}catch(s){console.warn("Failed to save stats:",s)}}getStats(){return{...this.stats}}recordWin(s,e){this.stats.totalWins++,this.stats.levelsCompleted.includes(s)||this.stats.levelsCompleted.push(s);const i=this.stats.bestTimes[s];(!i||e<i)&&(this.stats.bestTimes[s]=e),this.saveStats()}recordLoss(){this.stats.totalLosses++,this.saveStats()}addPlayTime(s){this.stats.totalPlayTime+=s,this.saveStats()}incrementBombsPlaced(){this.stats.bombsPlaced++,this.saveStats()}incrementPowerUpsCollected(){this.stats.powerUpsCollected++,this.saveStats()}incrementEnemiesDefeated(){this.stats.enemiesDefeated++,this.saveStats()}incrementGamesStarted(){this.stats.gamesStarted++,this.saveStats()}resetStats(){this.stats={...le},this.saveStats()}vibrate(s){this.settings.vibration&&navigator.vibrate&&navigator.vibrate(s)}}const x=new st;function Oe(){const c=it(),s=[at(0,{col:1,row:1})];return{tick:0,grid:c,players:s,bombs:[],explosions:[],powerUps:[]}}function it(){const c=[];for(let e=0;e<b;e++){c[e]=[];for(let i=0;i<b;i++)e===0||e===b-1||i===0||i===b-1||e%2===0&&i%2===0?c[e][i]=I.HardBlock:c[e][i]=I.Floor}const s=new Set(["1,1","1,2","2,1",`${b-2},${b-2}`,`${b-2},${b-3}`,`${b-3},${b-2}`,`1,${b-2}`,`1,${b-3}`,`2,${b-2}`,`${b-2},1`,`${b-3},1`,`${b-2},2`]);for(let e=1;e<b-1;e++)for(let i=1;i<b-1;i++)c[e][i]===I.Floor&&!s.has(`${i},${e}`)&&Math.random()<.4&&(c[e][i]=I.SoftBlock);return c}function at(c,s){return{id:c,gridPos:{...s},worldPos:{x:s.col,y:s.row},moveDir:E.None,speed:3.5,bombRange:2,maxBombs:1,activeBombs:0,fuseCharges:3,alive:!0}}class nt{currentLevelIndex=0;getCurrentLevel(){return F[this.currentLevelIndex]??F[0]}getAllLevels(){return[...F]}setLevel(s){this.currentLevelIndex=Math.max(0,Math.min(F.length-1,s))}canProgressToLevel(s,e){return!0}getNextLevel(){return F[this.currentLevelIndex+1]??null}progressToNext(){return this.currentLevelIndex<F.length-1?(this.currentLevelIndex++,!0):!1}createLevelState(s){const e=Oe();return this.applyLevelTheme(e,s),this.spawnEnemies(e,s),e}applyLevelTheme(s,e){const i=new Set(["1,1","1,2","2,1",`${b-2},${b-2}`,`${b-2},${b-3}`,`${b-3},${b-2}`,`1,${b-2}`,`1,${b-3}`,`2,${b-2}`,`${b-2},1`,`${b-3},1`,`${b-2},2`]);for(let a=1;a<b-1;a++)for(let r=1;r<b-1;r++)s.grid[a][r]===I.SoftBlock&&(s.grid[a][r]=I.Floor),s.grid[a][r]===I.Floor&&!i.has(`${r},${a}`)&&Math.random()<e.softBlockDensity&&(s.grid[a][r]=I.SoftBlock);switch(e.theme){case y.ICE:break;case y.VOLCANO:break;case y.FOREST:break;case y.MIAMI_BEACH:break}}spawnEnemies(s,e){const i=[{col:b-2,row:b-2},{col:1,row:b-2},{col:b-2,row:1},{col:7,row:7},{col:8,row:8},{col:7,row:8}];for(let a=0;a<e.enemyCount&&a<i.length;a++){const r=i[a];s.grid[r.row][r.col]=I.Floor;const u=ot(a,r.col,r.row,this.getEnemyTypeForLevel(e.id));s.enemies=s.enemies||[],s.enemies.push(u)}}getEnemyTypeForLevel(s){return s>=5?z.SMART:s>=3?z.FAST:z.BASIC}getThemeColors(s){switch(s){case y.ICE:return{background:662058,floor:2771562,accent:8965375};case y.VOLCANO:return{background:1706506,floor:4860458,accent:16737860};case y.FOREST:return{background:662026,floor:2771498,accent:6750088};case y.DESERT:return{background:1710602,floor:6969914,accent:16764006};case y.SPACE:return{background:328976,floor:2763338,accent:11176191};case y.MIAMI_BEACH:return{background:16739229,floor:15255951,accent:4251856};case y.CLASSIC:default:return{background:657930,floor:2763306,accent:43775}}}}function ot(c,s,e,i){const a={[z.BASIC]:2,[z.FAST]:3.5,[z.SMART]:2.5,[z.TANK]:1.5};return{id:c,gridPos:{col:s,row:e},worldPos:{x:s,y:e},moveDir:E.None,speed:a[i],alive:!0,type:i,aiState:"wander"}}const se=new nt;var X=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{},ce={};/*!
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */var ke;function rt(){return ke||(ke=1,(function(c){(function(){var s=function(){this.init()};s.prototype={init:function(){var t=this||e;return t._counter=1e3,t._html5AudioPool=[],t.html5PoolSize=10,t._codecs={},t._howls=[],t._muted=!1,t._volume=1,t._canPlayEvent="canplaythrough",t._navigator=typeof window<"u"&&window.navigator?window.navigator:null,t.masterGain=null,t.noAudio=!1,t.usingWebAudio=!0,t.autoSuspend=!0,t.ctx=null,t.autoUnlock=!0,t._setup(),t},volume:function(t){var n=this||e;if(t=parseFloat(t),n.ctx||v(),typeof t<"u"&&t>=0&&t<=1){if(n._volume=t,n._muted)return n;n.usingWebAudio&&n.masterGain.gain.setValueAtTime(t,e.ctx.currentTime);for(var o=0;o<n._howls.length;o++)if(!n._howls[o]._webAudio)for(var l=n._howls[o]._getSoundIds(),p=0;p<l.length;p++){var g=n._howls[o]._soundById(l[p]);g&&g._node&&(g._node.volume=g._volume*t)}return n}return n._volume},mute:function(t){var n=this||e;n.ctx||v(),n._muted=t,n.usingWebAudio&&n.masterGain.gain.setValueAtTime(t?0:n._volume,e.ctx.currentTime);for(var o=0;o<n._howls.length;o++)if(!n._howls[o]._webAudio)for(var l=n._howls[o]._getSoundIds(),p=0;p<l.length;p++){var g=n._howls[o]._soundById(l[p]);g&&g._node&&(g._node.muted=t?!0:g._muted)}return n},stop:function(){for(var t=this||e,n=0;n<t._howls.length;n++)t._howls[n].stop();return t},unload:function(){for(var t=this||e,n=t._howls.length-1;n>=0;n--)t._howls[n].unload();return t.usingWebAudio&&t.ctx&&typeof t.ctx.close<"u"&&(t.ctx.close(),t.ctx=null,v()),t},codecs:function(t){return(this||e)._codecs[t.replace(/^x-/,"")]},_setup:function(){var t=this||e;if(t.state=t.ctx&&t.ctx.state||"suspended",t._autoSuspend(),!t.usingWebAudio)if(typeof Audio<"u")try{var n=new Audio;typeof n.oncanplaythrough>"u"&&(t._canPlayEvent="canplay")}catch{t.noAudio=!0}else t.noAudio=!0;try{var n=new Audio;n.muted&&(t.noAudio=!0)}catch{}return t.noAudio||t._setupCodecs(),t},_setupCodecs:function(){var t=this||e,n=null;try{n=typeof Audio<"u"?new Audio:null}catch{return t}if(!n||typeof n.canPlayType!="function")return t;var o=n.canPlayType("audio/mpeg;").replace(/^no$/,""),l=t._navigator?t._navigator.userAgent:"",p=l.match(/OPR\/(\d+)/g),g=p&&parseInt(p[0].split("/")[1],10)<33,d=l.indexOf("Safari")!==-1&&l.indexOf("Chrome")===-1,_=l.match(/Version\/(.*?) /),w=d&&_&&parseInt(_[1],10)<15;return t._codecs={mp3:!!(!g&&(o||n.canPlayType("audio/mp3;").replace(/^no$/,""))),mpeg:!!o,opus:!!n.canPlayType('audio/ogg; codecs="opus"').replace(/^no$/,""),ogg:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),oga:!!n.canPlayType('audio/ogg; codecs="vorbis"').replace(/^no$/,""),wav:!!(n.canPlayType('audio/wav; codecs="1"')||n.canPlayType("audio/wav")).replace(/^no$/,""),aac:!!n.canPlayType("audio/aac;").replace(/^no$/,""),caf:!!n.canPlayType("audio/x-caf;").replace(/^no$/,""),m4a:!!(n.canPlayType("audio/x-m4a;")||n.canPlayType("audio/m4a;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),m4b:!!(n.canPlayType("audio/x-m4b;")||n.canPlayType("audio/m4b;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),mp4:!!(n.canPlayType("audio/x-mp4;")||n.canPlayType("audio/mp4;")||n.canPlayType("audio/aac;")).replace(/^no$/,""),weba:!!(!w&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),webm:!!(!w&&n.canPlayType('audio/webm; codecs="vorbis"').replace(/^no$/,"")),dolby:!!n.canPlayType('audio/mp4; codecs="ec-3"').replace(/^no$/,""),flac:!!(n.canPlayType("audio/x-flac;")||n.canPlayType("audio/flac;")).replace(/^no$/,"")},t},_unlockAudio:function(){var t=this||e;if(!(t._audioUnlocked||!t.ctx)){t._audioUnlocked=!1,t.autoUnlock=!1,!t._mobileUnloaded&&t.ctx.sampleRate!==44100&&(t._mobileUnloaded=!0,t.unload()),t._scratchBuffer=t.ctx.createBuffer(1,1,22050);var n=function(o){for(;t._html5AudioPool.length<t.html5PoolSize;)try{var l=new Audio;l._unlocked=!0,t._releaseHtml5Audio(l)}catch{t.noAudio=!0;break}for(var p=0;p<t._howls.length;p++)if(!t._howls[p]._webAudio)for(var g=t._howls[p]._getSoundIds(),d=0;d<g.length;d++){var _=t._howls[p]._soundById(g[d]);_&&_._node&&!_._node._unlocked&&(_._node._unlocked=!0,_._node.load())}t._autoResume();var w=t.ctx.createBufferSource();w.buffer=t._scratchBuffer,w.connect(t.ctx.destination),typeof w.start>"u"?w.noteOn(0):w.start(0),typeof t.ctx.resume=="function"&&t.ctx.resume(),w.onended=function(){w.disconnect(0),t._audioUnlocked=!0,document.removeEventListener("touchstart",n,!0),document.removeEventListener("touchend",n,!0),document.removeEventListener("click",n,!0),document.removeEventListener("keydown",n,!0);for(var k=0;k<t._howls.length;k++)t._howls[k]._emit("unlock")}};return document.addEventListener("touchstart",n,!0),document.addEventListener("touchend",n,!0),document.addEventListener("click",n,!0),document.addEventListener("keydown",n,!0),t}},_obtainHtml5Audio:function(){var t=this||e;if(t._html5AudioPool.length)return t._html5AudioPool.pop();var n=new Audio().play();return n&&typeof Promise<"u"&&(n instanceof Promise||typeof n.then=="function")&&n.catch(function(){console.warn("HTML5 Audio pool exhausted, returning potentially locked audio object.")}),new Audio},_releaseHtml5Audio:function(t){var n=this||e;return t._unlocked&&n._html5AudioPool.push(t),n},_autoSuspend:function(){var t=this;if(!(!t.autoSuspend||!t.ctx||typeof t.ctx.suspend>"u"||!e.usingWebAudio)){for(var n=0;n<t._howls.length;n++)if(t._howls[n]._webAudio){for(var o=0;o<t._howls[n]._sounds.length;o++)if(!t._howls[n]._sounds[o]._paused)return t}return t._suspendTimer&&clearTimeout(t._suspendTimer),t._suspendTimer=setTimeout(function(){if(t.autoSuspend){t._suspendTimer=null,t.state="suspending";var l=function(){t.state="suspended",t._resumeAfterSuspend&&(delete t._resumeAfterSuspend,t._autoResume())};t.ctx.suspend().then(l,l)}},3e4),t}},_autoResume:function(){var t=this;if(!(!t.ctx||typeof t.ctx.resume>"u"||!e.usingWebAudio))return t.state==="running"&&t.ctx.state!=="interrupted"&&t._suspendTimer?(clearTimeout(t._suspendTimer),t._suspendTimer=null):t.state==="suspended"||t.state==="running"&&t.ctx.state==="interrupted"?(t.ctx.resume().then(function(){t.state="running";for(var n=0;n<t._howls.length;n++)t._howls[n]._emit("resume")}),t._suspendTimer&&(clearTimeout(t._suspendTimer),t._suspendTimer=null)):t.state==="suspending"&&(t._resumeAfterSuspend=!0),t}};var e=new s,i=function(t){var n=this;if(!t.src||t.src.length===0){console.error("An array of source files must be passed with any new Howl.");return}n.init(t)};i.prototype={init:function(t){var n=this;return e.ctx||v(),n._autoplay=t.autoplay||!1,n._format=typeof t.format!="string"?t.format:[t.format],n._html5=t.html5||!1,n._muted=t.mute||!1,n._loop=t.loop||!1,n._pool=t.pool||5,n._preload=typeof t.preload=="boolean"||t.preload==="metadata"?t.preload:!0,n._rate=t.rate||1,n._sprite=t.sprite||{},n._src=typeof t.src!="string"?t.src:[t.src],n._volume=t.volume!==void 0?t.volume:1,n._xhr={method:t.xhr&&t.xhr.method?t.xhr.method:"GET",headers:t.xhr&&t.xhr.headers?t.xhr.headers:null,withCredentials:t.xhr&&t.xhr.withCredentials?t.xhr.withCredentials:!1},n._duration=0,n._state="unloaded",n._sounds=[],n._endTimers={},n._queue=[],n._playLock=!1,n._onend=t.onend?[{fn:t.onend}]:[],n._onfade=t.onfade?[{fn:t.onfade}]:[],n._onload=t.onload?[{fn:t.onload}]:[],n._onloaderror=t.onloaderror?[{fn:t.onloaderror}]:[],n._onplayerror=t.onplayerror?[{fn:t.onplayerror}]:[],n._onpause=t.onpause?[{fn:t.onpause}]:[],n._onplay=t.onplay?[{fn:t.onplay}]:[],n._onstop=t.onstop?[{fn:t.onstop}]:[],n._onmute=t.onmute?[{fn:t.onmute}]:[],n._onvolume=t.onvolume?[{fn:t.onvolume}]:[],n._onrate=t.onrate?[{fn:t.onrate}]:[],n._onseek=t.onseek?[{fn:t.onseek}]:[],n._onunlock=t.onunlock?[{fn:t.onunlock}]:[],n._onresume=[],n._webAudio=e.usingWebAudio&&!n._html5,typeof e.ctx<"u"&&e.ctx&&e.autoUnlock&&e._unlockAudio(),e._howls.push(n),n._autoplay&&n._queue.push({event:"play",action:function(){n.play()}}),n._preload&&n._preload!=="none"&&n.load(),n},load:function(){var t=this,n=null;if(e.noAudio){t._emit("loaderror",null,"No audio support.");return}typeof t._src=="string"&&(t._src=[t._src]);for(var o=0;o<t._src.length;o++){var l,p;if(t._format&&t._format[o])l=t._format[o];else{if(p=t._src[o],typeof p!="string"){t._emit("loaderror",null,"Non-string found in selected audio sources - ignoring.");continue}l=/^data:audio\/([^;,]+);/i.exec(p),l||(l=/\.([^.]+)$/.exec(p.split("?",1)[0])),l&&(l=l[1].toLowerCase())}if(l||console.warn('No file extension was found. Consider using the "format" property or specify an extension.'),l&&e.codecs(l)){n=t._src[o];break}}if(!n){t._emit("loaderror",null,"No codec support for selected audio sources.");return}return t._src=n,t._state="loading",window.location.protocol==="https:"&&n.slice(0,5)==="http:"&&(t._html5=!0,t._webAudio=!1),new a(t),t._webAudio&&u(t),t},play:function(t,n){var o=this,l=null;if(typeof t=="number")l=t,t=null;else{if(typeof t=="string"&&o._state==="loaded"&&!o._sprite[t])return null;if(typeof t>"u"&&(t="__default",!o._playLock)){for(var p=0,g=0;g<o._sounds.length;g++)o._sounds[g]._paused&&!o._sounds[g]._ended&&(p++,l=o._sounds[g]._id);p===1?t=null:l=null}}var d=l?o._soundById(l):o._inactiveSound();if(!d)return null;if(l&&!t&&(t=d._sprite||"__default"),o._state!=="loaded"){d._sprite=t,d._ended=!1;var _=d._id;return o._queue.push({event:"play",action:function(){o.play(_)}}),_}if(l&&!d._paused)return n||o._loadQueue("play"),d._id;o._webAudio&&e._autoResume();var w=Math.max(0,d._seek>0?d._seek:o._sprite[t][0]/1e3),k=Math.max(0,(o._sprite[t][0]+o._sprite[t][1])/1e3-w),G=k*1e3/Math.abs(d._rate),U=o._sprite[t][0]/1e3,K=(o._sprite[t][0]+o._sprite[t][1])/1e3;d._sprite=t,d._ended=!1;var re=function(){d._paused=!1,d._seek=w,d._start=U,d._stop=K,d._loop=!!(d._loop||o._sprite[t][2])};if(w>=K){o._ended(d);return}var A=d._node;if(o._webAudio){var _e=function(){o._playLock=!1,re(),o._refreshBuffer(d);var N=d._muted||o._muted?0:d._volume;A.gain.setValueAtTime(N,e.ctx.currentTime),d._playStart=e.ctx.currentTime,typeof A.bufferSource.start>"u"?d._loop?A.bufferSource.noteGrainOn(0,w,86400):A.bufferSource.noteGrainOn(0,w,k):d._loop?A.bufferSource.start(0,w,86400):A.bufferSource.start(0,w,k),G!==1/0&&(o._endTimers[d._id]=setTimeout(o._ended.bind(o,d),G)),n||setTimeout(function(){o._emit("play",d._id),o._loadQueue()},0)};e.state==="running"&&e.ctx.state!=="interrupted"?_e():(o._playLock=!0,o.once("resume",_e),o._clearTimer(d._id))}else{var ve=function(){A.currentTime=w,A.muted=d._muted||o._muted||e._muted||A.muted,A.volume=d._volume*e.volume(),A.playbackRate=d._rate;try{var N=A.play();if(N&&typeof Promise<"u"&&(N instanceof Promise||typeof N.then=="function")?(o._playLock=!0,re(),N.then(function(){o._playLock=!1,A._unlocked=!0,n?o._loadQueue():o._emit("play",d._id)}).catch(function(){o._playLock=!1,o._emit("playerror",d._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction."),d._ended=!0,d._paused=!0})):n||(o._playLock=!1,re(),o._emit("play",d._id)),A.playbackRate=d._rate,A.paused){o._emit("playerror",d._id,"Playback was unable to start. This is most commonly an issue on mobile devices and Chrome where playback was not within a user interaction.");return}t!=="__default"||d._loop?o._endTimers[d._id]=setTimeout(o._ended.bind(o,d),G):(o._endTimers[d._id]=function(){o._ended(d),A.removeEventListener("ended",o._endTimers[d._id],!1)},A.addEventListener("ended",o._endTimers[d._id],!1))}catch(Re){o._emit("playerror",d._id,Re)}};A.src==="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA"&&(A.src=o._src,A.load());var Ve=window&&window.ejecta||!A.readyState&&e._navigator.isCocoonJS;if(A.readyState>=3||Ve)ve();else{o._playLock=!0,o._state="loading";var be=function(){o._state="loaded",ve(),A.removeEventListener(e._canPlayEvent,be,!1)};A.addEventListener(e._canPlayEvent,be,!1),o._clearTimer(d._id)}}return d._id},pause:function(t){var n=this;if(n._state!=="loaded"||n._playLock)return n._queue.push({event:"pause",action:function(){n.pause(t)}}),n;for(var o=n._getSoundIds(t),l=0;l<o.length;l++){n._clearTimer(o[l]);var p=n._soundById(o[l]);if(p&&!p._paused&&(p._seek=n.seek(o[l]),p._rateSeek=0,p._paused=!0,n._stopFade(o[l]),p._node))if(n._webAudio){if(!p._node.bufferSource)continue;typeof p._node.bufferSource.stop>"u"?p._node.bufferSource.noteOff(0):p._node.bufferSource.stop(0),n._cleanBuffer(p._node)}else(!isNaN(p._node.duration)||p._node.duration===1/0)&&p._node.pause();arguments[1]||n._emit("pause",p?p._id:null)}return n},stop:function(t,n){var o=this;if(o._state!=="loaded"||o._playLock)return o._queue.push({event:"stop",action:function(){o.stop(t)}}),o;for(var l=o._getSoundIds(t),p=0;p<l.length;p++){o._clearTimer(l[p]);var g=o._soundById(l[p]);g&&(g._seek=g._start||0,g._rateSeek=0,g._paused=!0,g._ended=!0,o._stopFade(l[p]),g._node&&(o._webAudio?g._node.bufferSource&&(typeof g._node.bufferSource.stop>"u"?g._node.bufferSource.noteOff(0):g._node.bufferSource.stop(0),o._cleanBuffer(g._node)):(!isNaN(g._node.duration)||g._node.duration===1/0)&&(g._node.currentTime=g._start||0,g._node.pause(),g._node.duration===1/0&&o._clearSound(g._node))),n||o._emit("stop",g._id))}return o},mute:function(t,n){var o=this;if(o._state!=="loaded"||o._playLock)return o._queue.push({event:"mute",action:function(){o.mute(t,n)}}),o;if(typeof n>"u")if(typeof t=="boolean")o._muted=t;else return o._muted;for(var l=o._getSoundIds(n),p=0;p<l.length;p++){var g=o._soundById(l[p]);g&&(g._muted=t,g._interval&&o._stopFade(g._id),o._webAudio&&g._node?g._node.gain.setValueAtTime(t?0:g._volume,e.ctx.currentTime):g._node&&(g._node.muted=e._muted?!0:t),o._emit("mute",g._id))}return o},volume:function(){var t=this,n=arguments,o,l;if(n.length===0)return t._volume;if(n.length===1||n.length===2&&typeof n[1]>"u"){var p=t._getSoundIds(),g=p.indexOf(n[0]);g>=0?l=parseInt(n[0],10):o=parseFloat(n[0])}else n.length>=2&&(o=parseFloat(n[0]),l=parseInt(n[1],10));var d;if(typeof o<"u"&&o>=0&&o<=1){if(t._state!=="loaded"||t._playLock)return t._queue.push({event:"volume",action:function(){t.volume.apply(t,n)}}),t;typeof l>"u"&&(t._volume=o),l=t._getSoundIds(l);for(var _=0;_<l.length;_++)d=t._soundById(l[_]),d&&(d._volume=o,n[2]||t._stopFade(l[_]),t._webAudio&&d._node&&!d._muted?d._node.gain.setValueAtTime(o,e.ctx.currentTime):d._node&&!d._muted&&(d._node.volume=o*e.volume()),t._emit("volume",d._id))}else return d=l?t._soundById(l):t._sounds[0],d?d._volume:0;return t},fade:function(t,n,o,l){var p=this;if(p._state!=="loaded"||p._playLock)return p._queue.push({event:"fade",action:function(){p.fade(t,n,o,l)}}),p;t=Math.min(Math.max(0,parseFloat(t)),1),n=Math.min(Math.max(0,parseFloat(n)),1),o=parseFloat(o),p.volume(t,l);for(var g=p._getSoundIds(l),d=0;d<g.length;d++){var _=p._soundById(g[d]);if(_){if(l||p._stopFade(g[d]),p._webAudio&&!_._muted){var w=e.ctx.currentTime,k=w+o/1e3;_._volume=t,_._node.gain.setValueAtTime(t,w),_._node.gain.linearRampToValueAtTime(n,k)}p._startFadeInterval(_,t,n,o,g[d],typeof l>"u")}}return p},_startFadeInterval:function(t,n,o,l,p,g){var d=this,_=n,w=o-n,k=Math.abs(w/.01),G=Math.max(4,k>0?l/k:l),U=Date.now();t._fadeTo=o,t._interval=setInterval(function(){var K=(Date.now()-U)/l;U=Date.now(),_+=w*K,_=Math.round(_*100)/100,w<0?_=Math.max(o,_):_=Math.min(o,_),d._webAudio?t._volume=_:d.volume(_,t._id,!0),g&&(d._volume=_),(o<n&&_<=o||o>n&&_>=o)&&(clearInterval(t._interval),t._interval=null,t._fadeTo=null,d.volume(o,t._id),d._emit("fade",t._id))},G)},_stopFade:function(t){var n=this,o=n._soundById(t);return o&&o._interval&&(n._webAudio&&o._node.gain.cancelScheduledValues(e.ctx.currentTime),clearInterval(o._interval),o._interval=null,n.volume(o._fadeTo,t),o._fadeTo=null,n._emit("fade",t)),n},loop:function(){var t=this,n=arguments,o,l,p;if(n.length===0)return t._loop;if(n.length===1)if(typeof n[0]=="boolean")o=n[0],t._loop=o;else return p=t._soundById(parseInt(n[0],10)),p?p._loop:!1;else n.length===2&&(o=n[0],l=parseInt(n[1],10));for(var g=t._getSoundIds(l),d=0;d<g.length;d++)p=t._soundById(g[d]),p&&(p._loop=o,t._webAudio&&p._node&&p._node.bufferSource&&(p._node.bufferSource.loop=o,o&&(p._node.bufferSource.loopStart=p._start||0,p._node.bufferSource.loopEnd=p._stop,t.playing(g[d])&&(t.pause(g[d],!0),t.play(g[d],!0)))));return t},rate:function(){var t=this,n=arguments,o,l;if(n.length===0)l=t._sounds[0]._id;else if(n.length===1){var p=t._getSoundIds(),g=p.indexOf(n[0]);g>=0?l=parseInt(n[0],10):o=parseFloat(n[0])}else n.length===2&&(o=parseFloat(n[0]),l=parseInt(n[1],10));var d;if(typeof o=="number"){if(t._state!=="loaded"||t._playLock)return t._queue.push({event:"rate",action:function(){t.rate.apply(t,n)}}),t;typeof l>"u"&&(t._rate=o),l=t._getSoundIds(l);for(var _=0;_<l.length;_++)if(d=t._soundById(l[_]),d){t.playing(l[_])&&(d._rateSeek=t.seek(l[_]),d._playStart=t._webAudio?e.ctx.currentTime:d._playStart),d._rate=o,t._webAudio&&d._node&&d._node.bufferSource?d._node.bufferSource.playbackRate.setValueAtTime(o,e.ctx.currentTime):d._node&&(d._node.playbackRate=o);var w=t.seek(l[_]),k=(t._sprite[d._sprite][0]+t._sprite[d._sprite][1])/1e3-w,G=k*1e3/Math.abs(d._rate);(t._endTimers[l[_]]||!d._paused)&&(t._clearTimer(l[_]),t._endTimers[l[_]]=setTimeout(t._ended.bind(t,d),G)),t._emit("rate",d._id)}}else return d=t._soundById(l),d?d._rate:t._rate;return t},seek:function(){var t=this,n=arguments,o,l;if(n.length===0)t._sounds.length&&(l=t._sounds[0]._id);else if(n.length===1){var p=t._getSoundIds(),g=p.indexOf(n[0]);g>=0?l=parseInt(n[0],10):t._sounds.length&&(l=t._sounds[0]._id,o=parseFloat(n[0]))}else n.length===2&&(o=parseFloat(n[0]),l=parseInt(n[1],10));if(typeof l>"u")return 0;if(typeof o=="number"&&(t._state!=="loaded"||t._playLock))return t._queue.push({event:"seek",action:function(){t.seek.apply(t,n)}}),t;var d=t._soundById(l);if(d)if(typeof o=="number"&&o>=0){var _=t.playing(l);_&&t.pause(l,!0),d._seek=o,d._ended=!1,t._clearTimer(l),!t._webAudio&&d._node&&!isNaN(d._node.duration)&&(d._node.currentTime=o);var w=function(){_&&t.play(l,!0),t._emit("seek",l)};if(_&&!t._webAudio){var k=function(){t._playLock?setTimeout(k,0):w()};setTimeout(k,0)}else w()}else if(t._webAudio){var G=t.playing(l)?e.ctx.currentTime-d._playStart:0,U=d._rateSeek?d._rateSeek-d._seek:0;return d._seek+(U+G*Math.abs(d._rate))}else return d._node.currentTime;return t},playing:function(t){var n=this;if(typeof t=="number"){var o=n._soundById(t);return o?!o._paused:!1}for(var l=0;l<n._sounds.length;l++)if(!n._sounds[l]._paused)return!0;return!1},duration:function(t){var n=this,o=n._duration,l=n._soundById(t);return l&&(o=n._sprite[l._sprite][1]/1e3),o},state:function(){return this._state},unload:function(){for(var t=this,n=t._sounds,o=0;o<n.length;o++)n[o]._paused||t.stop(n[o]._id),t._webAudio||(t._clearSound(n[o]._node),n[o]._node.removeEventListener("error",n[o]._errorFn,!1),n[o]._node.removeEventListener(e._canPlayEvent,n[o]._loadFn,!1),n[o]._node.removeEventListener("ended",n[o]._endFn,!1),e._releaseHtml5Audio(n[o]._node)),delete n[o]._node,t._clearTimer(n[o]._id);var l=e._howls.indexOf(t);l>=0&&e._howls.splice(l,1);var p=!0;for(o=0;o<e._howls.length;o++)if(e._howls[o]._src===t._src||t._src.indexOf(e._howls[o]._src)>=0){p=!1;break}return r&&p&&delete r[t._src],e.noAudio=!1,t._state="unloaded",t._sounds=[],t=null,null},on:function(t,n,o,l){var p=this,g=p["_on"+t];return typeof n=="function"&&g.push(l?{id:o,fn:n,once:l}:{id:o,fn:n}),p},off:function(t,n,o){var l=this,p=l["_on"+t],g=0;if(typeof n=="number"&&(o=n,n=null),n||o)for(g=0;g<p.length;g++){var d=o===p[g].id;if(n===p[g].fn&&d||!n&&d){p.splice(g,1);break}}else if(t)l["_on"+t]=[];else{var _=Object.keys(l);for(g=0;g<_.length;g++)_[g].indexOf("_on")===0&&Array.isArray(l[_[g]])&&(l[_[g]]=[])}return l},once:function(t,n,o){var l=this;return l.on(t,n,o,1),l},_emit:function(t,n,o){for(var l=this,p=l["_on"+t],g=p.length-1;g>=0;g--)(!p[g].id||p[g].id===n||t==="load")&&(setTimeout(function(d){d.call(this,n,o)}.bind(l,p[g].fn),0),p[g].once&&l.off(t,p[g].fn,p[g].id));return l._loadQueue(t),l},_loadQueue:function(t){var n=this;if(n._queue.length>0){var o=n._queue[0];o.event===t&&(n._queue.shift(),n._loadQueue()),t||o.action()}return n},_ended:function(t){var n=this,o=t._sprite;if(!n._webAudio&&t._node&&!t._node.paused&&!t._node.ended&&t._node.currentTime<t._stop)return setTimeout(n._ended.bind(n,t),100),n;var l=!!(t._loop||n._sprite[o][2]);if(n._emit("end",t._id),!n._webAudio&&l&&n.stop(t._id,!0).play(t._id),n._webAudio&&l){n._emit("play",t._id),t._seek=t._start||0,t._rateSeek=0,t._playStart=e.ctx.currentTime;var p=(t._stop-t._start)*1e3/Math.abs(t._rate);n._endTimers[t._id]=setTimeout(n._ended.bind(n,t),p)}return n._webAudio&&!l&&(t._paused=!0,t._ended=!0,t._seek=t._start||0,t._rateSeek=0,n._clearTimer(t._id),n._cleanBuffer(t._node),e._autoSuspend()),!n._webAudio&&!l&&n.stop(t._id,!0),n},_clearTimer:function(t){var n=this;if(n._endTimers[t]){if(typeof n._endTimers[t]!="function")clearTimeout(n._endTimers[t]);else{var o=n._soundById(t);o&&o._node&&o._node.removeEventListener("ended",n._endTimers[t],!1)}delete n._endTimers[t]}return n},_soundById:function(t){for(var n=this,o=0;o<n._sounds.length;o++)if(t===n._sounds[o]._id)return n._sounds[o];return null},_inactiveSound:function(){var t=this;t._drain();for(var n=0;n<t._sounds.length;n++)if(t._sounds[n]._ended)return t._sounds[n].reset();return new a(t)},_drain:function(){var t=this,n=t._pool,o=0,l=0;if(!(t._sounds.length<n)){for(l=0;l<t._sounds.length;l++)t._sounds[l]._ended&&o++;for(l=t._sounds.length-1;l>=0;l--){if(o<=n)return;t._sounds[l]._ended&&(t._webAudio&&t._sounds[l]._node&&t._sounds[l]._node.disconnect(0),t._sounds.splice(l,1),o--)}}},_getSoundIds:function(t){var n=this;if(typeof t>"u"){for(var o=[],l=0;l<n._sounds.length;l++)o.push(n._sounds[l]._id);return o}else return[t]},_refreshBuffer:function(t){var n=this;return t._node.bufferSource=e.ctx.createBufferSource(),t._node.bufferSource.buffer=r[n._src],t._panner?t._node.bufferSource.connect(t._panner):t._node.bufferSource.connect(t._node),t._node.bufferSource.loop=t._loop,t._loop&&(t._node.bufferSource.loopStart=t._start||0,t._node.bufferSource.loopEnd=t._stop||0),t._node.bufferSource.playbackRate.setValueAtTime(t._rate,e.ctx.currentTime),n},_cleanBuffer:function(t){var n=this,o=e._navigator&&e._navigator.vendor.indexOf("Apple")>=0;if(!t.bufferSource)return n;if(e._scratchBuffer&&t.bufferSource&&(t.bufferSource.onended=null,t.bufferSource.disconnect(0),o))try{t.bufferSource.buffer=e._scratchBuffer}catch{}return t.bufferSource=null,n},_clearSound:function(t){var n=/MSIE |Trident\//.test(e._navigator&&e._navigator.userAgent);n||(t.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA")}};var a=function(t){this._parent=t,this.init()};a.prototype={init:function(){var t=this,n=t._parent;return t._muted=n._muted,t._loop=n._loop,t._volume=n._volume,t._rate=n._rate,t._seek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++e._counter,n._sounds.push(t),t.create(),t},create:function(){var t=this,n=t._parent,o=e._muted||t._muted||t._parent._muted?0:t._volume;return n._webAudio?(t._node=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),t._node.gain.setValueAtTime(o,e.ctx.currentTime),t._node.paused=!0,t._node.connect(e.masterGain)):e.noAudio||(t._node=e._obtainHtml5Audio(),t._errorFn=t._errorListener.bind(t),t._node.addEventListener("error",t._errorFn,!1),t._loadFn=t._loadListener.bind(t),t._node.addEventListener(e._canPlayEvent,t._loadFn,!1),t._endFn=t._endListener.bind(t),t._node.addEventListener("ended",t._endFn,!1),t._node.src=n._src,t._node.preload=n._preload===!0?"auto":n._preload,t._node.volume=o*e.volume(),t._node.load()),t},reset:function(){var t=this,n=t._parent;return t._muted=n._muted,t._loop=n._loop,t._volume=n._volume,t._rate=n._rate,t._seek=0,t._rateSeek=0,t._paused=!0,t._ended=!0,t._sprite="__default",t._id=++e._counter,t},_errorListener:function(){var t=this;t._parent._emit("loaderror",t._id,t._node.error?t._node.error.code:0),t._node.removeEventListener("error",t._errorFn,!1)},_loadListener:function(){var t=this,n=t._parent;n._duration=Math.ceil(t._node.duration*10)/10,Object.keys(n._sprite).length===0&&(n._sprite={__default:[0,n._duration*1e3]}),n._state!=="loaded"&&(n._state="loaded",n._emit("load"),n._loadQueue()),t._node.removeEventListener(e._canPlayEvent,t._loadFn,!1)},_endListener:function(){var t=this,n=t._parent;n._duration===1/0&&(n._duration=Math.ceil(t._node.duration*10)/10,n._sprite.__default[1]===1/0&&(n._sprite.__default[1]=n._duration*1e3),n._ended(t)),t._node.removeEventListener("ended",t._endFn,!1)}};var r={},u=function(t){var n=t._src;if(r[n]){t._duration=r[n].duration,f(t);return}if(/^data:[^;]+;base64,/.test(n)){for(var o=atob(n.split(",")[1]),l=new Uint8Array(o.length),p=0;p<o.length;++p)l[p]=o.charCodeAt(p);h(l.buffer,t)}else{var g=new XMLHttpRequest;g.open(t._xhr.method,n,!0),g.withCredentials=t._xhr.withCredentials,g.responseType="arraybuffer",t._xhr.headers&&Object.keys(t._xhr.headers).forEach(function(d){g.setRequestHeader(d,t._xhr.headers[d])}),g.onload=function(){var d=(g.status+"")[0];if(d!=="0"&&d!=="2"&&d!=="3"){t._emit("loaderror",null,"Failed loading audio file with status: "+g.status+".");return}h(g.response,t)},g.onerror=function(){t._webAudio&&(t._html5=!0,t._webAudio=!1,t._sounds=[],delete r[n],t.load())},m(g)}},m=function(t){try{t.send()}catch{t.onerror()}},h=function(t,n){var o=function(){n._emit("loaderror",null,"Decoding audio data failed.")},l=function(p){p&&n._sounds.length>0?(r[n._src]=p,f(n,p)):o()};typeof Promise<"u"&&e.ctx.decodeAudioData.length===1?e.ctx.decodeAudioData(t).then(l).catch(o):e.ctx.decodeAudioData(t,l,o)},f=function(t,n){n&&!t._duration&&(t._duration=n.duration),Object.keys(t._sprite).length===0&&(t._sprite={__default:[0,t._duration*1e3]}),t._state!=="loaded"&&(t._state="loaded",t._emit("load"),t._loadQueue())},v=function(){if(e.usingWebAudio){try{typeof AudioContext<"u"?e.ctx=new AudioContext:typeof webkitAudioContext<"u"?e.ctx=new webkitAudioContext:e.usingWebAudio=!1}catch{e.usingWebAudio=!1}e.ctx||(e.usingWebAudio=!1);var t=/iP(hone|od|ad)/.test(e._navigator&&e._navigator.platform),n=e._navigator&&e._navigator.appVersion.match(/OS (\d+)_(\d+)_?(\d+)?/),o=n?parseInt(n[1],10):null;if(t&&o&&o<9){var l=/safari/.test(e._navigator&&e._navigator.userAgent.toLowerCase());e._navigator&&!l&&(e.usingWebAudio=!1)}e.usingWebAudio&&(e.masterGain=typeof e.ctx.createGain>"u"?e.ctx.createGainNode():e.ctx.createGain(),e.masterGain.gain.setValueAtTime(e._muted?0:e._volume,e.ctx.currentTime),e.masterGain.connect(e.ctx.destination)),e._setup()}};c.Howler=e,c.Howl=i,typeof X<"u"?(X.HowlerGlobal=s,X.Howler=e,X.Howl=i,X.Sound=a):typeof window<"u"&&(window.HowlerGlobal=s,window.Howler=e,window.Howl=i,window.Sound=a)})();/*!
 *  Spatial Plugin - Adds support for stereo and 3D audio where Web Audio is supported.
 *  
 *  howler.js v2.2.4
 *  howlerjs.com
 *
 *  (c) 2013-2020, James Simpson of GoldFire Studios
 *  goldfirestudios.com
 *
 *  MIT License
 */(function(){HowlerGlobal.prototype._pos=[0,0,0],HowlerGlobal.prototype._orientation=[0,0,-1,0,1,0],HowlerGlobal.prototype.stereo=function(e){var i=this;if(!i.ctx||!i.ctx.listener)return i;for(var a=i._howls.length-1;a>=0;a--)i._howls[a].stereo(e);return i},HowlerGlobal.prototype.pos=function(e,i,a){var r=this;if(!r.ctx||!r.ctx.listener)return r;if(i=typeof i!="number"?r._pos[1]:i,a=typeof a!="number"?r._pos[2]:a,typeof e=="number")r._pos=[e,i,a],typeof r.ctx.listener.positionX<"u"?(r.ctx.listener.positionX.setTargetAtTime(r._pos[0],Howler.ctx.currentTime,.1),r.ctx.listener.positionY.setTargetAtTime(r._pos[1],Howler.ctx.currentTime,.1),r.ctx.listener.positionZ.setTargetAtTime(r._pos[2],Howler.ctx.currentTime,.1)):r.ctx.listener.setPosition(r._pos[0],r._pos[1],r._pos[2]);else return r._pos;return r},HowlerGlobal.prototype.orientation=function(e,i,a,r,u,m){var h=this;if(!h.ctx||!h.ctx.listener)return h;var f=h._orientation;if(i=typeof i!="number"?f[1]:i,a=typeof a!="number"?f[2]:a,r=typeof r!="number"?f[3]:r,u=typeof u!="number"?f[4]:u,m=typeof m!="number"?f[5]:m,typeof e=="number")h._orientation=[e,i,a,r,u,m],typeof h.ctx.listener.forwardX<"u"?(h.ctx.listener.forwardX.setTargetAtTime(e,Howler.ctx.currentTime,.1),h.ctx.listener.forwardY.setTargetAtTime(i,Howler.ctx.currentTime,.1),h.ctx.listener.forwardZ.setTargetAtTime(a,Howler.ctx.currentTime,.1),h.ctx.listener.upX.setTargetAtTime(r,Howler.ctx.currentTime,.1),h.ctx.listener.upY.setTargetAtTime(u,Howler.ctx.currentTime,.1),h.ctx.listener.upZ.setTargetAtTime(m,Howler.ctx.currentTime,.1)):h.ctx.listener.setOrientation(e,i,a,r,u,m);else return f;return h},Howl.prototype.init=(function(e){return function(i){var a=this;return a._orientation=i.orientation||[1,0,0],a._stereo=i.stereo||null,a._pos=i.pos||null,a._pannerAttr={coneInnerAngle:typeof i.coneInnerAngle<"u"?i.coneInnerAngle:360,coneOuterAngle:typeof i.coneOuterAngle<"u"?i.coneOuterAngle:360,coneOuterGain:typeof i.coneOuterGain<"u"?i.coneOuterGain:0,distanceModel:typeof i.distanceModel<"u"?i.distanceModel:"inverse",maxDistance:typeof i.maxDistance<"u"?i.maxDistance:1e4,panningModel:typeof i.panningModel<"u"?i.panningModel:"HRTF",refDistance:typeof i.refDistance<"u"?i.refDistance:1,rolloffFactor:typeof i.rolloffFactor<"u"?i.rolloffFactor:1},a._onstereo=i.onstereo?[{fn:i.onstereo}]:[],a._onpos=i.onpos?[{fn:i.onpos}]:[],a._onorientation=i.onorientation?[{fn:i.onorientation}]:[],e.call(this,i)}})(Howl.prototype.init),Howl.prototype.stereo=function(e,i){var a=this;if(!a._webAudio)return a;if(a._state!=="loaded")return a._queue.push({event:"stereo",action:function(){a.stereo(e,i)}}),a;var r=typeof Howler.ctx.createStereoPanner>"u"?"spatial":"stereo";if(typeof i>"u")if(typeof e=="number")a._stereo=e,a._pos=[e,0,0];else return a._stereo;for(var u=a._getSoundIds(i),m=0;m<u.length;m++){var h=a._soundById(u[m]);if(h)if(typeof e=="number")h._stereo=e,h._pos=[e,0,0],h._node&&(h._pannerAttr.panningModel="equalpower",(!h._panner||!h._panner.pan)&&s(h,r),r==="spatial"?typeof h._panner.positionX<"u"?(h._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),h._panner.positionY.setValueAtTime(0,Howler.ctx.currentTime),h._panner.positionZ.setValueAtTime(0,Howler.ctx.currentTime)):h._panner.setPosition(e,0,0):h._panner.pan.setValueAtTime(e,Howler.ctx.currentTime)),a._emit("stereo",h._id);else return h._stereo}return a},Howl.prototype.pos=function(e,i,a,r){var u=this;if(!u._webAudio)return u;if(u._state!=="loaded")return u._queue.push({event:"pos",action:function(){u.pos(e,i,a,r)}}),u;if(i=typeof i!="number"?0:i,a=typeof a!="number"?-.5:a,typeof r>"u")if(typeof e=="number")u._pos=[e,i,a];else return u._pos;for(var m=u._getSoundIds(r),h=0;h<m.length;h++){var f=u._soundById(m[h]);if(f)if(typeof e=="number")f._pos=[e,i,a],f._node&&((!f._panner||f._panner.pan)&&s(f,"spatial"),typeof f._panner.positionX<"u"?(f._panner.positionX.setValueAtTime(e,Howler.ctx.currentTime),f._panner.positionY.setValueAtTime(i,Howler.ctx.currentTime),f._panner.positionZ.setValueAtTime(a,Howler.ctx.currentTime)):f._panner.setPosition(e,i,a)),u._emit("pos",f._id);else return f._pos}return u},Howl.prototype.orientation=function(e,i,a,r){var u=this;if(!u._webAudio)return u;if(u._state!=="loaded")return u._queue.push({event:"orientation",action:function(){u.orientation(e,i,a,r)}}),u;if(i=typeof i!="number"?u._orientation[1]:i,a=typeof a!="number"?u._orientation[2]:a,typeof r>"u")if(typeof e=="number")u._orientation=[e,i,a];else return u._orientation;for(var m=u._getSoundIds(r),h=0;h<m.length;h++){var f=u._soundById(m[h]);if(f)if(typeof e=="number")f._orientation=[e,i,a],f._node&&(f._panner||(f._pos||(f._pos=u._pos||[0,0,-.5]),s(f,"spatial")),typeof f._panner.orientationX<"u"?(f._panner.orientationX.setValueAtTime(e,Howler.ctx.currentTime),f._panner.orientationY.setValueAtTime(i,Howler.ctx.currentTime),f._panner.orientationZ.setValueAtTime(a,Howler.ctx.currentTime)):f._panner.setOrientation(e,i,a)),u._emit("orientation",f._id);else return f._orientation}return u},Howl.prototype.pannerAttr=function(){var e=this,i=arguments,a,r,u;if(!e._webAudio)return e;if(i.length===0)return e._pannerAttr;if(i.length===1)if(typeof i[0]=="object")a=i[0],typeof r>"u"&&(a.pannerAttr||(a.pannerAttr={coneInnerAngle:a.coneInnerAngle,coneOuterAngle:a.coneOuterAngle,coneOuterGain:a.coneOuterGain,distanceModel:a.distanceModel,maxDistance:a.maxDistance,refDistance:a.refDistance,rolloffFactor:a.rolloffFactor,panningModel:a.panningModel}),e._pannerAttr={coneInnerAngle:typeof a.pannerAttr.coneInnerAngle<"u"?a.pannerAttr.coneInnerAngle:e._coneInnerAngle,coneOuterAngle:typeof a.pannerAttr.coneOuterAngle<"u"?a.pannerAttr.coneOuterAngle:e._coneOuterAngle,coneOuterGain:typeof a.pannerAttr.coneOuterGain<"u"?a.pannerAttr.coneOuterGain:e._coneOuterGain,distanceModel:typeof a.pannerAttr.distanceModel<"u"?a.pannerAttr.distanceModel:e._distanceModel,maxDistance:typeof a.pannerAttr.maxDistance<"u"?a.pannerAttr.maxDistance:e._maxDistance,refDistance:typeof a.pannerAttr.refDistance<"u"?a.pannerAttr.refDistance:e._refDistance,rolloffFactor:typeof a.pannerAttr.rolloffFactor<"u"?a.pannerAttr.rolloffFactor:e._rolloffFactor,panningModel:typeof a.pannerAttr.panningModel<"u"?a.pannerAttr.panningModel:e._panningModel});else return u=e._soundById(parseInt(i[0],10)),u?u._pannerAttr:e._pannerAttr;else i.length===2&&(a=i[0],r=parseInt(i[1],10));for(var m=e._getSoundIds(r),h=0;h<m.length;h++)if(u=e._soundById(m[h]),u){var f=u._pannerAttr;f={coneInnerAngle:typeof a.coneInnerAngle<"u"?a.coneInnerAngle:f.coneInnerAngle,coneOuterAngle:typeof a.coneOuterAngle<"u"?a.coneOuterAngle:f.coneOuterAngle,coneOuterGain:typeof a.coneOuterGain<"u"?a.coneOuterGain:f.coneOuterGain,distanceModel:typeof a.distanceModel<"u"?a.distanceModel:f.distanceModel,maxDistance:typeof a.maxDistance<"u"?a.maxDistance:f.maxDistance,refDistance:typeof a.refDistance<"u"?a.refDistance:f.refDistance,rolloffFactor:typeof a.rolloffFactor<"u"?a.rolloffFactor:f.rolloffFactor,panningModel:typeof a.panningModel<"u"?a.panningModel:f.panningModel};var v=u._panner;v||(u._pos||(u._pos=e._pos||[0,0,-.5]),s(u,"spatial"),v=u._panner),v.coneInnerAngle=f.coneInnerAngle,v.coneOuterAngle=f.coneOuterAngle,v.coneOuterGain=f.coneOuterGain,v.distanceModel=f.distanceModel,v.maxDistance=f.maxDistance,v.refDistance=f.refDistance,v.rolloffFactor=f.rolloffFactor,v.panningModel=f.panningModel}return e},Sound.prototype.init=(function(e){return function(){var i=this,a=i._parent;i._orientation=a._orientation,i._stereo=a._stereo,i._pos=a._pos,i._pannerAttr=a._pannerAttr,e.call(this),i._stereo?a.stereo(i._stereo):i._pos&&a.pos(i._pos[0],i._pos[1],i._pos[2],i._id)}})(Sound.prototype.init),Sound.prototype.reset=(function(e){return function(){var i=this,a=i._parent;return i._orientation=a._orientation,i._stereo=a._stereo,i._pos=a._pos,i._pannerAttr=a._pannerAttr,i._stereo?a.stereo(i._stereo):i._pos?a.pos(i._pos[0],i._pos[1],i._pos[2],i._id):i._panner&&(i._panner.disconnect(0),i._panner=void 0,a._refreshBuffer(i)),e.call(this)}})(Sound.prototype.reset);var s=function(e,i){i=i||"spatial",i==="spatial"?(e._panner=Howler.ctx.createPanner(),e._panner.coneInnerAngle=e._pannerAttr.coneInnerAngle,e._panner.coneOuterAngle=e._pannerAttr.coneOuterAngle,e._panner.coneOuterGain=e._pannerAttr.coneOuterGain,e._panner.distanceModel=e._pannerAttr.distanceModel,e._panner.maxDistance=e._pannerAttr.maxDistance,e._panner.refDistance=e._pannerAttr.refDistance,e._panner.rolloffFactor=e._pannerAttr.rolloffFactor,e._panner.panningModel=e._pannerAttr.panningModel,typeof e._panner.positionX<"u"?(e._panner.positionX.setValueAtTime(e._pos[0],Howler.ctx.currentTime),e._panner.positionY.setValueAtTime(e._pos[1],Howler.ctx.currentTime),e._panner.positionZ.setValueAtTime(e._pos[2],Howler.ctx.currentTime)):e._panner.setPosition(e._pos[0],e._pos[1],e._pos[2]),typeof e._panner.orientationX<"u"?(e._panner.orientationX.setValueAtTime(e._orientation[0],Howler.ctx.currentTime),e._panner.orientationY.setValueAtTime(e._orientation[1],Howler.ctx.currentTime),e._panner.orientationZ.setValueAtTime(e._orientation[2],Howler.ctx.currentTime)):e._panner.setOrientation(e._orientation[0],e._orientation[1],e._orientation[2])):(e._panner=Howler.ctx.createStereoPanner(),e._panner.pan.setValueAtTime(e._stereo,Howler.ctx.currentTime)),e._panner.connect(e._node),e._paused||e._parent.pause(e._id,!0).play(e._id,!0)}})()})(ce)),ce}var W=rt();class lt{sounds={};music=null;currentMusicTrack=null;masterVolume=1;musicVolume=.5;sfxVolume=.7;uiVolume=.8;isInitialized=!1;muted=!1;soundPaths={"music-menu":"/audio/music-menu.mp3","music-gameplay":"/audio/music-gameplay.mp3","music-level-1":"/audio/music-level-1.mp3","music-level-2":"/audio/music-level-2.mp3","sfx-bomb-place":"/audio/sfx-bomb-place.mp3","sfx-explosion":"/audio/sfx-explosion.mp3","sfx-fuse":"/audio/sfx-bomb-place.mp3","sfx-powerup":"/audio/sfx-powerup.mp3","sfx-enemy-death":"/audio/sfx-enemy-death.mp3","sfx-player-damage":"/audio/sfx-player-damage.mp3","sfx-victory":"/audio/sfx-victory.mp3","sfx-defeat":"/audio/sfx-defeat.mp3"};constructor(){}initialize(){this.isInitialized||(this.loadAllSounds(),this.isInitialized=!0,console.log("[AudioEngine] Initialized"))}loadAllSounds(){Object.entries(this.soundPaths).forEach(([s,e])=>{s.startsWith("music-")||(this.sounds[s]=new W.Howl({src:[e],volume:this.sfxVolume*this.masterVolume,preload:!0,html5:!1,onloaderror:(i,a)=>{console.warn(`[AudioEngine] Failed to load sound: ${s}`,a)}}))})}playSound(s){if(this.isInitialized||this.initialize(),this.muted)return;const e=this.sounds[s];e?(e.volume(this.sfxVolume*this.masterVolume),e.play()):console.warn(`[AudioEngine] Sound not found: ${s}`)}playMenuMusic(){this.playMusicTrack("music-menu")}playGameplayMusic(){this.playMusicTrack("music-gameplay")}playLevelMusic(s){const e=s%2===1?"music-level-1":"music-level-2";this.playMusicTrack(e)}playMusicTrack(s){if(this.isInitialized||this.initialize(),this.currentMusicTrack===s&&this.music?.playing())return;this.stopMusic();const e=this.soundPaths[s];if(!e){console.warn(`[AudioEngine] Music track not found: ${s}`);return}this.music=new W.Howl({src:[e],volume:this.musicVolume*this.masterVolume,loop:!0,html5:!0,onloaderror:(i,a)=>{console.warn(`[AudioEngine] Failed to load music: ${s}`,a)}}),this.muted||this.music.play(),this.currentMusicTrack=s}stopMusic(){this.music&&(this.music.stop(),this.music.unload(),this.music=null),this.currentMusicTrack=null}pauseMusic(){this.music&&this.music.pause()}resumeMusic(){this.music&&!this.muted&&this.music.play()}playBombPlace(){this.playSound("sfx-bomb-place")}playExplosion(){if(this.isInitialized||this.initialize(),this.muted)return;const s=this.sounds["sfx-explosion"];s&&(s.volume(Math.min(1,this.sfxVolume*this.masterVolume*1.5)),s.play())}playFuseTick(){if(this.isInitialized||this.initialize(),this.muted)return;const s=this.sounds["sfx-bomb-place"];s&&(s.volume(Math.min(1,this.sfxVolume*this.masterVolume*1.3)),s.play())}playPowerUp(){this.playSound("sfx-powerup")}playEnemyDeath(){this.playSound("sfx-enemy-death")}playPlayerDamage(){this.playSound("sfx-player-damage")}playVictory(){this.playSound("sfx-victory")}playDefeat(){this.playSound("sfx-defeat")}playSoundEffect(s){s==="ui-select"?this.playSound("sfx-bomb-place"):this.playSound(s)}setMasterVolume(s){this.masterVolume=Math.max(0,Math.min(1,s)),W.Howler.volume(this.masterVolume),this.updateAllVolumes()}setMusicVolume(s){this.musicVolume=Math.max(0,Math.min(1,s)),this.music&&this.music.volume(this.musicVolume*this.masterVolume)}setSfxVolume(s){this.sfxVolume=Math.max(0,Math.min(1,s)),Object.values(this.sounds).forEach(e=>{e.volume(this.sfxVolume*this.masterVolume)})}setUiVolume(s){this.uiVolume=Math.max(0,Math.min(1,s))}updateAllVolumes(){this.setMusicVolume(this.musicVolume),this.setSfxVolume(this.sfxVolume)}getVolumes(){return{master:this.masterVolume,music:this.musicVolume,sfx:this.sfxVolume,ui:this.uiVolume}}mute(){this.muted=!0,W.Howler.mute(!0)}unmute(){this.muted=!1,W.Howler.mute(!1)}toggleMute(){return this.muted?this.unmute():this.mute(),this.muted}isMuted(){return this.muted}playSfx(s=440,e=.1){this.isInitialized||this.playTone(s,e)}playTone(s,e){try{const i=new(window.AudioContext||window.webkitAudioContext),a=i.createOscillator(),r=i.createGain();a.frequency.value=s,a.type="square",r.gain.setValueAtTime(.1*this.sfxVolume*this.masterVolume,i.currentTime),r.gain.exponentialRampToValueAtTime(.01,i.currentTime+e),a.connect(r),r.connect(i.destination),a.start(),a.stop(i.currentTime+e)}catch{console.warn("[AudioEngine] Web Audio API not available")}}isSupported(){return W.Howler.codecs("mp3")}preload(){this.isInitialized||this.initialize()}}const $=new lt;class ct{container;_currentScreen=P.MAIN;onStartGame;onResumeGame;onQuitGame;selectedLevel=1;constructor(s,e,i){this.onStartGame=s,this.onResumeGame=e,this.onQuitGame=i,this.container=document.createElement("div"),this.container.id="game-menus",this.container.className="game-menus",document.body.appendChild(this.container),this.injectStyles(),this.showScreen(P.MAIN)}injectStyles(){if(document.getElementById("game-menu-styles"))return;const s=document.createElement("style");s.id="game-menu-styles",s.textContent=`
      .game-menus {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        pointer-events: none;
      }
      
      .game-menus.active {
        pointer-events: auto;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(8px);
      }
      
      .menu-panel {
        background: linear-gradient(145deg, #1a1a2e 0%, #16213e 100%);
        border: 2px solid #0f3460;
        border-radius: 16px;
        padding: 40px;
        min-width: 320px;
        max-width: 90vw;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        animation: menuSlideIn 0.3s ease-out;
      }
      
      @keyframes menuSlideIn {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .menu-title {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 8px;
        background: linear-gradient(90deg, #e94560, #ff6b6b);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: 0 2px 10px rgba(233, 69, 96, 0.3);
      }
      
      .menu-subtitle {
        text-align: center;
        color: #8892b0;
        margin-bottom: 30px;
        font-size: 0.9rem;
      }
      
      .menu-button {
        display: block;
        width: 100%;
        padding: 16px 24px;
        margin: 12px 0;
        font-size: 1.1rem;
        font-weight: 600;
        color: #fff;
        background: linear-gradient(145deg, #0f3460 0%, #16213e 100%);
        border: 2px solid #1a4a7a;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
        text-align: center;
      }
      
      .menu-button:hover {
        background: linear-gradient(145deg, #1a4a7a 0%, #0f3460 100%);
        border-color: #e94560;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(233, 69, 96, 0.3);
      }
      
      .menu-button:active {
        transform: translateY(0);
      }
      
      .menu-button.primary {
        background: linear-gradient(145deg, #e94560 0%, #c73e54 100%);
        border-color: #ff6b6b;
      }
      
      .menu-button.primary:hover {
        background: linear-gradient(145deg, #ff6b6b 0%, #e94560 100%);
        box-shadow: 0 8px 20px rgba(233, 69, 96, 0.5);
      }
      
      .menu-button.secondary {
        background: transparent;
        border-color: #4a5568;
      }
      
      .menu-button.secondary:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: #8892b0;
      }
      
      .menu-section {
        margin-bottom: 24px;
      }
      
      .menu-section-title {
        font-size: 1rem;
        color: #e94560;
        margin-bottom: 12px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      
      .setting-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      }
      
      .setting-label {
        color: #ccd6f6;
        font-size: 0.95rem;
      }
      
      .setting-control {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .slider {
        width: 120px;
        height: 6px;
        -webkit-appearance: none;
        appearance: none;
        background: #1a4a7a;
        border-radius: 3px;
        outline: none;
      }
      
      .slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        background: #e94560;
        border-radius: 50%;
        cursor: pointer;
      }
      
      .toggle {
        width: 50px;
        height: 26px;
        background: #1a4a7a;
        border-radius: 13px;
        position: relative;
        cursor: pointer;
        transition: background 0.3s;
      }
      
      .toggle.active {
        background: #e94560;
      }
      
      .toggle::after {
        content: '';
        position: absolute;
        width: 22px;
        height: 22px;
        background: #fff;
        border-radius: 50%;
        top: 2px;
        left: 2px;
        transition: transform 0.3s;
      }
      
      .toggle.active::after {
        transform: translateX(24px);
      }
      
      .back-button {
        margin-top: 20px;
        padding: 12px 24px;
        background: transparent;
        border: 2px solid #4a5568;
        color: #8892b0;
        border-radius: 8px;
        cursor: pointer;
        font-size: 0.95rem;
        transition: all 0.2s;
      }
      
      .back-button:hover {
        border-color: #e94560;
        color: #e94560;
      }
      
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 16px;
        margin: 20px 0;
      }
      
      .stat-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 16px;
        border-radius: 12px;
        text-align: center;
      }
      
      .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #e94560;
      }
      
      .stat-label {
        font-size: 0.85rem;
        color: #8892b0;
        margin-top: 4px;
      }
      
      .level-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
        margin: 20px 0;
      }
      
      .level-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 16px;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.2s;
        border: 2px solid transparent;
      }
      
      .level-card:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: #0f3460;
      }
      
      .level-card.selected {
        border-color: #e94560;
        background: rgba(233, 69, 96, 0.1);
      }
      
      .level-card.locked {
        opacity: 0.5;
        cursor: not-allowed;
      }
      
      .level-number {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ccd6f6;
      }
      
      .level-name {
        font-size: 0.85rem;
        color: #8892b0;
        margin-top: 4px;
      }
      
      .instructions-list {
        list-style: none;
        padding: 0;
        margin: 20px 0;
      }
      
      .instructions-list li {
        padding: 12px 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        color: #ccd6f6;
        display: flex;
        align-items: center;
        gap: 12px;
      }
      
      .key {
        background: #0f3460;
        padding: 4px 10px;
        border-radius: 6px;
        font-family: monospace;
        font-size: 0.85rem;
        color: #e94560;
        min-width: 60px;
        text-align: center;
      }
      
      .game-over-title {
        font-size: 3rem;
        text-align: center;
        margin-bottom: 20px;
      }
      
      .game-over-title.victory {
        color: #4ade80;
        text-shadow: 0 2px 20px rgba(74, 222, 128, 0.5);
      }
      
      .game-over-title.defeat {
        color: #ef4444;
        text-shadow: 0 2px 20px rgba(239, 68, 68, 0.5);
      }
      
      .pause-overlay {
        text-align: center;
      }
      
      .pause-title {
        font-size: 3rem;
        color: #fff;
        margin-bottom: 30px;
        text-shadow: 0 2px 20px rgba(255, 255, 255, 0.3);
      }
      
      @media (max-width: 600px) {
        .menu-panel {
          padding: 24px;
          min-width: 280px;
        }
        
        .menu-title {
          font-size: 2rem;
        }
        
        .menu-button {
          padding: 14px 20px;
          font-size: 1rem;
        }
        
        .stats-grid, .level-grid {
          grid-template-columns: 1fr;
        }
      }
    `,document.head.appendChild(s)}showScreen(s){switch(this._currentScreen=s,this.container.innerHTML="",this.container.className="game-menus active",s){case P.MAIN:this.renderMainMenu();break;case P.SETTINGS:this.renderSettings();break;case P.HOW_TO_PLAY:this.renderHowToPlay();break;case P.STATS:this.renderStats();break;case P.LEVEL_SELECT:this.renderLevelSelect();break}}renderMainMenu(){const s=document.createElement("div");s.className="menu-panel",s.innerHTML=`
      <h1 class="menu-title">BLASTFORGE</h1>
      <p class="menu-subtitle">Master the Fuse. Control the Chaos.</p>
      <button class="menu-button primary" data-action="play"> Play</button>
      <button class="menu-button" data-action="levels"> Select Level</button>
      <button class="menu-button" data-action="stats"> Statistics</button>
      <button class="menu-button" data-action="settings"> Settings</button>
      <button class="menu-button" data-action="help"> How to Play</button>
    `,this.bindButton(s,'[data-action="play"]',()=>this.onStartGame(this.selectedLevel)),this.bindButton(s,'[data-action="levels"]',()=>this.showScreen(P.LEVEL_SELECT)),this.bindButton(s,'[data-action="stats"]',()=>this.showScreen(P.STATS)),this.bindButton(s,'[data-action="settings"]',()=>this.showScreen(P.SETTINGS)),this.bindButton(s,'[data-action="help"]',()=>this.showScreen(P.HOW_TO_PLAY)),this.container.appendChild(s)}renderSettings(){const s=x.getSettings(),e=document.createElement("div");e.className="menu-panel",e.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">Settings</h2>
      
      <div class="menu-section">
        <div class="menu-section-title">Audio</div>
        <div class="setting-row">
          <span class="setting-label"> Mute All</span>
          <div class="setting-control">
            <div class="toggle ${$.isMuted()?"active":""}" id="mute-toggle"></div>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label"> Music Volume</span>
          <div class="setting-control">
            <input type="range" class="slider" id="music-volume" min="0" max="100" value="${Math.round(s.musicVolume*100)}">
            <span id="music-value">${Math.round(s.musicVolume*100)}%</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label"> SFX Volume</span>
          <div class="setting-control">
            <input type="range" class="slider" id="sfx-volume" min="0" max="100" value="${Math.round(s.sfxVolume*100)}">
            <span id="sfx-value">${Math.round(s.sfxVolume*100)}%</span>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label"> UI Volume</span>
          <div class="setting-control">
            <input type="range" class="slider" id="ui-volume" min="0" max="100" value="${Math.round(s.uiVolume*100)}">
            <span id="ui-value">${Math.round(s.uiVolume*100)}%</span>
          </div>
        </div>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Display</div>
        <div class="setting-row">
          <span class="setting-label">Fullscreen</span>
          <div class="setting-control">
            <div class="toggle ${s.fullscreen?"active":""}" id="fullscreen-toggle"></div>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Show FPS</span>
          <div class="setting-control">
            <div class="toggle ${s.showFPS?"active":""}" id="fps-toggle"></div>
          </div>
        </div>
        <div class="setting-row">
          <span class="setting-label">Vibration</span>
          <div class="setting-control">
            <div class="toggle ${s.vibration?"active":""}" id="vibration-toggle"></div>
          </div>
        </div>
      </div>
      
      <button class="back-button" data-action="back"> Back</button>
    `;const i=e.querySelector("#music-volume"),a=e.querySelector("#music-value");i?.addEventListener("input",()=>{const f=parseInt(i.value)/100;a.textContent=`${i.value}%`,x.setMusicVolume(f),$.setMusicVolume(f)});const r=e.querySelector("#sfx-volume"),u=e.querySelector("#sfx-value");r?.addEventListener("input",()=>{const f=parseInt(r.value)/100;u.textContent=`${r.value}%`,x.setSfxVolume(f),$.setSfxVolume(f)});const m=e.querySelector("#ui-volume"),h=e.querySelector("#ui-value");m?.addEventListener("input",()=>{const f=parseInt(m.value)/100;h.textContent=`${m.value}%`,x.setUiVolume(f),$.setUiVolume(f)}),this.bindToggle(e,"#mute-toggle",()=>{const f=$.toggleMute(),v=e.querySelector("#mute-toggle");v&&v.classList.toggle("active",f)}),this.bindToggle(e,"#fullscreen-toggle",()=>{const f=x.getSettings();x.setFullscreen(!f.fullscreen)}),this.bindToggle(e,"#fps-toggle",()=>{const f=x.getSettings();x.setShowFPS(!f.showFPS)}),this.bindToggle(e,"#vibration-toggle",()=>{const f=x.getSettings();x.setVibration(!f.vibration)}),this.bindButton(e,'[data-action="back"]',()=>this.showScreen(P.MAIN)),this.container.appendChild(e)}renderHowToPlay(){const s=document.createElement("div");s.className="menu-panel",s.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">How to Play</h2>
      
      <div class="menu-section">
        <div class="menu-section-title">Movement</div>
        <ul class="instructions-list">
          <li><span class="key">WASD</span> Move your character</li>
          <li><span class="key">Arrows</span> Alternative movement</li>
        </ul>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Actions</div>
        <ul class="instructions-list">
          <li><span class="key">SPACE</span> Place bomb</li>
          <li><span class="key">Q</span> Prime bomb (fuse)</li>
          <li><span class="key">E</span> Rush bomb (fast fuse)</li>
          <li><span class="key">R</span> Detonate (remote)</li>
          <li><span class="key">P</span> Pause game</li>
        </ul>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Objective</div>
        <p style="color: #ccd6f6; line-height: 1.6;">
          Destroy soft blocks to clear paths and find power-ups. 
          Eliminate all enemies or be the last one standing to win!
          Watch out for your own bombs - the explosion hurts you too.
        </p>
      </div>
      
      <button class="back-button" data-action="back"> Back</button>
    `,this.bindButton(s,'[data-action="back"]',()=>this.showScreen(P.MAIN)),this.container.appendChild(s)}renderStats(){const s=x.getStats(),e=document.createElement("div");e.className="menu-panel",e.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">Statistics</h2>
      
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value">${s.totalWins}</div>
          <div class="stat-label">Wins</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${s.totalLosses}</div>
          <div class="stat-label">Losses</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${this.formatTime(s.totalPlayTime)}</div>
          <div class="stat-label">Play Time</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${s.bombsPlaced}</div>
          <div class="stat-label">Bombs Placed</div>
        </div>
      </div>
      
      <div class="menu-section">
        <div class="menu-section-title">Level Progress</div>
        <p style="color: #ccd6f6;">
          Levels Completed: ${s.levelsCompleted.length} / ${F.length}
        </p>
      </div>
      
      <button class="menu-button secondary" data-action="reset" style="margin-top: 10px;">
        Reset All Stats
      </button>
      <button class="back-button" data-action="back"> Back</button>
    `,this.bindButton(e,'[data-action="reset"]',()=>{confirm("Are you sure you want to reset all statistics?")&&(x.resetStats(),this.renderStats())}),this.bindButton(e,'[data-action="back"]',()=>this.showScreen(P.MAIN)),this.container.appendChild(e)}renderLevelSelect(){const s=x.getStats(),e=document.createElement("div");e.className="menu-panel";let i='<div class="level-grid">';F.forEach((a,r)=>{const u=s.levelsCompleted.includes(a.id),m=a.id===this.selectedLevel;i+=`
        <div class="level-card ${m?"selected":""} " 
             data-level="${a.id}">
          <div class="level-number">Level ${a.id}</div>
          <div class="level-name">${a.name}</div>
          ${u?" Completed":""}
          
        </div>
      `}),i+="</div>",e.innerHTML=`
      <h2 class="menu-title" style="font-size: 1.8rem;">Select Level</h2>
      <p class="menu-subtitle">Complete levels to unlock more</p>
      ${i}
      <button class="menu-button primary" data-action="start">Start Level</button>
      <button class="back-button" data-action="back"> Back</button>
    `,e.querySelectorAll(".level-card").forEach(a=>{a.addEventListener("click",()=>{const r=parseInt(a.getAttribute("data-level")||"1");this.selectedLevel=r,console.log(`[MenuManager] Selected level: ${this.selectedLevel}`),e.querySelectorAll(".level-card").forEach(u=>u.classList.remove("selected")),a.classList.add("selected"),$.playSoundEffect("ui-select")})}),this.bindButton(e,'[data-action="start"]',()=>this.onStartGame(this.selectedLevel)),this.bindButton(e,'[data-action="back"]',()=>this.showScreen(P.MAIN)),this.container.appendChild(e)}showPauseMenu(){this.container.innerHTML="",this.container.className="game-menus active";const s=document.createElement("div");s.className="menu-panel pause-overlay",s.innerHTML=`
      <h2 class="pause-title">PAUSED</h2>
      <button class="menu-button primary" data-action="resume"> Resume</button>
      <button class="menu-button" data-action="restart"> Restart Level</button>
      <button class="menu-button" data-action="quit"> Quit to Menu</button>
    `,this.bindButton(s,'[data-action="resume"]',()=>this.onResumeGame()),this.bindButton(s,'[data-action="restart"]',()=>this.onStartGame(this.selectedLevel)),this.bindButton(s,'[data-action="quit"]',()=>this.onQuitGame()),this.container.appendChild(s)}showGameOver(s,e){this.container.innerHTML="",this.container.className="game-menus active";const i=document.createElement("div");i.className="menu-panel";const a=s?"VICTORY!":"GAME OVER",r=s?"victory":"defeat";let u="";e&&(u=`
        <div class="stats-grid" style="margin: 20px 0;">
          <div class="stat-card">
            <div class="stat-value">${this.formatTime(e.time)}</div>
            <div class="stat-label">Time</div>
          </div>
          <div class="stat-card">
            <div class="stat-value">${e.bombs}</div>
            <div class="stat-label">Bombs</div>
          </div>
        </div>
      `),i.innerHTML=`
      <h2 class="game-over-title ${r}">${a}</h2>
      ${u}
      <button class="menu-button primary" data-action="next">
        ${s?"Next Level ":"Try Again "}
      </button>
      <button class="menu-button" data-action="menu">Main Menu</button>
    `,this.bindButton(i,'[data-action="next"]',()=>{if(s){const m=this.selectedLevel+1;m<=F.length&&(this.selectedLevel=m)}this.onStartGame(this.selectedLevel)}),this.bindButton(i,'[data-action="menu"]',()=>this.showScreen(P.MAIN)),this.container.appendChild(i)}hide(){this.container.innerHTML="",this.container.className="game-menus"}bindButton(s,e,i){const a=s.querySelector(e);a&&a.addEventListener("click",i)}bindToggle(s,e,i){const a=s.querySelector(e);a&&a.addEventListener("click",()=>{a.classList.toggle("active"),i()})}formatTime(s){const e=Math.floor(s/3600),i=Math.floor(s%3600/60);return e>0?`${e}h ${i}m`:`${i}m`}}class ut{keys=new Set;bombPressed=!1;pausePressed=!1;anyKeyPressed=!1;pauseCallback=null;constructor(){window.addEventListener("keydown",s=>{this.keys.add(s.code),s.code==="Space"&&(this.bombPressed=!0),(s.code==="Escape"||s.code==="KeyP")&&(this.pausePressed=!0,this.pauseCallback?.()),this.anyKeyPressed=!0,s.preventDefault()}),window.addEventListener("keyup",s=>{this.keys.delete(s.code)})}setPauseCallback(s){this.pauseCallback=s}poll(){const s=this.getDirection();let e=E.None;return s.x<0?e=E.Left:s.x>0?e=E.Right:s.y<0?e=E.Up:s.y>0&&(e=E.Down),{moveDir:e,placeBomb:this.consumeBomb(),fuseAction:null,pause:this.consumePause(),menuBack:this.keys.has("Escape"),menuSelect:this.keys.has("Enter")||this.keys.has("Space"),menuUp:this.keys.has("ArrowUp")||this.keys.has("KeyW"),menuDown:this.keys.has("ArrowDown")||this.keys.has("KeyS"),menuLeft:this.keys.has("ArrowLeft")||this.keys.has("KeyA"),menuRight:this.keys.has("ArrowRight")||this.keys.has("KeyD")}}getDirection(){let s=0,e=0;return(this.keys.has("ArrowLeft")||this.keys.has("KeyA"))&&(s-=1),(this.keys.has("ArrowRight")||this.keys.has("KeyD"))&&(s+=1),(this.keys.has("ArrowUp")||this.keys.has("KeyW"))&&(e-=1),(this.keys.has("ArrowDown")||this.keys.has("KeyS"))&&(e+=1),{x:s,y:e}}consumeBomb(){return this.bombPressed?(this.bombPressed=!1,!0):!1}consumePause(){return this.pausePressed?(this.pausePressed=!1,!0):!1}consumeAnyKey(){return this.anyKeyPressed?(this.anyKeyPressed=!1,!0):!1}}const j=new B;function L(c,s,e,i,a,r){const u=2*Math.PI*a/4,m=Math.max(r-2*a,0),h=Math.PI/4;j.copy(s),j[i]=0,j.normalize();const f=.5*u/(u+m),v=1-j.angleTo(c)/h;return Math.sign(j[e])===1?v*f:m/(u+m)+f+f*(1-v)}class dt extends ie{constructor(s=1,e=1,i=1,a=2,r=.1){if(a=a*2+1,r=Math.min(s/2,e/2,i/2,r),super(1,1,1,a,a,a),a===1)return;const u=this.toNonIndexed();this.index=null,this.attributes.position=u.attributes.position,this.attributes.normal=u.attributes.normal,this.attributes.uv=u.attributes.uv;const m=new B,h=new B,f=new B(s,e,i).divideScalar(2).subScalar(r),v=this.attributes.position.array,t=this.attributes.normal.array,n=this.attributes.uv.array,o=v.length/6,l=new B,p=.5/a;for(let g=0,d=0;g<v.length;g+=3,d+=2)switch(m.fromArray(v,g),h.copy(m),h.x-=Math.sign(h.x)*p,h.y-=Math.sign(h.y)*p,h.z-=Math.sign(h.z)*p,h.normalize(),v[g+0]=f.x*Math.sign(m.x)+h.x*r,v[g+1]=f.y*Math.sign(m.y)+h.y*r,v[g+2]=f.z*Math.sign(m.z)+h.z*r,t[g+0]=h.x,t[g+1]=h.y,t[g+2]=h.z,Math.floor(g/o)){case 0:l.set(1,0,0),n[d+0]=L(l,h,"z","y",r,i),n[d+1]=1-L(l,h,"y","z",r,e);break;case 1:l.set(-1,0,0),n[d+0]=1-L(l,h,"z","y",r,i),n[d+1]=1-L(l,h,"y","z",r,e);break;case 2:l.set(0,1,0),n[d+0]=1-L(l,h,"x","z",r,s),n[d+1]=L(l,h,"z","x",r,i);break;case 3:l.set(0,-1,0),n[d+0]=1-L(l,h,"x","z",r,s),n[d+1]=1-L(l,h,"z","x",r,i);break;case 4:l.set(0,0,1),n[d+0]=1-L(l,h,"x","y",r,s),n[d+1]=1-L(l,h,"y","x",r,e);break;case 5:l.set(0,0,-1),n[d+0]=L(l,h,"x","y",r,s),n[d+1]=1-L(l,h,"y","x",r,e);break}}}var ae=(c=>(c.IDLE="idle",c.WALK="walk",c.DEATH="death",c.PLACE_BOMB="place_bomb",c.VICTORY="victory",c))(ae||{});const Pe=[{suit:16119285,accent:16739125,glass:16766720},{suit:15263976,accent:54527,glass:8900331},{suit:16777215,accent:16724838,glass:16738740},{suit:15790320,accent:65416,glass:10025880},{suit:14737632,accent:11167487,glass:14524637},{suit:16777215,accent:16755200,glass:16766720},{suit:16119285,accent:16729156,glass:16739179},{suit:15263976,accent:4491519,glass:8900346}];class ht{root;helmet;helmetRim;body;backpack;leftArm;rightArm;leftLeg;rightLeg;jetpackFlame;jetpackParticles;suitMaterial;accentMaterial;glassMaterial;backpackMaterial;animationState="idle";animationTime=0;deathProgress=0;isDead=!1;config;baseScale=.6;HELMET_RADIUS=.45;BODY_RADIUS=.22;BODY_HEIGHT=.35;LIMB_RADIUS=.08;LIMB_LENGTH=.28;constructor(s={}){const e=Pe[s.playerId??0%Pe.length];this.config={suitColor:s.suitColor??e.suit,accentColor:s.accentColor??e.accent,glassTint:s.glassTint??e.glass,scale:s.scale??1,playerId:s.playerId??0},this.root=new V,this.root.scale.setScalar(this.config.scale*this.baseScale),this.createMaterials(),this.createGeometry(),this.setupShadows()}createMaterials(){this.suitMaterial=new S({color:this.config.suitColor,roughness:.6,metalness:.1,bumpScale:.02}),this.accentMaterial=new S({color:this.config.accentColor,roughness:.3,metalness:.4,emissive:this.config.accentColor,emissiveIntensity:.1}),this.glassMaterial=new Ce({color:this.config.glassTint,metalness:.1,roughness:.05,transmission:.95,thickness:.5,ior:1.5,clearcoat:1,clearcoatRoughness:.05,envMapIntensity:1.5,transparent:!0,opacity:.3,side:ne}),this.backpackMaterial=new S({color:3355443,roughness:.5,metalness:.6})}createGeometry(){this.createHelmet(),this.createBody(),this.createArms(),this.createLegs(),this.createBackpack()}createHelmet(){const s=new V;s.position.y=this.BODY_HEIGHT*.5+this.HELMET_RADIUS*.6;const e=new R(this.HELMET_RADIUS,32,32);this.helmet=new M(e,this.glassMaterial),this.helmet.castShadow=!0,this.helmet.receiveShadow=!0,s.add(this.helmet);const i=new ye(this.HELMET_RADIUS*.85,.04,8,32);this.helmetRim=new M(i,this.accentMaterial),this.helmetRim.rotation.x=Math.PI/2,this.helmetRim.position.y=-this.HELMET_RADIUS*.5,s.add(this.helmetRim);const a=new R(this.HELMET_RADIUS*.7,16,16),r=new D({color:16777215,transparent:!0,opacity:.1,side:me}),u=new M(a,r);s.add(u),this.root.add(s)}createBody(){const s=new Q(this.BODY_RADIUS,this.BODY_HEIGHT,4,16);this.body=new M(s,this.suitMaterial),this.body.position.y=this.BODY_HEIGHT*.4,this.body.castShadow=!0,this.body.receiveShadow=!0;const e=new Q(this.BODY_RADIUS*.6,this.BODY_HEIGHT*.4,4,12),i=new M(e,this.accentMaterial);i.position.set(0,this.BODY_HEIGHT*.1,this.BODY_RADIUS*.5),i.scale.z=.3,this.body.add(i);const a=new ye(this.BODY_RADIUS*.9,.03,8,24),r=new M(a,this.accentMaterial);r.rotation.x=Math.PI/2,r.position.y=this.BODY_HEIGHT*.45,this.body.add(r),this.root.add(this.body)}createArms(){this.leftArm=this.createLimb(!0),this.leftArm.position.set(this.BODY_RADIUS+this.LIMB_RADIUS,this.BODY_HEIGHT*.6,0),this.root.add(this.leftArm),this.rightArm=this.createLimb(!1),this.rightArm.position.set(-(this.BODY_RADIUS+this.LIMB_RADIUS),this.BODY_HEIGHT*.6,0),this.root.add(this.rightArm)}createLegs(){this.leftLeg=this.createLimb(!0,!0),this.leftLeg.position.set(this.BODY_RADIUS*.4,.05,0),this.root.add(this.leftLeg),this.rightLeg=this.createLimb(!1,!0),this.rightLeg.position.set(-this.BODY_RADIUS*.4,.05,0),this.root.add(this.rightLeg)}createLimb(s,e=!1){const i=new V,a=e?this.LIMB_LENGTH*.9:this.LIMB_LENGTH,r=new Q(this.LIMB_RADIUS,a,4,12),u=new M(r,this.suitMaterial);u.position.y=-a*.5,u.castShadow=!0,u.receiveShadow=!0;const m=new Q(this.LIMB_RADIUS*1.05,a*.3,4,8),h=new M(m,this.accentMaterial);h.position.y=-a*.3,h.scale.set(1,1,.5),u.add(h);const f=new R(this.LIMB_RADIUS*1.3,12,12),v=new M(f,e?this.accentMaterial:this.suitMaterial);return v.position.y=-a*.5,e&&(v.scale.y=.6,v.position.y-=.05),u.add(v),i.add(u),i}createBackpack(){this.backpack=new V,this.backpack.position.set(0,this.BODY_HEIGHT*.5,-this.BODY_RADIUS*.8);const s=new dt(.35,.4,.2,4,.05),e=new M(s,this.backpackMaterial);e.castShadow=!0,this.backpack.add(e);const i=new oe(.05,.04,.15,8),a=new M(i,this.accentMaterial);a.position.set(-.1,-.25,-.05),this.backpack.add(a);const r=new M(i,this.accentMaterial);r.position.set(.1,-.25,-.05),this.backpack.add(r),this.jetpackFlame=new De(this.config.accentColor,.5,2),this.jetpackFlame.position.set(0,-.35,-.1),this.backpack.add(this.jetpackFlame),this.jetpackParticles=[];for(let u=0;u<6;u++){const m=new R(.02+Math.random()*.02,6,6),h=new D({color:this.config.accentColor,transparent:!0,opacity:.8}),f=new M(m,h);f.userData={offset:Math.random()*Math.PI*2,speed:.5+Math.random()*.5},this.jetpackParticles.push(f),this.backpack.add(f)}this.root.add(this.backpack)}setupShadows(){this.root.traverse(s=>{s instanceof M&&(s.castShadow=!0,s.receiveShadow=!0)})}update(s){if(!this.isDead){switch(this.animationTime+=s,this.animationState){case"idle":this.animateIdle();break;case"walk":this.animateWalk();break;case"death":this.animateDeath(s);break;case"place_bomb":this.animatePlaceBomb();break;case"victory":this.animateVictory();break}this.animateJetpackParticles(s)}}setAnimationState(s){this.animationState!==s&&(this.animationState=s,this.animationTime=0,s!=="death"&&this.resetPose())}resetPose(){this.root.rotation.set(0,0,0),this.root.position.y=0,this.root.scale.setScalar(this.config.scale*this.baseScale),this.leftArm.rotation.set(0,0,0),this.rightArm.rotation.set(0,0,0),this.leftLeg.rotation.set(0,0,0),this.rightLeg.rotation.set(0,0,0),this.body.rotation.set(0,0,0)}animateIdle(){const s=this.animationTime,e=.03,i=2;this.root.position.y=Math.sin(s*i)*e;const a=1+Math.sin(s*1.5)*.02;this.body.scale.set(a,a,a);const r=Math.sin(s*1.5)*.05;this.leftArm.rotation.z=r+.1,this.rightArm.rotation.z=-r-.1,this.helmet.rotation.x=Math.sin(s*.7)*.02,this.helmet.rotation.y=Math.sin(s*.5)*.03}animateWalk(){const s=this.animationTime,e=8,i=.5,a=.08;this.root.position.y=Math.abs(Math.sin(s*e))*a,this.leftArm.rotation.x=Math.sin(s*e)*i,this.rightArm.rotation.x=Math.sin(s*e+Math.PI)*i,this.leftLeg.rotation.x=Math.sin(s*e+Math.PI)*i,this.rightLeg.rotation.x=Math.sin(s*e)*i,this.body.rotation.z=Math.sin(s*e)*.05,this.helmet.rotation.x=Math.sin(s*e*2)*.03}animateDeath(s){this.deathProgress+=s;const i=Math.min(this.deathProgress/1.5,1),a=5+i*10;this.root.rotation.y+=a*s,this.root.rotation.z=Math.sin(this.deathProgress*3)*.3;const r=(1-i)*this.config.scale*this.baseScale;this.root.scale.setScalar(Math.max(r,.01));const u=1.5;if(i<.3){const m=i/.3;this.root.position.y=m*u}else{const m=(i-.3)/.7;this.root.position.y=u*(1-m)}this.leftArm.rotation.z=Math.sin(this.deathProgress*15)*.8,this.rightArm.rotation.z=Math.cos(this.deathProgress*15)*.8,this.glassMaterial.opacity=.3*(1-i),this.jetpackFlame.intensity=.5+i*2,i>=1&&(this.isDead=!0,this.root.visible=!1)}animatePlaceBomb(){const s=this.animationTime,e=.4;if(s>e){this.setAnimationState("idle");return}const i=s/e,a=Math.sin(i*Math.PI);this.root.position.y=-a*.15,this.leftArm.rotation.x=a*.8,this.rightArm.rotation.x=a*.8,this.leftArm.rotation.z=-a*.3,this.rightArm.rotation.z=a*.3,this.leftLeg.rotation.x=-a*.3,this.rightLeg.rotation.x=-a*.3}animateVictory(){const s=this.animationTime,e=4,i=.3;this.root.position.y=Math.abs(Math.sin(s*e))*i;const a=.5+Math.sin(s*e)*.2;this.leftArm.rotation.z=a,this.rightArm.rotation.z=-a,this.root.rotation.y+=2*.016,this.helmet.rotation.x=Math.sin(s*e*2)*.1}animateJetpackParticles(s){const e=this.animationTime;this.jetpackParticles.forEach((i,a)=>{const r=i.userData,u=(e*r.speed+r.offset)%(Math.PI*2),m=-Math.abs(Math.sin(u))*.3,h=Math.cos(u*2)*.05*(a%2===0?1:-1);i.position.set((a<3?-.1:.1)+h,-.3+m,-.1);const f=1-Math.abs(Math.sin(u));i.material.opacity=f*.8;const v=.5+f*.5;i.scale.setScalar(v)}),this.jetpackFlame.intensity=.5+Math.sin(e*3)*.2}getPosition(){return this.root.position.clone()}setPosition(s,e,i){this.root.position.set(s,e,i)}setRotationY(s){this.root.rotation.y=s}getRotationY(){return this.root.rotation.y}die(){this.isDead||this.setAnimationState("death")}isDeathComplete(){return this.isDead}reset(){this.isDead=!1,this.deathProgress=0,this.animationTime=0,this.root.visible=!0,this.glassMaterial.opacity=.3,this.setAnimationState("idle")}getAnimationState(){return this.animationState}dispose(){this.root.traverse(s=>{s instanceof M&&s.geometry.dispose()}),this.suitMaterial.dispose(),this.accentMaterial.dispose(),this.glassMaterial.dispose(),this.backpackMaterial.dispose()}getBoundingRadius(){return this.HELMET_RADIUS*this.config.scale*this.baseScale}setVisible(s){this.root.visible=s}setEmissiveIntensity(s){this.accentMaterial.emissiveIntensity=.1+s,this.jetpackFlame.intensity=.5+s}flash(s=.2){const e=this.suitMaterial.emissive.clone();this.suitMaterial.emissive.setHex(16777215),this.suitMaterial.emissiveIntensity=.5,setTimeout(()=>{this.suitMaterial.emissive.copy(e),this.suitMaterial.emissiveIntensity=0},s*1e3)}}var he=(c=>(c.NONE="none",c.RAIN="rain",c.SNOW="snow",c.ASH="ash",c.POLLEN="pollen",c.NEON="neon",c))(he||{});class Ie{scene;currentWeather="none";intensity=.5;enabled=!0;particleCount=2e3;particles=[];splashes=[];particleMesh;splashMesh;dummy=new ue;rainMaterial;snowMaterial;ashMaterial;pollenMaterial;neonMaterial;rainGeo;snowGeo;ashGeo;pollenGeo;neonGeo;splashGeo;snowAccumulation=new Map;accumulationMesh;accumulationDummy=new ue;bounds={minX:-2,maxX:18,minZ:-2,maxZ:18,height:20};fireLight;fireGlowMesh;constructor(s){this.scene=s,this.initializeMaterials(),this.initializeGeometries(),this.initializeParticleMesh(),this.initializeSplashes(),this.initializeAccumulation(),this.initializeFireGlow(),this.initializeParticles()}initializeMaterials(){this.rainMaterial=new D({color:4500223,transparent:!0,opacity:.6,blending:O,depthWrite:!1}),this.snowMaterial=new D({color:16777215,transparent:!0,opacity:.8,blending:O,depthWrite:!1}),this.ashMaterial=new D({color:16729122,transparent:!0,opacity:.9,blending:O,depthWrite:!1}),this.pollenMaterial=new D({color:16777130,transparent:!0,opacity:.7,blending:O,depthWrite:!1}),this.neonMaterial=new D({color:65535,transparent:!0,opacity:.9,blending:O,depthWrite:!1})}initializeGeometries(){this.rainGeo=new oe(.01,.01,.8,4),this.rainGeo.translate(0,.4,0),this.snowGeo=new we(.08,0),this.ashGeo=new fe(.08,.08),this.pollenGeo=new R(.06,6,6),this.neonGeo=new we(.05,0),this.splashGeo=new Ge(.05,.15,8),this.splashGeo.rotateX(-Math.PI/2)}initializeParticleMesh(){this.particleMesh=new C(this.rainGeo,this.rainMaterial,this.particleCount),this.particleMesh.instanceMatrix.setUsage(J),this.particleMesh.count=0,this.scene.add(this.particleMesh)}initializeSplashes(){this.splashMesh=new C(this.splashGeo,new D({color:4500223,transparent:!0,opacity:.5,blending:O,depthWrite:!1,side:ne}),100),this.splashMesh.instanceMatrix.setUsage(J),this.splashMesh.count=0,this.scene.add(this.splashMesh)}initializeAccumulation(){this.accumulationMesh=new C(new oe(.4,.5,.1,6),new S({color:16777215,transparent:!0,opacity:.6,roughness:.8}),256),this.accumulationMesh.instanceMatrix.setUsage(J),this.accumulationMesh.count=0,this.accumulationMesh.visible=!1,this.scene.add(this.accumulationMesh)}initializeFireGlow(){this.fireLight=new De(16729122,0,30),this.fireLight.position.set(8,5,8),this.scene.add(this.fireLight);const s=new R(8,32,32);this.fireGlowMesh=new M(s,new D({color:16720384,transparent:!0,opacity:0,blending:O,depthWrite:!1,side:me})),this.fireGlowMesh.position.set(8,4,8),this.scene.add(this.fireGlowMesh)}initializeParticles(){for(let s=0;s<this.particleCount;s++)this.particles.push({position:new B,velocity:new B,life:0,maxLife:1,size:1,rotation:0,rotationSpeed:0});for(let s=0;s<100;s++)this.splashes.push({position:new B,scale:0,life:0,maxLife:.3})}setWeather(s,e=.5){this.currentWeather===s&&this.intensity===e||(this.currentWeather=s,this.intensity=Math.max(0,Math.min(1,e)),console.log(` WeatherSystem.setWeather: ${s}, intensity: ${this.intensity}`),this.updateWeatherGeometry(),this.resetParticles(),this.updateFireGlow(),this.accumulationMesh.visible=s==="snow",console.log(` Particle mesh count: ${this.particleMesh.count}, enabled: ${this.enabled}`))}setEnabled(s){if(this.enabled=s,!s){this.particleMesh.count=0,this.splashMesh.count=0,this.accumulationMesh.visible=!1,this.fireLight.intensity=0;const e=this.fireGlowMesh.material;e.opacity=0}}setIntensity(s){this.intensity=Math.max(0,Math.min(1,s))}updateWeatherGeometry(){switch(this.scene.remove(this.particleMesh),this.currentWeather){case"rain":this.particleMesh=new C(this.rainGeo,this.rainMaterial,this.particleCount);break;case"snow":this.particleMesh=new C(this.snowGeo,this.snowMaterial,this.particleCount);break;case"ash":this.particleMesh=new C(this.ashGeo,this.ashMaterial,this.particleCount);break;case"pollen":this.particleMesh=new C(this.pollenGeo,this.pollenMaterial,this.particleCount);break;case"neon":this.particleMesh=new C(this.neonGeo,this.neonMaterial,this.particleCount);break;default:this.particleMesh=new C(this.rainGeo,this.rainMaterial,this.particleCount)}this.particleMesh.instanceMatrix.setUsage(J),this.particleMesh.count=this.enabled&&this.currentWeather!=="none"?Math.floor(this.particleCount*this.intensity):0,this.scene.add(this.particleMesh)}updateFireGlow(){if(this.currentWeather==="ash"){this.fireLight.intensity=2*this.intensity;const s=this.fireGlowMesh.material;s.opacity=.15*this.intensity}else{this.fireLight.intensity=0;const s=this.fireGlowMesh.material;s.opacity=0}}resetParticles(){for(const s of this.particles)this.spawnParticle(s)}spawnParticle(s){const e=this.bounds.minX+Math.random()*(this.bounds.maxX-this.bounds.minX),i=this.bounds.minZ+Math.random()*(this.bounds.maxZ-this.bounds.minZ);let a;switch(this.currentWeather){case"rain":case"snow":case"pollen":a=this.bounds.height;break;case"ash":case"neon":a=Math.random()*5;break;default:a=Math.random()*this.bounds.height}switch(s.position.set(e,a,i),s.life=Math.random(),s.maxLife=1,s.size=.5+Math.random()*.5,s.rotation=Math.random()*Math.PI*2,s.rotationSpeed=(Math.random()-.5)*2,this.currentWeather){case"rain":s.velocity.set((Math.random()-.5)*2,-15-Math.random()*5,(Math.random()-.5)*2);break;case"snow":s.velocity.set((Math.random()-.5)*1,-2-Math.random()*2,(Math.random()-.5)*1);break;case"ash":s.velocity.set((Math.random()-.5)*3,2+Math.random()*3,(Math.random()-.5)*3);break;case"pollen":s.velocity.set((Math.random()-.5)*.5,-.5-Math.random()*.5,(Math.random()-.5)*.5);break;case"neon":s.velocity.set((Math.random()-.5)*1,3+Math.random()*4,(Math.random()-.5)*1);break}}spawnSplash(s,e){for(const i of this.splashes)if(i.life<=0){i.position.set(s,.05,e),i.scale=.1,i.life=i.maxLife;return}}update(s){if(!this.enabled||this.currentWeather==="none")return;const e=Math.min(s,.05),i=Math.floor(this.particleCount*this.intensity);Math.random()<.01&&console.log(` Weather update: ${this.currentWeather}, active particles: ${i}, dt: ${s.toFixed(4)}`);for(let a=0;a<i;a++){const r=this.particles[a];r.position.x+=r.velocity.x*e,r.position.y+=r.velocity.y*e,r.position.z+=r.velocity.z*e,this.currentWeather==="snow"?(r.position.x+=Math.sin(Date.now()*.001+a)*.01,r.position.z+=Math.cos(Date.now()*.0013+a)*.01):this.currentWeather==="pollen"?(r.position.x+=Math.sin(Date.now()*.002+a*.1)*.02,r.position.z+=Math.cos(Date.now()*.0017+a*.1)*.02):this.currentWeather==="ash"&&(r.position.x+=Math.sin(Date.now()*.003+a*.05)*.03,r.position.z+=Math.cos(Date.now()*.0025+a*.05)*.03),r.rotation+=r.rotationSpeed*e,r.life-=e*.5;const u=r.position.x<this.bounds.minX||r.position.x>this.bounds.maxX||r.position.z<this.bounds.minZ||r.position.z>this.bounds.maxZ,m=r.position.y<=0,h=r.position.y>=this.bounds.height;(r.life<=0||u||m||h)&&(this.currentWeather==="rain"&&m&&r.life>0&&this.spawnSplash(r.position.x,r.position.z),this.currentWeather==="snow"&&m&&this.addSnowAccumulation(r.position.x,r.position.z),this.spawnParticle(r)),this.dummy.position.copy(r.position),this.dummy.scale.setScalar(r.size),this.currentWeather==="rain"?this.dummy.lookAt(r.position.x+r.velocity.x,r.position.y+r.velocity.y,r.position.z+r.velocity.z):this.currentWeather==="ash"?this.dummy.rotation.set(0,r.rotation,0):this.dummy.rotation.set(r.rotation,r.rotation*.7,0),this.dummy.updateMatrix(),this.particleMesh.setMatrixAt(a,this.dummy.matrix)}if(this.particleMesh.count=i,this.particleMesh.instanceMatrix.needsUpdate=!0,this.updateSplashes(e),this.currentWeather==="snow"&&this.updateAccumulation(),this.currentWeather==="ash"){const a=.9+Math.random()*.2;this.fireLight.intensity=2*this.intensity*a;const r=this.fireGlowMesh.material;r.opacity=.15*this.intensity*a}}updateSplashes(s){let e=0;for(let i=0;i<this.splashes.length;i++){const a=this.splashes[i];if(a.life>0){a.life-=s;const r=1-a.life/a.maxLife;a.scale=.1+r*.5,this.dummy.position.copy(a.position),this.dummy.scale.set(a.scale,a.scale,a.scale),this.dummy.rotation.x=-Math.PI/2,this.dummy.updateMatrix(),this.splashMesh.setMatrixAt(e++,this.dummy.matrix)}}this.splashMesh.count=e,this.splashMesh.instanceMatrix.needsUpdate=!0}addSnowAccumulation(s,e){const i=`${Math.floor(s)},${Math.floor(e)}`,a=this.snowAccumulation.get(i)||0;this.snowAccumulation.set(i,Math.min(a+.01,.3))}updateAccumulation(){let s=0;for(const[e,i]of this.snowAccumulation)if(i>.01&&s<256){const[a,r]=e.split(",").map(Number);this.accumulationDummy.position.set(a+.5,i/2,r+.5),this.accumulationDummy.scale.set(1,i*3,1),this.accumulationDummy.updateMatrix(),this.accumulationMesh.setMatrixAt(s++,this.accumulationDummy.matrix)}this.accumulationMesh.count=s,this.accumulationMesh.instanceMatrix.needsUpdate=!0}static getWeatherForTheme(s){switch(s){case y.ICE:return"snow";case y.VOLCANO:return"ash";case y.FOREST:return"pollen";case y.SPACE:return"neon";case y.MIAMI_BEACH:return"none";case y.CLASSIC:case y.DESERT:default:return"none"}}dispose(){this.scene.remove(this.particleMesh),this.scene.remove(this.splashMesh),this.scene.remove(this.accumulationMesh),this.scene.remove(this.fireLight),this.scene.remove(this.fireGlowMesh),this.particleMesh.geometry.dispose(),this.splashMesh.geometry.dispose(),this.accumulationMesh.geometry.dispose(),this.fireGlowMesh.geometry.dispose(),this.rainMaterial.dispose(),this.snowMaterial.dispose(),this.ashMaterial.dispose(),this.pollenMaterial.dispose(),this.neonMaterial.dispose(),this.splashMesh.material.dispose(),this.accumulationMesh.material.dispose(),this.fireGlowMesh.material.dispose()}}class mt{scene;assets;animationMixers=[];waterMesh;palmTrees=[];breezeParticles;time=0;textureCache=new Map;constructor(s){console.log("[MiamiBeachTheme]  Constructor called"),this.scene=s,this.assets=this.createAssets(),console.log("[MiamiBeachTheme]  Assets created:",Object.keys(this.assets)),this.setupEnvironment(),this.createDecorations(),console.log("[MiamiBeachTheme]  Theme setup complete. Scene children count:",this.scene.children.length)}createSandTexture(){const s=document.createElement("canvas");s.width=1024,s.height=1024;const e=s.getContext("2d"),i=e.createLinearGradient(0,0,1024,1024);i.addColorStop(0,"#e8c98f"),i.addColorStop(.3,"#f5deb3"),i.addColorStop(.5,"#e8c98f"),i.addColorStop(.7,"#deb887"),i.addColorStop(1,"#e8c98f"),e.fillStyle=i,e.fillRect(0,0,1024,1024),e.strokeStyle="#d4a574",e.lineWidth=2;for(let m=0;m<40;m++){e.beginPath();const h=Math.random()*1024;e.moveTo(0,h);for(let f=0;f<=1024;f+=50)e.lineTo(f,h+Math.sin(f*.02)*20+Math.random()*10);e.stroke()}const a=e.getImageData(0,0,1024,1024),r=a.data;for(let m=0;m<r.length;m+=4){const h=(Math.random()-.5)*15;r[m]+=h,r[m+1]+=h,r[m+2]+=h}e.putImageData(a,0,0),e.fillStyle="#fff8dc";for(let m=0;m<200;m++){const h=Math.random()*1024,f=Math.random()*1024,v=Math.random()*2;e.beginPath(),e.arc(h,f,v,0,Math.PI*2),e.fill()}const u=new Y(s);return u.wrapS=ee,u.wrapT=ee,u.repeat.set(4,4),u.anisotropy=16,u}createWaterNormalMap(){const s=document.createElement("canvas");s.width=512,s.height=512;const e=s.getContext("2d"),i=e.createImageData(512,512),a=i.data;for(let u=0;u<512;u++)for(let m=0;m<512;m++){const h=(u*512+m)*4,f=Math.sin(m*.05+u*.03)*127+128,v=Math.sin(m*.08-u*.05)*64;a[h]=f+v,a[h+1]=200,a[h+2]=255,a[h+3]=255}e.putImageData(i,0,0);const r=new Y(s);return r.wrapS=ee,r.wrapT=ee,r}createSkyGradient(){const s=document.createElement("canvas");s.width=1,s.height=1024;const e=s.getContext("2d"),i=e.createLinearGradient(0,0,0,1024);return i.addColorStop(0,"#ff6b9d"),i.addColorStop(.2,"#ff8c69"),i.addColorStop(.4,"#ffa500"),i.addColorStop(.6,"#ff7f50"),i.addColorStop(.8,"#9370db"),i.addColorStop(1,"#4b0082"),e.fillStyle=i,e.fillRect(0,0,1,1024),new Y(s)}createWoodTexture(){const s=document.createElement("canvas");s.width=512,s.height=512;const e=s.getContext("2d");e.fillStyle="#8b7355",e.fillRect(0,0,512,512),e.strokeStyle="#6b5344",e.lineWidth=3;for(let a=0;a<50;a++){e.beginPath();const r=Math.random()*512;e.moveTo(r,0),e.lineTo(r+(Math.random()-.5)*50,512),e.stroke()}e.fillStyle="rgba(100, 90, 80, 0.3)";for(let a=0;a<100;a++)e.beginPath(),e.arc(Math.random()*512,Math.random()*512,Math.random()*20,0,Math.PI*2),e.fill();return new Y(s)}createCoralTexture(){const s=document.createElement("canvas");s.width=512,s.height=512;const e=s.getContext("2d"),i=e.createRadialGradient(256,256,0,256,256,300);i.addColorStop(0,"#ff7f7f"),i.addColorStop(.5,"#ff6b6b"),i.addColorStop(1,"#cd5c5c"),e.fillStyle=i,e.fillRect(0,0,512,512),e.fillStyle="rgba(255, 200, 200, 0.4)";for(let r=0;r<200;r++){const u=Math.random()*512,m=Math.random()*512,h=Math.random()*8+2;e.beginPath(),e.arc(u,m,h,0,Math.PI*2),e.fill()}e.strokeStyle="rgba(80, 40, 40, 0.6)",e.lineWidth=2;for(let r=0;r<15;r++){e.beginPath();let u=Math.random()*512,m=Math.random()*512;e.moveTo(u,m);for(let h=0;h<5;h++)u+=(Math.random()-.5)*50,m+=(Math.random()-.5)*50,e.lineTo(u,m);e.stroke()}return new Y(s)}createAssets(){const s=this.createSandTexture(),e=new S({map:s,roughness:.9,metalness:0,bumpMap:s,bumpScale:.02}),i=this.createCoralTexture(),a=new S({map:i,roughness:.8,metalness:.1,bumpMap:i,bumpScale:.05}),r=this.createWoodTexture(),u=new S({map:r,roughness:.7,metalness:0,bumpMap:r,bumpScale:.03}),m=this.createWaterNormalMap(),h=new Ce({color:4251856,transparent:!0,opacity:.8,roughness:.05,metalness:.1,transmission:.3,thickness:1,normalMap:m,normalScale:new ze(.5,.5),envMapIntensity:1,clearcoat:1,clearcoatRoughness:.1}),f=new S({color:9127187,roughness:.9,metalness:0}),v=new S({color:2263842,roughness:.6,metalness:0,side:ne}),t=new S({color:16716947,emissive:16711782,emissiveIntensity:.2,roughness:.4,metalness:.3}),n=new S({color:65535,emissive:34986,emissiveIntensity:.1,roughness:.2,metalness:.4});return{floorMaterial:e,hardBlockMaterial:a,softBlockMaterial:u,waterMaterial:h,palmTrunkMaterial:f,palmLeafMaterial:v,umbrellaMaterial:t,surfboardMaterial:n,skyGradient:this.createSkyGradient()}}setupEnvironment(){console.log("[MiamiBeachTheme]  Setting up environment...");const s=this.scene.children.filter(v=>v instanceof de).length;this.scene.children.filter(v=>v instanceof de).forEach(v=>this.scene.remove(v)),console.log(`[MiamiBeachTheme]  Removed ${s} existing lights`);const e=new pe(16755319,.4);this.scene.add(e);const i=new Z(16746564,1.2);i.position.set(20,15,-20),i.castShadow=!0,i.shadow.mapSize.set(2048,2048),i.shadow.camera.near=.5,i.shadow.camera.far=100,i.shadow.camera.left=-30,i.shadow.camera.right=30,i.shadow.camera.top=30,i.shadow.camera.bottom=-30,i.shadow.bias=-.001,this.scene.add(i);const a=new Z(16716947,.6);a.position.set(-20,10,20),this.scene.add(a);const r=new Z(9662683,.3);r.position.set(0,5,20),this.scene.add(r),this.scene.fog=new $e(16755336,.015),console.log("[MiamiBeachTheme]  Fog added");const u=new R(80,32,32),m=new D({map:this.assets.skyGradient,side:me}),h=new M(u,m);h.name="miami_sky",h.userData.isThemeDecoration=!0,this.scene.add(h),console.log("[MiamiBeachTheme]  Sky sphere added");const f=new fe(120,120,64,64);this.waterMesh=new M(f,this.assets.waterMaterial),this.waterMesh.rotation.x=-Math.PI/2,this.waterMesh.position.y=-.5,this.waterMesh.name="miami_water",this.waterMesh.userData.isThemeDecoration=!0,this.scene.add(this.waterMesh),console.log("[MiamiBeachTheme]  Water plane added at y=-0.5")}createDecorations(){console.log("[MiamiBeachTheme]  Creating decorations..."),this.createPalmTrees(),this.createBreezeParticles(),console.log(`[MiamiBeachTheme]  Decorations complete. Palm trees: ${this.palmTrees.length}`)}createPalmTrees(){[{x:-5,z:-5,scale:1.2,rotation:.3},{x:20,z:-3,scale:1,rotation:-.2},{x:-3,z:18,scale:1.1,rotation:.1},{x:19,z:19,scale:.9,rotation:-.3},{x:8,z:-6,scale:1.3,rotation:0},{x:-6,z:8,scale:1,rotation:.4}].forEach((e,i)=>{const a=new V;a.position.set(e.x,0,e.z),a.rotation.y=e.rotation,a.scale.setScalar(e.scale),a.userData.isThemeDecoration=!0;const r=new Ue([new B(0,0,0),new B(.2,1.5,0),new B(.5,3,.1),new B(.8,4,.2)]),u=new Ne(r,8,.15,8,!1),m=new M(u,this.assets.palmTrunkMaterial);m.castShadow=!0,a.add(m);const h=new V;h.position.set(.8,4,.2);const f=7;for(let v=0;v<f;v++){const t=this.createPalmFrond(v/f*Math.PI*2);t.rotation.y=v/f*Math.PI*2,h.add(t)}a.add(h),this.palmTrees.push(h),this.scene.add(a)})}createPalmFrond(s){const e=new Me;e.moveTo(0,0),e.quadraticCurveTo(.3,1,0,2),e.quadraticCurveTo(-.3,1,0,0);const i={depth:.02,bevelEnabled:!1},a=new xe(e,i),r=new M(a,this.assets.palmLeafMaterial);return r.position.set(0,0,0),r.rotation.x=Math.PI/4,r.scale.set(.8,.8,.8),r.castShadow=!0,r}createBreezeParticles(){const e=new We,i=new Float32Array(300),a=[];for(let u=0;u<100;u++)i[u*3]=(Math.random()-.5)*30,i[u*3+1]=Math.random()*10,i[u*3+2]=(Math.random()-.5)*30,a.push((Math.random()-.5)*.02,(Math.random()-.5)*.01,(Math.random()-.5)*.02);e.setAttribute("position",new Ye(i,3));const r=new qe({color:16777198,size:.05,transparent:!0,opacity:.4,blending:O});this.breezeParticles=new Xe(e,r),this.breezeParticles.userData={velocities:a,isThemeDecoration:!0},this.scene.add(this.breezeParticles)}addBeachDecorations(){this.addBeachUmbrellas(),this.addSurfboards()}addBeachUmbrellas(){[{x:-3,z:8},{x:20,z:10},{x:10,z:-4}].forEach(e=>{const i=new V;i.position.set(e.x,0,e.z),i.userData.isThemeDecoration=!0;const a=new oe(.03,.03,2.5,8),r=new S({color:16777215}),u=new M(a,r);u.position.y=1.25,u.castShadow=!0,i.add(u);const m=new je(1.5,.8,8),h=new M(m,this.assets.umbrellaMaterial);h.position.y=2.3,h.castShadow=!0,i.add(h);const f=new Ge(1.4,1.5,8),v=new D({color:16716947,transparent:!0,opacity:.3,side:ne}),t=new M(f,v);t.rotation.x=-Math.PI/2,t.position.y=2.3,i.add(t),this.scene.add(i)})}addSurfboards(){[{x:-4,z:5,rot:.5,color:65535},{x:21,z:15,rot:-.3,color:16711935}].forEach(e=>{const i=new V;i.position.set(e.x,.4,e.z),i.rotation.y=e.rot,i.userData.isThemeDecoration=!0;const a=new Me;a.moveTo(0,-1.2),a.bezierCurveTo(.3,-1.2,.35,0,.35,.8),a.bezierCurveTo(.35,1.2,0,1.5,0,1.5),a.bezierCurveTo(0,1.5,-.35,1.2,-.35,.8),a.bezierCurveTo(-.35,0,-.3,-1.2,0,-1.2);const r={depth:.08,bevelEnabled:!0,bevelThickness:.02,bevelSize:.02,bevelSegments:2},u=new xe(a,r),m=new M(u,this.assets.surfboardMaterial);m.rotation.x=Math.PI/2,m.position.y=0,m.castShadow=!0,i.add(m),this.scene.add(i)})}update(s){if(this.time+=s,this.waterMesh){const e=this.waterMesh.geometry.attributes.position.array;for(let i=0;i<e.length;i+=3){const a=e[i],r=e[i+1];e[i+2]=Math.sin(a*.3+this.time)*.1+Math.cos(r*.2+this.time*.8)*.1}this.waterMesh.geometry.attributes.position.needsUpdate=!0,this.waterMesh.geometry.computeVertexNormals()}if(this.palmTrees.forEach((e,i)=>{const a=Math.sin(this.time*.5+i)*.05;e.rotation.z=a,e.rotation.x=Math.cos(this.time*.3+i)*.03}),this.breezeParticles){const e=this.breezeParticles.geometry.attributes.position.array,i=this.breezeParticles.userData.velocities;for(let a=0;a<e.length/3;a++)e[a*3]+=i[a*3]+Math.sin(this.time+a)*.001,e[a*3+1]+=i[a*3+1],e[a*3+2]+=i[a*3+2]+Math.cos(this.time+a)*.001,e[a*3+1]>10&&(e[a*3+1]=0),e[a*3]>15&&(e[a*3]=-15),e[a*3]<-15&&(e[a*3]=15),e[a*3+2]>15&&(e[a*3+2]=-15),e[a*3+2]<-15&&(e[a*3+2]=15);this.breezeParticles.geometry.attributes.position.needsUpdate=!0}}getMaterials(){return console.log("[MiamiBeachTheme]  getMaterials() called"),{floor:this.assets.floorMaterial,hardBlock:this.assets.hardBlockMaterial,softBlock:this.assets.softBlockMaterial}}dispose(){this.textureCache.forEach(s=>s.dispose()),Object.values(this.assets).forEach(s=>{(s instanceof Ze||s instanceof Ke)&&s.dispose()})}}class ft{scene;currentTheme=null;defaultMaterials;constructor(s){this.scene=s,this.defaultMaterials=this.createDefaultMaterials()}createDefaultMaterials(){return{floor:new S({color:2763306,roughness:.8}),hardBlock:new S({color:5592405,roughness:.7}),softBlock:new S({color:9136404,roughness:.6})}}loadTheme(s){switch(console.log(`[ThemeManager]  loadTheme() called with theme: ${s}`),this.cleanup(),s){case y.MIAMI_BEACH:console.log("[ThemeManager]  Creating Miami Beach theme..."),this.currentTheme=this.createMiamiBeachTheme();break;case y.CLASSIC:case y.ICE:case y.VOLCANO:case y.FOREST:case y.DESERT:case y.SPACE:default:this.currentTheme=this.createDefaultTheme(s);break}}createMiamiBeachTheme(){console.log("[ThemeManager]  createMiamiBeachTheme() called");const s=new mt(this.scene);s.addBeachDecorations();const e=s.getMaterials();return console.log("[ThemeManager]  Miami Beach theme created. Materials:",Object.keys(e)),{name:y.MIAMI_BEACH,instance:s,materials:e}}createDefaultTheme(s){const e=this.getThemeColors(s);this.scene.background=new Fe(e.background),this.scene.fog=null;const i={floor:new S({color:e.floor,roughness:.8}),hardBlock:new S({color:6710886,roughness:.7}),softBlock:new S({color:e.accent,roughness:.6})};return this.setupBasicLighting(e),{name:s,instance:null,materials:i}}setupBasicLighting(s){this.scene.children.filter(a=>a instanceof de).forEach(a=>this.scene.remove(a));const e=new pe(16777215,.4);this.scene.add(e);const i=new Z(s.accent,.8);i.position.set(10,15,10),i.castShadow=!0,i.shadow.mapSize.set(1024,1024),this.scene.add(i)}getThemeColors(s){switch(s){case y.ICE:return{background:662058,floor:2771562,accent:8965375};case y.VOLCANO:return{background:1706506,floor:4860458,accent:16737860};case y.FOREST:return{background:662026,floor:2771498,accent:6750088};case y.DESERT:return{background:1710602,floor:6969914,accent:16764006};case y.SPACE:return{background:328976,floor:2763338,accent:11176191};case y.CLASSIC:default:return{background:657930,floor:2763306,accent:43775}}}update(s){this.currentTheme?.instance&&this.currentTheme.instance.update(s)}getMaterials(){const s=this.currentTheme?.materials??this.defaultMaterials;return console.log(`[ThemeManager]  getMaterials() returning materials for theme: ${this.currentTheme?.name??"default"}`),s}getCurrentTheme(){return this.currentTheme?.name??null}hasActiveEffects(){return this.currentTheme?.instance!==null}cleanup(){this.currentTheme?.instance&&this.currentTheme.instance.dispose();const s=[];this.scene.traverse(e=>{e.userData.isThemeDecoration&&s.push(e)}),s.forEach(e=>{e.parent&&e.parent.remove(e)}),this.currentTheme=null}dispose(){this.cleanup(),Object.values(this.defaultMaterials).forEach(s=>s.dispose())}}class ge{scene;camera;renderer;floorMesh;hardBlockPool;softBlockPool;astronautCharacters=[];bombMeshes=new Map;explosionMeshes=[];powerUpMeshes=[];matFloor;matHard;matSoft;matBomb=new S({color:1118481});matBombPrimed=new S({color:3359999,emissive:1122986});matBombRushed=new S({color:16720418,emissive:11145489});matExplosion=new S({color:16737792,emissive:16729088,transparent:!0,opacity:.85});matPowerUp=new S({color:4521796,emissive:2271778});themeManager;geoBlock=new ie(q*.95,q*.95,q*.95);geoBomb=new R(.7,16,16);geoExplosion=new ie(q*.9,.3,q*.9);geoPowerUp=new ie(.4,.4,.4);dummy=new ue;weatherSystem;currentTheme=y.CLASSIC;lastFrameTime=0;frameDeltaTime=.016;constructor(){this.scene=new Qe,this.scene.background=new Fe(657930),this.themeManager=new ft(this.scene),this.matFloor=new S({color:2763306}),this.matHard=new S({color:5592405}),this.matSoft=new S({color:9136404});const s=(b-1)/2;this.camera=new Je(60,window.innerWidth/window.innerHeight,.1,200),this.camera.position.set(s,22,s+16),this.camera.lookAt(s,0,s);try{this.renderer=new et({antialias:!0})}catch(m){throw ge.showWebGLError(),new Error("WebGL initialization failed: "+(m instanceof Error?m.message:String(m)))}this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=tt,document.body.appendChild(this.renderer.domElement);const e=new pe(16777215,.4);this.scene.add(e);const i=new Z(16777215,.8);i.position.set(s+5,15,s-5),i.castShadow=!0,i.shadow.mapSize.set(1024,1024),i.shadow.camera.near=1,i.shadow.camera.far=40;const a=b;i.shadow.camera.left=-a,i.shadow.camera.right=a,i.shadow.camera.top=a,i.shadow.camera.bottom=-a,this.scene.add(i);const r=new fe(b,b);this.floorMesh=new M(r,this.matFloor),this.floorMesh.rotation.x=-Math.PI/2,this.floorMesh.position.set(s,-.01,s),this.floorMesh.receiveShadow=!0,this.scene.add(this.floorMesh);const u=b*b;this.hardBlockPool=new C(this.geoBlock,this.matHard,u),this.hardBlockPool.castShadow=!0,this.hardBlockPool.receiveShadow=!0,this.scene.add(this.hardBlockPool),this.softBlockPool=new C(this.geoBlock,this.matSoft,u),this.softBlockPool.castShadow=!0,this.softBlockPool.receiveShadow=!0,this.scene.add(this.softBlockPool),window.addEventListener("resize",()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)}),this.weatherSystem=new Ie(this.scene)}syncState(s,e,i=.016){let a=0,r=0;for(let u=0;u<b;u++)for(let m=0;m<b;m++){const h=s.grid[u][m];h===I.HardBlock?(this.dummy.position.set(m,.475,u),this.dummy.updateMatrix(),this.hardBlockPool.setMatrixAt(a++,this.dummy.matrix)):h===I.SoftBlock&&(this.dummy.position.set(m,.475,u),this.dummy.updateMatrix(),this.softBlockPool.setMatrixAt(r++,this.dummy.matrix))}this.hardBlockPool.count=a,this.hardBlockPool.instanceMatrix.needsUpdate=!0,this.softBlockPool.count=r,this.softBlockPool.instanceMatrix.needsUpdate=!0,this.syncPlayers(s,i),this.syncBombs(s),this.syncExplosions(s),this.syncPowerUps(s)}syncPlayers(s,e){for(;this.astronautCharacters.length<s.players.length;){const i=this.astronautCharacters.length,a=new ht({playerId:i,scale:1});this.scene.add(a.root),this.astronautCharacters.push(a)}for(let i=0;i<this.astronautCharacters.length;i++){const a=this.astronautCharacters[i];if(i<s.players.length){const r=s.players[i];if(r.alive){if(a.setVisible(!0),a.setPosition(r.worldPos.x,0,r.worldPos.y),r.moveDir!==0){a.setAnimationState(ae.WALK);let u=0;switch(r.moveDir){case 1:u=0;break;case 2:u=Math.PI;break;case 3:u=-Math.PI/2;break;case 4:u=Math.PI/2;break}a.setRotationY(u)}else a.setAnimationState(ae.IDLE);a.update(e)}else a.getAnimationState()!==ae.DEATH&&!a.isDeathComplete()&&a.die(),a.update(e),a.isDeathComplete()&&a.setVisible(!1)}else a.setVisible(!1)}}syncBombs(s){const e=new Set(s.bombs.map(i=>i.id));for(const[i,a]of this.bombMeshes)e.has(i)||(this.scene.remove(a),this.bombMeshes.delete(i));for(const i of s.bombs){let a=this.bombMeshes.get(i.id);if(!a){const u=i.primed?this.matBombPrimed:i.rushed?this.matBombRushed:this.matBomb;a=new M(this.geoBomb,u),a.castShadow=!0,this.scene.add(a),this.bombMeshes.set(i.id,a)}a.position.set(i.gridPos.col,.5,i.gridPos.row);const r=1+.15*Math.sin(Date.now()*.01*(i.rushed?4:i.primed?1:2));a.scale.setScalar(r)}}syncExplosions(s){for(;this.explosionMeshes.length>s.explosions.length;){const e=this.explosionMeshes.pop();this.scene.remove(e)}for(let e=0;e<s.explosions.length;e++){let i=this.explosionMeshes[e];i||(i=new M(this.geoExplosion,this.matExplosion.clone()),i.castShadow=!1,this.scene.add(i),this.explosionMeshes.push(i));const a=s.explosions[e];i.position.set(a.gridPos.col,.15,a.gridPos.row),i.material.opacity=Math.min(1,a.remaining*2)}}syncPowerUps(s){for(;this.powerUpMeshes.length>s.powerUps.length;){const e=this.powerUpMeshes.pop();this.scene.remove(e)}for(let e=0;e<s.powerUps.length;e++){let i=this.powerUpMeshes[e];i||(i=new M(this.geoPowerUp,this.matPowerUp),this.scene.add(i),this.powerUpMeshes.push(i));const a=s.powerUps[e];i.position.set(a.gridPos.col,.3+.1*Math.sin(Date.now()*.003),a.gridPos.row),i.rotation.y+=.02}}frameCount=0;render(s){const e=performance.now();this.lastFrameTime>0&&(this.frameDeltaTime=Math.min((e-this.lastFrameTime)/1e3,.05)),this.lastFrameTime=e,this.weatherSystem.update(this.frameDeltaTime),this.themeManager.update(this.frameDeltaTime),this.frameCount++,this.frameCount%60===0&&console.log(`[SceneManager]  Frame ${this.frameCount}, Scene children: ${this.scene.children.length}, Current theme: ${this.currentTheme}`),this.renderer.render(this.scene,this.camera)}setWeather(s,e=.5){this.weatherSystem.setWeather(s,e)}setWeatherEnabled(s){this.weatherSystem.setEnabled(s)}setWeatherIntensity(s){this.weatherSystem.setIntensity(s)}setTheme(s){console.log(`[SceneManager]  setTheme() called: ${s}`),this.currentTheme=s,this.themeManager.loadTheme(s);const e=this.themeManager.getMaterials();console.log("[SceneManager]  Got theme materials:",e),console.log("[SceneManager]  Updating floor material..."),this.updateFloorMaterial(e.floor),console.log("[SceneManager]  Updating block materials..."),this.updateBlockMaterials(e.hardBlock,e.softBlock);const i=Ie.getWeatherForTheme(s);console.log(` Theme: ${s}  Weather: ${i}`),i!==he.NONE?(this.weatherSystem.setWeather(i,.6),console.log(` Weather activated: ${i}`)):(this.weatherSystem.setWeather(he.NONE),console.log(" No weather (sunny/clear)"))}updateFloorMaterial(s){console.log(`[SceneManager]  updateFloorMaterial() called. Current: ${this.matFloor.uuid}, New: ${s.uuid}`),this.matFloor!==s?(this.matFloor.dispose(),this.matFloor=s,this.floorMesh.material=this.matFloor,console.log("[SceneManager]  Floor material updated")):console.log("[SceneManager]  Floor material is the same reference, skipping update")}updateBlockMaterials(s,e){console.log("[SceneManager]  updateBlockMaterials() called"),this.matHard.dispose(),this.matSoft.dispose(),this.matHard=s,this.matSoft=e,this.hardBlockPool.material=this.matHard,this.softBlockPool.material=this.matSoft,console.log("[SceneManager]  Block materials updated on instanced meshes")}getCurrentTheme(){return this.currentTheme}dispose(){this.weatherSystem.dispose(),this.themeManager.dispose();for(const s of this.astronautCharacters)s.dispose(),this.scene.remove(s.root);this.astronautCharacters=[],this.renderer.dispose(),this.matFloor.dispose(),this.matHard.dispose(),this.matSoft.dispose(),this.matBomb.dispose(),this.matBombPrimed.dispose(),this.matBombRushed.dispose(),this.matExplosion.dispose(),this.matPowerUp.dispose(),this.geoBlock.dispose(),this.geoBomb.dispose(),this.geoExplosion.dispose(),this.geoPowerUp.dispose(),this.renderer.domElement.remove()}static showWebGLError(){const s=document.createElement("div");s.style.cssText=`
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(20, 20, 20, 0.95);
      color: #ff4444;
      padding: 30px;
      border-radius: 12px;
      font-family: Arial, sans-serif;
      max-width: 500px;
      text-align: center;
      z-index: 10000;
      border: 2px solid #ff4444;
    `,s.innerHTML=`
      <h2 style="margin: 0 0 15px 0; color: #ff6666;">WebGL Not Supported</h2>
      <p style="margin: 0 0 15px 0; line-height: 1.6;">
        This game requires WebGL to run, but your browser or device doesn't support it.
      </p>
      <p style="margin: 0; font-size: 14px; color: #aaa;">
        Try updating your browser or enabling hardware acceleration in settings.
      </p>
    `,document.body.appendChild(s)}}class pt{container;gameInfo;levelInfo=null;timerInfo=null;constructor(s="hud"){this.container=document.getElementById(s),this.gameInfo=document.getElementById("game-info"),this.createHUDElements()}createHUDElements(){this.levelInfo=document.createElement("div"),this.levelInfo.id="level-info",this.levelInfo.style.cssText=`
      position: absolute;
      top: 8px;
      left: 12px;
      font-size: 14px;
      opacity: 0.8;
      color: #e94560;
      font-weight: 600;
    `,this.container.appendChild(this.levelInfo),this.timerInfo=document.createElement("div"),this.timerInfo.id="timer-info",this.timerInfo.style.cssText=`
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 18px;
      font-weight: bold;
      opacity: 0.9;
      color: #fff;
      font-variant-numeric: tabular-nums;
    `,this.container.appendChild(this.timerInfo)}update(s,e){const i=s.players[0];if(i){if(this.gameInfo&&(i.alive?this.gameInfo.innerHTML=`
          <span style="color: #e94560;">BOMBS:</span> ${i.maxBombs-i.activeBombs}/${i.maxBombs} &nbsp;
          <span style="color: #e94560;">RANGE:</span> ${i.bombRange} &nbsp;
          <span style="color: #e94560;">FUSE:</span> ${i.fuseCharges} &nbsp;
          <span style="color: #e94560;">SPD:</span> ${i.speed.toFixed(1)}
        `:this.gameInfo.innerHTML='<span style="color: #ef4444; font-weight: bold;"> ELIMINATED</span>'),this.levelInfo&&e){const a=this.getLevelName(e.currentLevel);this.levelInfo.textContent=`LEVEL ${e.currentLevel}: ${a}`}if(this.timerInfo&&e){const a=this.getElapsedTime(e);this.timerInfo.textContent=this.formatTime(a),e.phase===T.PAUSED?this.timerInfo.style.color="#fbbf24":this.timerInfo.style.color="#fff"}if(e){const a=e.phase===T.PLAYING||e.phase===T.PAUSED;this.levelInfo.style.display=a?"block":"none",this.timerInfo.style.display=a?"block":"none",this.gameInfo.style.display=a?"block":"none"}}}getLevelName(s){return{1:"Training Grounds",2:"Ice Caverns",3:"Volcano Core",4:"Enchanted Forest",5:"Desert Ruins",6:"Space Station"}[s]||"Unknown"}getElapsedTime(s){return s.phase===T.PAUSED&&s.pausedAt?Math.floor((s.pausedAt-s.levelStartTime-s.totalPauseTime)/1e3):Math.floor((Date.now()-s.levelStartTime-s.totalPauseTime)/1e3)}formatTime(s){const e=Math.floor(s/60),i=s%60;return`${e.toString().padStart(2,"0")}:${i.toString().padStart(2,"0")}`}showMessage(s,e=3e3){const i=document.createElement("div");i.textContent=s,i.style.cssText=`
      position: absolute;
      top: 30%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(233, 69, 96, 0.9);
      color: white;
      padding: 16px 32px;
      border-radius: 8px;
      font-size: 1.2rem;
      font-weight: bold;
      z-index: 100;
      animation: fadeInOut ${e}ms ease-in-out;
    `,this.container.appendChild(i),setTimeout(()=>i.remove(),e)}}class gt{constructor(s,e){this.onUpdate=s,this.onRender=e}accumulator=0;tick=0;lastTime=0;rafId=0;running=!1;frameCount=0;fpsAccum=0;fps=0;start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.rafId=requestAnimationFrame(s=>this.loop(s)))}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}loop(s){if(!this.running)return;const e=Math.min((s-this.lastTime)/1e3,.25);for(this.lastTime=s,this.accumulator+=e,this.fpsAccum+=e,this.frameCount++,this.fpsAccum>=1&&(this.fps=this.frameCount,this.frameCount=0,this.fpsAccum-=1);this.accumulator>=te;)this.onUpdate(te,this.tick),this.tick++,this.accumulator-=te;const i=this.accumulator/te;this.onRender(i),this.rafId=requestAnimationFrame(a=>this.loop(a))}getTick(){return this.tick}getSimRate(){return He}}function _t(c,s){return s.col<0||s.col>=b||s.row<0||s.row>=b?!1:c[s.row][s.col]===I.Floor}function Ee(c){return{col:Math.round(c.x),row:Math.round(c.y)}}function vt(c){switch(c){case E.Up:return{x:0,y:-1};case E.Down:return{x:0,y:1};case E.Left:return{x:-1,y:0};case E.Right:return{x:1,y:0};default:return{x:0,y:0}}}function bt(c,s,e){const i=c.players[s];if(!i||!i.alive||i.moveDir===E.None)return;const a=vt(i.moveDir),r=i.worldPos.x+a.x*i.speed*e,u=i.worldPos.y+a.y*i.speed*e,m=Ee({x:r,y:u}),h=i.gridPos;m.col!==h.col||(m.row,h.row),_t(c.grid,m)&&(yt(c,m,s)||(i.worldPos.x=r,i.worldPos.y=u,i.gridPos=Ee(i.worldPos)))}function yt(c,s,e){return c.bombs.some(i=>i.gridPos.col===s.col&&i.gridPos.row===s.row&&i.ownerId!==e)}let wt=1;const Mt=3,xt=5,St=1.5;function At(c,s){const e=c.players[s];if(!e||!e.alive||e.activeBombs>=e.maxBombs||c.bombs.some(a=>a.gridPos.col===e.gridPos.col&&a.gridPos.row===e.gridPos.row))return!1;const i={id:wt++,gridPos:{...e.gridPos},ownerId:s,fuseRemaining:Mt,range:e.bombRange,primed:!1,rushed:!1};return c.bombs.push(i),e.activeBombs++,!0}function Tt(c,s){const e=[];for(let i=c.bombs.length-1;i>=0;i--)if(c.bombs[i].fuseRemaining-=s,c.bombs[i].fuseRemaining<=0){e.push({...c.bombs[i].gridPos});const a=c.players[c.bombs[i].ownerId];a&&a.activeBombs--,c.bombs.splice(i,1)}return e}function kt(c,s){const e=c.players[s];if(!e||e.fuseCharges<=0)return!1;const i=c.bombs.find(a=>a.ownerId===s&&!a.primed);return i?(i.fuseRemaining=xt,i.primed=!0,e.fuseCharges--,!0):!1}function Pt(c,s){const e=c.players[s];if(!e||e.fuseCharges<=0)return!1;const i=c.bombs.find(a=>a.ownerId===s&&!a.rushed);return i?(i.fuseRemaining=Math.min(i.fuseRemaining,St),i.rushed=!0,e.fuseCharges--,!0):!1}function It(c,s){const e=c.players[s];if(!e||e.fuseCharges<=0)return null;const i=c.bombs.findIndex(u=>u.ownerId===s);if(i===-1)return null;const r={...c.bombs[i].gridPos};return c.bombs.splice(i,1),e.activeBombs--,e.fuseCharges--,r}const Et=.5;function Le(c,s,e){const i=[{pos:s,range:e}];for(;i.length>0;){const a=i.shift(),r=Lt(c,a.pos,a.range);for(const u of r){c.grid[u.row][u.col]===I.SoftBlock&&(c.grid[u.row][u.col]=I.Floor,Ct(c,u)),c.explosions.push({gridPos:u,remaining:Et});for(const m of c.players)m.alive&&m.gridPos.col===u.col&&m.gridPos.row===u.row&&(m.alive=!1);for(let m=c.bombs.length-1;m>=0;m--){const h=c.bombs[m];if(h.gridPos.col===u.col&&h.gridPos.row===u.row){c.bombs.splice(m,1);const f=c.players[h.ownerId];f&&f.activeBombs>0&&f.activeBombs--,i.push({pos:h.gridPos,range:h.range})}}}}}function Lt(c,s,e){const i=[{...s}],a=[{dc:0,dr:-1},{dc:0,dr:1},{dc:-1,dr:0},{dc:1,dr:0}];for(const{dc:r,dr:u}of a)for(let m=1;m<=e;m++){const h=s.col+r*m,f=s.row+u*m;if(h<0||h>=b||f<0||f>=b||c.grid[f][h]===I.HardBlock||(i.push({col:h,row:f}),c.grid[f][h]===I.SoftBlock))break}return i}function Bt(c,s){for(let e=c.explosions.length-1;e>=0;e--)c.explosions[e].remaining-=s,c.explosions[e].remaining<=0&&c.explosions.splice(e,1)}function Ct(c,s){if(Math.random()>.3)return;const e=[H.BombRange,H.BombCount,H.Speed,H.FuseCharge],i=e[Math.floor(Math.random()*e.length)];c.powerUps.push({gridPos:{...s},type:i})}function Dt(c){let s=!1;for(const e of c.players)if(e.alive)for(let i=c.powerUps.length-1;i>=0;i--){const a=c.powerUps[i];a.gridPos.col===e.gridPos.col&&a.gridPos.row===e.gridPos.row&&(Gt(c,e.id,a.type),c.powerUps.splice(i,1),s=!0)}return s}function Gt(c,s,e){const i=c.players[s];if(i)switch(e){case H.BombRange:i.bombRange=Math.min(i.bombRange+1,8);break;case H.BombCount:i.maxBombs=Math.min(i.maxBombs+1,8);break;case H.Speed:i.speed=Math.min(i.speed+.5,6);break;case H.FuseCharge:i.fuseCharges=Math.min(i.fuseCharges+1,5);break}}class Ft{state;input;scene;audio;menuManager;hud;gameLoop;sessionBombsPlaced=0;sessionPowerUpsCollected=0;_sessionEnemiesDefeated=0;fpsEl;previousEnemyCount=0;playerWasAlive=!0;audioInitialized=!1;constructor(){this.input=new ut,this.scene=new ge,this.audio=$,this.hud=new pt;const s=x.getSettings();this.audio.setMusicVolume(s.musicVolume),this.audio.setSfxVolume(s.sfxVolume),this.audio.setUiVolume(s.uiVolume),this.state=this.createInitialExtendedState(),this.menuManager=new ct(e=>this.startGame(e),()=>this.resumeGame(),()=>this.quitToMenu()),this.fpsEl=document.getElementById("fps-counter"),this.fpsEl.style.display=s.showFPS?"block":"none",this.input.setPauseCallback(()=>this.togglePause()),this.gameLoop=new gt((e,i)=>this.update(e,i),e=>this.render(e)),this.setupAudioInitialization(),this.menuManager.showScreen(P.MAIN)}setupAudioInitialization(){const s=()=>{this.audioInitialized||(this.audio.initialize(),this.audioInitialized=!0,this.audio.playMenuMusic(),console.log("[GameController] Audio initialized"))};["click","touchstart","keydown"].forEach(i=>{document.addEventListener(i,s,{once:!0})})}createInitialExtendedState(){return{base:Oe(),phase:T.MENU,currentLevel:1,levelStartTime:0,totalPauseTime:0,pausedAt:null,session:{bombsPlaced:0,powerUpsCollected:0,enemiesDefeated:0,startTime:Date.now()},settings:x.getSettings(),stats:x.getStats()}}start(){this.gameLoop.start()}startGame(s){console.log(`[GameController] Starting game with levelId: ${s}`),x.incrementGamesStarted(),this.audioInitialized||(this.audio.initialize(),this.audioInitialized=!0,console.log("[GameController] Audio initialized")),se.setLevel(s-1),this.state.currentLevel=s,console.log(`[GameController] Current level set to: ${this.state.currentLevel}`);const e=se.getCurrentLevel();this.state.base=se.createLevelState(e);const i=this.state.base.enemies||[];this.previousEnemyCount=i.filter(a=>a.alive).length,se.getThemeColors(e.theme),this.scene.setTheme(e.theme),this.scene.setWeatherEnabled(!0),this.sessionBombsPlaced=0,this.sessionPowerUpsCollected=0,this._sessionEnemiesDefeated=0,this.previousEnemyCount=0,this.playerWasAlive=!0,this.state.levelStartTime=Date.now(),this.state.totalPauseTime=0,this.state.pausedAt=null,this.applySettings(),this.audio.playLevelMusic(s),this.state.phase=T.PLAYING,this.menuManager.hide(),console.log(`Starting Level ${s}: ${e.name}`)}resumeGame(){this.state.phase===T.PAUSED&&(this.state.pausedAt&&(this.state.totalPauseTime+=Date.now()-this.state.pausedAt),this.state.pausedAt=null,this.state.phase=T.PLAYING,this.menuManager.hide())}quitToMenu(){const s=Math.floor((Date.now()-this.state.session.startTime)/1e3);x.addPlayTime(s),this.audio.stopMusic(),this.audio.playMenuMusic(),this.state.phase=T.MENU,this.menuManager.showScreen(P.MAIN)}togglePause(){this.state.phase===T.PLAYING?(this.state.phase=T.PAUSED,this.state.pausedAt=Date.now(),this.menuManager.showPauseMenu()):this.state.phase===T.PAUSED&&this.resumeGame()}update(s,e){this.state.base.tick=e;const i=this.input.poll();switch(this.state.phase){case T.PLAYING:this.updatePlaying(s,i);break;case T.PAUSED:break;case T.VICTORY:case T.DEFEAT:break;case T.MENU:break}this.hud.update(this.state.base,this.state)}updatePlaying(s,e){const i=this.state.base.players[0];if(this.playerWasAlive&&i&&!i.alive&&this.audio.playPlayerDamage(),this.playerWasAlive=i?.alive??!1,i?.alive){if(e.moveDir!==E.None&&(i.moveDir=e.moveDir,bt(this.state.base,0,s)),e.placeBomb&&At(this.state.base,0)&&(this.audio.playBombPlace(),this.audio.playFuseTick(),this.sessionBombsPlaced++,x.incrementBombsPlaced()),e.fuseAction==="prime")kt(this.state.base,0);else if(e.fuseAction==="rush")Pt(this.state.base,0);else if(e.fuseAction==="detonate"){const u=It(this.state.base,0);u&&(Le(this.state.base,u,i.bombRange),this.audio.playExplosion())}}const a=Tt(this.state.base,s);for(const u of a)Le(this.state.base,u,this.state.base.players[0]?.bombRange??2),console.log("[GameController] Bomb exploded, playing sound"),this.audio.playExplosion();Bt(this.state.base,s),Dt(this.state.base)&&(this.audio.playPowerUp(),this.sessionPowerUpsCollected++,x.incrementPowerUpsCollected(),x.vibrate(50)),this.trackEnemyDeaths(),this.checkGameEndConditions()}trackEnemyDeaths(){const e=(this.state.base.enemies||[]).filter(i=>i.alive);if(e.length<this.previousEnemyCount){const i=this.previousEnemyCount-e.length;for(let a=0;a<i;a++)this.audio.playEnemyDeath(),this._sessionEnemiesDefeated++,x.incrementEnemiesDefeated()}this.previousEnemyCount=e.length}checkGameEndConditions(){if(!this.state.base.players[0]?.alive){this.handleDefeat();return}const e=this.state.base.enemies||[];if(e.filter(a=>a.alive).length===0&&e.length>0){this.handleVictory();return}}handleVictory(){this.state.phase=T.VICTORY;const s=Math.floor((Date.now()-this.state.levelStartTime-this.state.totalPauseTime)/1e3);x.recordWin(this.state.currentLevel,s),x.vibrate([100,50,100]),this.audio.stopMusic(),this.audio.playVictory(),this.menuManager.showGameOver(!0,{time:s,bombs:this.sessionBombsPlaced,powerUps:this.sessionPowerUpsCollected}),console.log(`Victory! Level ${this.state.currentLevel} completed in ${s}s`)}handleDefeat(){this.state.phase=T.DEFEAT,x.recordLoss(),x.vibrate([200,100,200]),this.audio.stopMusic(),this.audio.playDefeat();const s=Math.floor((Date.now()-this.state.levelStartTime-this.state.totalPauseTime)/1e3);this.menuManager.showGameOver(!1,{time:s,bombs:this.sessionBombsPlaced,powerUps:this.sessionPowerUpsCollected}),console.log(`Defeat! Level ${this.state.currentLevel} failed after ${s}s`)}render(s){this.scene.syncState(this.state.base,s),this.scene.render(),this.state.settings.showFPS&&(this.fpsEl.textContent=`${this.gameLoop.fps} FPS`)}applySettings(){const s=x.getSettings();this.audio.setMusicVolume(s.musicVolume),this.audio.setSfxVolume(s.sfxVolume),this.audio.setUiVolume(s.uiVolume),this.fpsEl.style.display=s.showFPS?"block":"none",s.fullscreen&&!document.fullscreenElement?document.documentElement.requestFullscreen?.().catch(()=>{}):!s.fullscreen&&document.fullscreenElement&&document.exitFullscreen?.().catch(()=>{})}getState(){return this.state}getPhase(){return this.state.phase}}console.log(" BLASTFORGE Initializing...");console.log(" GameController with menus, themes, audio");console.log(" Miami Beach & Ice World themes");console.log(" Weather system (rain, snow, ash)");console.log(" ElevenLabs audio integration ready");console.log(" Touch controls for mobile");function Be(){console.log(" init() called");try{const c=new Ft;console.log(" Game initialized successfully!"),c.start(),console.log(" Game loop started!"),window.game=c,window.audio=c.audio,setTimeout(()=>{const s=document.getElementById("game-menus");console.log("Menu element:",s),s&&(console.log("Menu children:",s.childNodes.length),console.log("Menu classes:",s.className))},1e3)}catch(c){console.error(" Failed to initialize game:",c),document.body.innerHTML=`
      <div style="color: white; padding: 20px; font-family: sans-serif; background: #0a0a1a; min-height: 100vh;">
        <h1>Error Loading Game</h1>
        <p>${c instanceof Error?c.message:"Unknown error"}</p>
        <pre style="background: #1a1a2e; padding: 10px; overflow: auto;">${c instanceof Error?c.stack:""}</pre>
      </div>
    `}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Be):Be();
