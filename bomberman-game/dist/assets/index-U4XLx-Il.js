import{M as m,B as b,S as U,O as R,a as E,C as G,P as A,W as C,b as I,A as L,D,c as F,d as w,I as B}from"./three-D6A4gSIQ.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))e(i);new MutationObserver(i=>{for(const r of i)if(r.type==="childList")for(const a of r.addedNodes)a.tagName==="LINK"&&a.rel==="modulepreload"&&e(a)}).observe(document,{childList:!0,subtree:!0});function o(i){const r={};return i.integrity&&(r.integrity=i.integrity),i.referrerPolicy&&(r.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?r.credentials="include":i.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function e(i){if(i.ep)return;i.ep=!0;const r=o(i);fetch(i.href,r)}})();const n=16,g=1,v=60,y=1/v;var d=(t=>(t[t.Floor=0]="Floor",t[t.HardBlock=1]="HardBlock",t[t.SoftBlock=2]="SoftBlock",t))(d||{}),c=(t=>(t[t.None=0]="None",t[t.Up=1]="Up",t[t.Down=2]="Down",t[t.Left=3]="Left",t[t.Right=4]="Right",t))(c||{}),u=(t=>(t.BombRange="bomb_range",t.BombCount="bomb_count",t.Speed="speed",t.FuseCharge="fuse_charge",t))(u||{});class ${constructor(s,o){this.onUpdate=s,this.onRender=o}accumulator=0;tick=0;lastTime=0;rafId=0;running=!1;frameCount=0;fpsAccum=0;fps=0;start(){this.running||(this.running=!0,this.lastTime=performance.now(),this.rafId=requestAnimationFrame(s=>this.loop(s)))}stop(){this.running=!1,cancelAnimationFrame(this.rafId)}loop(s){if(!this.running)return;const o=Math.min((s-this.lastTime)/1e3,.25);for(this.lastTime=s,this.accumulator+=o,this.fpsAccum+=o,this.frameCount++,this.fpsAccum>=1&&(this.fps=this.frameCount,this.frameCount=0,this.fpsAccum-=1);this.accumulator>=y;)this.onUpdate(y,this.tick),this.tick++,this.accumulator-=y;const e=this.accumulator/y;this.onRender(e),this.rafId=requestAnimationFrame(i=>this.loop(i))}getTick(){return this.tick}getSimRate(){return v}}function O(){const t=_(),s=[H(0,{col:1,row:1})];return{tick:0,grid:t,players:s,bombs:[],explosions:[],powerUps:[]}}function _(){const t=[];for(let o=0;o<n;o++){t[o]=[];for(let e=0;e<n;e++)o===0||o===n-1||e===0||e===n-1||o%2===0&&e%2===0?t[o][e]=d.HardBlock:t[o][e]=d.Floor}const s=new Set(["1,1","1,2","2,1",`${n-2},${n-2}`,`${n-2},${n-3}`,`${n-3},${n-2}`,`1,${n-2}`,`1,${n-3}`,`2,${n-2}`,`${n-2},1`,`${n-3},1`,`${n-2},2`]);for(let o=1;o<n-1;o++)for(let e=1;e<n-1;e++)t[o][e]===d.Floor&&!s.has(`${e},${o}`)&&Math.random()<.4&&(t[o][e]=d.SoftBlock);return t}function H(t,s){return{id:t,gridPos:{...s},worldPos:{x:s.col,y:s.row},moveDir:c.None,speed:3.5,bombRange:2,maxBombs:1,activeBombs:0,fuseCharges:3,alive:!0}}class N{keys=new Set;justPressed=new Set;gamepadIndex=null;constructor(){window.addEventListener("keydown",s=>{this.keys.has(s.code)||this.justPressed.add(s.code),this.keys.add(s.code)}),window.addEventListener("keyup",s=>{this.keys.delete(s.code)}),window.addEventListener("gamepadconnected",s=>{this.gamepadIndex=s.gamepad.index}),window.addEventListener("gamepaddisconnected",()=>{this.gamepadIndex=null})}poll(){const s={moveDir:this.getMoveDirection(),placeBomb:this.justPressed.has("Space"),fuseAction:this.getFuseAction()};if(this.gamepadIndex!==null){const o=navigator.getGamepads()[this.gamepadIndex];if(o){const[e,i]=[o.axes[0],o.axes[1]],r=.3;s.moveDir===c.None&&(i<-r?s.moveDir=c.Up:i>r?s.moveDir=c.Down:e<-r?s.moveDir=c.Left:e>r&&(s.moveDir=c.Right)),o.buttons[0]?.pressed&&(s.placeBomb=!0),o.buttons[2]?.pressed&&(s.fuseAction="prime"),o.buttons[1]?.pressed&&(s.fuseAction="rush"),o.buttons[3]?.pressed&&(s.fuseAction="detonate")}}return this.justPressed.clear(),s}getMoveDirection(){return this.keys.has("KeyW")||this.keys.has("ArrowUp")?c.Up:this.keys.has("KeyS")||this.keys.has("ArrowDown")?c.Down:this.keys.has("KeyA")||this.keys.has("ArrowLeft")?c.Left:this.keys.has("KeyD")||this.keys.has("ArrowRight")?c.Right:c.None}getFuseAction(){return this.justPressed.has("KeyQ")?"prime":this.justPressed.has("KeyE")?"rush":this.justPressed.has("KeyR")?"detonate":null}}class j{scene;camera;renderer;floorMesh;hardBlockPool;softBlockPool;playerMeshes=[];bombMeshes=new Map;explosionMeshes=[];powerUpMeshes=[];matFloor=new m({color:2763306});matHard=new m({color:5592405});matSoft=new m({color:9136404});matPlayer=new m({color:43775});matBomb=new m({color:1118481});matBombPrimed=new m({color:3359999,emissive:1122986});matBombRushed=new m({color:16720418,emissive:11145489});matExplosion=new m({color:16737792,emissive:16729088,transparent:!0,opacity:.85});matPowerUp=new m({color:4521796,emissive:2271778});geoBlock=new b(g*.95,g*.95,g*.95);geoPlayer=new b(.7,.9,.7);geoBomb=new U(.35,16,16);geoExplosion=new b(g*.9,.3,g*.9);geoPowerUp=new b(.4,.4,.4);dummy=new R;constructor(){this.scene=new E,this.scene.background=new G(657930);const s=(n-1)/2;this.camera=new A(50,window.innerWidth/window.innerHeight,.1,100),this.camera.position.set(s,18,s+12),this.camera.lookAt(s,0,s),this.renderer=new C({antialias:!0}),this.renderer.setPixelRatio(Math.min(window.devicePixelRatio,2)),this.renderer.setSize(window.innerWidth,window.innerHeight),this.renderer.shadowMap.enabled=!0,this.renderer.shadowMap.type=I,document.body.appendChild(this.renderer.domElement);const o=new L(16777215,.4);this.scene.add(o);const e=new D(16777215,.8);e.position.set(s+5,15,s-5),e.castShadow=!0,e.shadow.mapSize.set(1024,1024),e.shadow.camera.near=1,e.shadow.camera.far=40;const i=n;e.shadow.camera.left=-i,e.shadow.camera.right=i,e.shadow.camera.top=i,e.shadow.camera.bottom=-i,this.scene.add(e);const r=new F(n,n);this.floorMesh=new w(r,this.matFloor),this.floorMesh.rotation.x=-Math.PI/2,this.floorMesh.position.set(s,-.01,s),this.floorMesh.receiveShadow=!0,this.scene.add(this.floorMesh);const a=n*n;this.hardBlockPool=new B(this.geoBlock,this.matHard,a),this.hardBlockPool.castShadow=!0,this.hardBlockPool.receiveShadow=!0,this.scene.add(this.hardBlockPool),this.softBlockPool=new B(this.geoBlock,this.matSoft,a),this.softBlockPool.castShadow=!0,this.softBlockPool.receiveShadow=!0,this.scene.add(this.softBlockPool),window.addEventListener("resize",()=>{this.camera.aspect=window.innerWidth/window.innerHeight,this.camera.updateProjectionMatrix(),this.renderer.setSize(window.innerWidth,window.innerHeight)})}syncState(s,o){let e=0,i=0;for(let r=0;r<n;r++)for(let a=0;a<n;a++){const h=s.grid[r][a];h===d.HardBlock?(this.dummy.position.set(a,.475,r),this.dummy.updateMatrix(),this.hardBlockPool.setMatrixAt(e++,this.dummy.matrix)):h===d.SoftBlock&&(this.dummy.position.set(a,.475,r),this.dummy.updateMatrix(),this.softBlockPool.setMatrixAt(i++,this.dummy.matrix))}this.hardBlockPool.count=e,this.hardBlockPool.instanceMatrix.needsUpdate=!0,this.softBlockPool.count=i,this.softBlockPool.instanceMatrix.needsUpdate=!0,this.syncPlayers(s),this.syncBombs(s),this.syncExplosions(s),this.syncPowerUps(s)}syncPlayers(s){for(;this.playerMeshes.length<s.players.length;){const o=new w(this.geoPlayer,this.matPlayer);o.castShadow=!0,this.scene.add(o),this.playerMeshes.push(o)}for(let o=0;o<this.playerMeshes.length;o++){const e=this.playerMeshes[o];o<s.players.length&&s.players[o].alive?(e.visible=!0,e.position.set(s.players[o].worldPos.x,.45,s.players[o].worldPos.y)):e.visible=!1}}syncBombs(s){const o=new Set(s.bombs.map(e=>e.id));for(const[e,i]of this.bombMeshes)o.has(e)||(this.scene.remove(i),this.bombMeshes.delete(e));for(const e of s.bombs){let i=this.bombMeshes.get(e.id);if(!i){const a=e.primed?this.matBombPrimed:e.rushed?this.matBombRushed:this.matBomb;i=new w(this.geoBomb,a),i.castShadow=!0,this.scene.add(i),this.bombMeshes.set(e.id,i)}i.position.set(e.gridPos.col,.35,e.gridPos.row);const r=1+.05*Math.sin(Date.now()*.01*(e.rushed?4:e.primed?1:2));i.scale.setScalar(r)}}syncExplosions(s){for(;this.explosionMeshes.length>s.explosions.length;){const o=this.explosionMeshes.pop();this.scene.remove(o)}for(let o=0;o<s.explosions.length;o++){let e=this.explosionMeshes[o];e||(e=new w(this.geoExplosion,this.matExplosion.clone()),e.castShadow=!1,this.scene.add(e),this.explosionMeshes.push(e));const i=s.explosions[o];e.position.set(i.gridPos.col,.15,i.gridPos.row),e.material.opacity=Math.min(1,i.remaining*2)}}syncPowerUps(s){for(;this.powerUpMeshes.length>s.powerUps.length;){const o=this.powerUpMeshes.pop();this.scene.remove(o)}for(let o=0;o<s.powerUps.length;o++){let e=this.powerUpMeshes[o];e||(e=new w(this.geoPowerUp,this.matPowerUp),this.scene.add(e),this.powerUpMeshes.push(e));const i=s.powerUps[o];e.position.set(i.gridPos.col,.3+.1*Math.sin(Date.now()*.003),i.gridPos.row),e.rotation.y+=.02}}render(){this.renderer.render(this.scene,this.camera)}}class W{ctx=null;masterGain;musicGain;sfxGain;uiGain;constructor(){}ensureContext(){return this.ctx||(this.ctx=new AudioContext,this.masterGain=this.ctx.createGain(),this.musicGain=this.ctx.createGain(),this.sfxGain=this.ctx.createGain(),this.uiGain=this.ctx.createGain(),this.musicGain.connect(this.masterGain),this.sfxGain.connect(this.masterGain),this.uiGain.connect(this.masterGain),this.masterGain.connect(this.ctx.destination)),this.ctx.state==="suspended"&&this.ctx.resume(),this.ctx}setMusicVolume(s){this.ensureContext(),this.musicGain.gain.value=s}setSfxVolume(s){this.ensureContext(),this.sfxGain.gain.value=s}setUiVolume(s){this.ensureContext(),this.uiGain.gain.value=s}playSfx(s=440,o=.1){const e=this.ensureContext(),i=e.createOscillator();i.frequency.value=s,i.type="square",i.connect(this.sfxGain),i.start(),i.stop(e.currentTime+o)}playExplosion(){this.playSfx(80,.3)}playBombPlace(){this.playSfx(200,.05)}playPowerUp(){this.playSfx(880,.15)}}function K(t,s){return s.col<0||s.col>=n||s.row<0||s.row>=n?!1:t[s.row][s.col]===d.Floor}function M(t){return{col:Math.round(t.x),row:Math.round(t.y)}}function q(t){switch(t){case c.Up:return{x:0,y:-1};case c.Down:return{x:0,y:1};case c.Left:return{x:-1,y:0};case c.Right:return{x:1,y:0};default:return{x:0,y:0}}}function z(t,s,o){const e=t.players[s];if(!e||!e.alive||e.moveDir===c.None)return;const i=q(e.moveDir),r=e.worldPos.x+i.x*e.speed*o,a=e.worldPos.y+i.y*e.speed*o,h=M({x:r,y:a});K(t.grid,h)&&!V(t,h,e.id)&&(e.worldPos.x=r,e.worldPos.y=a,e.gridPos=M(e.worldPos))}function V(t,s,o){return t.bombs.some(e=>e.gridPos.col===s.col&&e.gridPos.row===s.row)}let T=1;const Z=3,Q=5,X=1.5;function J(t,s){const o=t.players[s];if(!o||!o.alive||o.activeBombs>=o.maxBombs||t.bombs.some(i=>i.gridPos.col===o.gridPos.col&&i.gridPos.row===o.gridPos.row))return!1;const e={id:T++,gridPos:{...o.gridPos},ownerId:s,fuseRemaining:Z,range:o.bombRange,primed:!1,rushed:!1};return t.bombs.push(e),o.activeBombs++,!0}function Y(t,s){const o=[];for(let e=t.bombs.length-1;e>=0;e--)if(t.bombs[e].fuseRemaining-=s,t.bombs[e].fuseRemaining<=0){o.push({...t.bombs[e].gridPos});const i=t.players[t.bombs[e].ownerId];i&&i.activeBombs--,t.bombs.splice(e,1)}return o}function ee(t,s){const o=t.players[s];if(!o||o.fuseCharges<=0)return!1;const e=t.bombs.find(i=>i.ownerId===s&&!i.primed);return e?(e.fuseRemaining=Q,e.primed=!0,o.fuseCharges--,!0):!1}function se(t,s){const o=t.players[s];if(!o||o.fuseCharges<=0)return!1;const e=t.bombs.find(i=>i.ownerId===s&&!i.rushed);return e?(e.fuseRemaining=Math.min(e.fuseRemaining,X),e.rushed=!0,o.fuseCharges--,!0):!1}function oe(t,s){const o=t.players[s];if(!o||o.fuseCharges<=0)return null;const e=t.bombs.findIndex(a=>a.ownerId===s);if(e===-1)return null;const r={...t.bombs[e].gridPos};return t.bombs.splice(e,1),o.activeBombs--,o.fuseCharges--,r}const te=.5;function P(t,s,o){const e=ie(t,s,o);for(const i of e){t.grid[i.row][i.col]===d.SoftBlock&&(t.grid[i.row][i.col]=d.Floor,ne(t,i)),t.explosions.push({gridPos:i,remaining:te});for(const r of t.players)r.alive&&r.gridPos.col===i.col&&r.gridPos.row===i.row&&(r.alive=!1);for(let r=t.bombs.length-1;r>=0;r--){const a=t.bombs[r];if(a.gridPos.col===i.col&&a.gridPos.row===i.row){t.bombs.splice(r,1);const h=t.players[a.ownerId];h&&h.activeBombs--,P(t,a.gridPos,a.range)}}}}function ie(t,s,o){const e=[{...s}],i=[{dc:0,dr:-1},{dc:0,dr:1},{dc:-1,dr:0},{dc:1,dr:0}];for(const{dc:r,dr:a}of i)for(let h=1;h<=o;h++){const f=s.col+r*h,p=s.row+a*h;if(f<0||f>=n||p<0||p>=n||t.grid[p][f]===d.HardBlock||(e.push({col:f,row:p}),t.grid[p][f]===d.SoftBlock))break}return e}function re(t,s){for(let o=t.explosions.length-1;o>=0;o--)t.explosions[o].remaining-=s,t.explosions[o].remaining<=0&&t.explosions.splice(o,1)}function ne(t,s){if(Math.random()>.3)return;const o=[u.BombRange,u.BombCount,u.Speed,u.FuseCharge],e=o[Math.floor(Math.random()*o.length)];t.powerUps.push({gridPos:{...s},type:e})}function ae(t){for(const s of t.players)if(s.alive)for(let o=t.powerUps.length-1;o>=0;o--){const e=t.powerUps[o];e.gridPos.col===s.gridPos.col&&e.gridPos.row===s.gridPos.row&&(ce(t,s.id,e.type),t.powerUps.splice(o,1))}}function ce(t,s,o){const e=t.players[s];if(e)switch(o){case u.BombRange:e.bombRange=Math.min(e.bombRange+1,8);break;case u.BombCount:e.maxBombs=Math.min(e.maxBombs+1,8);break;case u.Speed:e.speed=Math.min(e.speed+.5,6);break;case u.FuseCharge:e.fuseCharges=Math.min(e.fuseCharges+1,5);break}}const l=O(),le=new N,k=new j,x=new W,he=document.getElementById("fps-counter");function de(t,s){l.tick=s;const o=le.poll(),e=l.players[0];if(e?.alive){if(e.moveDir=o.moveDir,z(l,0,t),o.placeBomb&&J(l,0)&&x.playBombPlace(),o.fuseAction==="prime")ee(l,0);else if(o.fuseAction==="rush")se(l,0);else if(o.fuseAction==="detonate"){const r=oe(l,0);r&&(P(l,r,e.bombRange),x.playExplosion())}}const i=Y(l,t);for(const r of i)P(l,r,l.players[0]?.bombRange??2),x.playExplosion();re(l,t),ae(l)}function me(t){k.syncState(l,t),k.render(),he.textContent=`${S.fps} FPS`}const S=new $(de,me);S.start();
